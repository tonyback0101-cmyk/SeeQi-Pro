(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4164],{18889:function(t,e){var r,s,n=(r=new Date,s=4,{setLogLevel:function(t){t==this.debug?s=1:t==this.info?s=2:t==this.warn?s=3:(this.error,s=4)},debug:function(t,e){void 0===console.debug&&(console.debug=console.log),1>=s&&console.debug("["+n.getDurationString(new Date-r,1e3)+"]","["+t+"]",e)},log:function(t,e){this.debug(t.msg)},info:function(t,e){2>=s&&console.info("["+n.getDurationString(new Date-r,1e3)+"]","["+t+"]",e)},warn:function(t,e){3>=s&&console.warn("["+n.getDurationString(new Date-r,1e3)+"]","["+t+"]",e)},error:function(t,e){4>=s&&console.error("["+n.getDurationString(new Date-r,1e3)+"]","["+t+"]",e)}});n.getDurationString=function(t,e){function r(t,e){for(var r=(""+t).split(".");r[0].length<e;)r[0]="0"+r[0];return r.join(".")}t<0?(s=!0,t=-t):s=!1;var s,n=t/(e||1),a=Math.floor(n/3600),o=Math.floor((n-=3600*a)/60),h=1e3*(n-=60*o);return h-=1e3*(n=Math.floor(n)),h=Math.floor(h),(s?"-":"")+a+":"+r(o,2)+":"+r(n,2)+"."+r(h,3)},n.printRanges=function(t){var e=t.length;if(!(e>0))return"(empty)";for(var r="",s=0;s<e;s++)s>0&&(r+=","),r+="["+n.getDurationString(t.start(s))+","+n.getDurationString(t.end(s))+"]";return r},e.Log=n;var a=function(t){if(t instanceof ArrayBuffer)this.buffer=t,this.dataview=new DataView(t);else throw"Needs an array buffer";this.position=0};a.prototype.getPosition=function(){return this.position},a.prototype.getEndPosition=function(){return this.buffer.byteLength},a.prototype.getLength=function(){return this.buffer.byteLength},a.prototype.seek=function(t){var e=Math.max(0,Math.min(this.buffer.byteLength,t));return this.position=isNaN(e)||!isFinite(e)?0:e,!0},a.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()},a.prototype.readAnyInt=function(t,e){var r=0;if(this.position+t<=this.buffer.byteLength){switch(t){case 1:r=e?this.dataview.getInt8(this.position):this.dataview.getUint8(this.position);break;case 2:r=e?this.dataview.getInt16(this.position):this.dataview.getUint16(this.position);break;case 3:if(e)throw"No method for reading signed 24 bits values";r=this.dataview.getUint8(this.position)<<16|this.dataview.getUint8(this.position+1)<<8|this.dataview.getUint8(this.position+2);break;case 4:r=e?this.dataview.getInt32(this.position):this.dataview.getUint32(this.position);break;case 8:if(e)throw"No method for reading signed 64 bits values";r=this.dataview.getUint32(this.position)<<32|this.dataview.getUint32(this.position+4);break;default:throw"readInt method not implemented for size: "+t}return this.position+=t,r}throw"Not enough bytes in buffer"},a.prototype.readUint8=function(){return this.readAnyInt(1,!1)},a.prototype.readUint16=function(){return this.readAnyInt(2,!1)},a.prototype.readUint24=function(){return this.readAnyInt(3,!1)},a.prototype.readUint32=function(){return this.readAnyInt(4,!1)},a.prototype.readUint64=function(){return this.readAnyInt(8,!1)},a.prototype.readString=function(t){if(this.position+t<=this.buffer.byteLength){for(var e="",r=0;r<t;r++)e+=String.fromCharCode(this.readUint8());return e}throw"Not enough bytes in buffer"},a.prototype.readCString=function(){for(var t=[];;){var e=this.readUint8();if(0!==e)t.push(e);else break}return String.fromCharCode.apply(null,t)},a.prototype.readInt8=function(){return this.readAnyInt(1,!0)},a.prototype.readInt16=function(){return this.readAnyInt(2,!0)},a.prototype.readInt32=function(){return this.readAnyInt(4,!0)},a.prototype.readInt64=function(){return this.readAnyInt(8,!1)},a.prototype.readUint8Array=function(t){for(var e=new Uint8Array(t),r=0;r<t;r++)e[r]=this.readUint8();return e},a.prototype.readInt16Array=function(t){for(var e=new Int16Array(t),r=0;r<t;r++)e[r]=this.readInt16();return e},a.prototype.readUint16Array=function(t){for(var e=new Int16Array(t),r=0;r<t;r++)e[r]=this.readUint16();return e},a.prototype.readUint32Array=function(t){for(var e=new Uint32Array(t),r=0;r<t;r++)e[r]=this.readUint32();return e},a.prototype.readInt32Array=function(t){for(var e=new Int32Array(t),r=0;r<t;r++)e[r]=this.readInt32();return e},e.MP4BoxStream=a;var o=function(t,e,r){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:"object"==typeof t?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||0),this.position=0,this.endianness=null==r?o.LITTLE_ENDIAN:r};o.prototype={},o.prototype.getPosition=function(){return this.position},o.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,r=this._buffer.byteLength;if(e<=r){e>this._byteLength&&(this._byteLength=e);return}for(r<1&&(r=1);e>r;)r*=2;var s=new ArrayBuffer(r),n=new Uint8Array(this._buffer);new Uint8Array(s,0,n.length).set(n),this.buffer=s,this._byteLength=e}},o.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),r=new Uint8Array(this._buffer,0,e.length);e.set(r),this.buffer=t}},o.BIG_ENDIAN=!1,o.LITTLE_ENDIAN=!0,o.prototype._byteLength=0,Object.defineProperty(o.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(o.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(o.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(o.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),o.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e},o.prototype.isEof=function(){return this.position>=this._byteLength},o.prototype.mapUint8Array=function(t){this._realloc(1*t);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=1*t,e},o.prototype.readInt32Array=function(t,e){var r=new Int32Array(t=null==t?this.byteLength-this.position/4:t);return o.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),o.arrayToNative(r,null==e?this.endianness:e),this.position+=r.byteLength,r},o.prototype.readInt16Array=function(t,e){var r=new Int16Array(t=null==t?this.byteLength-this.position/2:t);return o.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),o.arrayToNative(r,null==e?this.endianness:e),this.position+=r.byteLength,r},o.prototype.readInt8Array=function(t){var e=new Int8Array(t=null==t?this.byteLength-this.position:t);return o.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},o.prototype.readUint32Array=function(t,e){var r=new Uint32Array(t=null==t?this.byteLength-this.position/4:t);return o.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),o.arrayToNative(r,null==e?this.endianness:e),this.position+=r.byteLength,r},o.prototype.readUint16Array=function(t,e){var r=new Uint16Array(t=null==t?this.byteLength-this.position/2:t);return o.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),o.arrayToNative(r,null==e?this.endianness:e),this.position+=r.byteLength,r},o.prototype.readUint8Array=function(t){var e=new Uint8Array(t=null==t?this.byteLength-this.position:t);return o.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},o.prototype.readFloat64Array=function(t,e){var r=new Float64Array(t=null==t?this.byteLength-this.position/8:t);return o.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),o.arrayToNative(r,null==e?this.endianness:e),this.position+=r.byteLength,r},o.prototype.readFloat32Array=function(t,e){var r=new Float32Array(t=null==t?this.byteLength-this.position/4:t);return o.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),o.arrayToNative(r,null==e?this.endianness:e),this.position+=r.byteLength,r},o.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,null==t?this.endianness:t);return this.position+=4,e},o.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,null==t?this.endianness:t);return this.position+=2,e},o.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},o.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,null==t?this.endianness:t);return this.position+=4,e},o.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,null==t?this.endianness:t);return this.position+=2,e},o.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},o.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,null==t?this.endianness:t);return this.position+=4,e},o.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,null==t?this.endianness:t);return this.position+=8,e},o.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,o.memcpy=function(t,e,r,s,n){var a=new Uint8Array(t,e,n),o=new Uint8Array(r,s,n);a.set(o)},o.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},o.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},o.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),r=0;r<t.byteLength;r+=t.BYTES_PER_ELEMENT)for(var s=r+t.BYTES_PER_ELEMENT-1,n=r;s>n;s--,n++){var a=e[n];e[n]=e[s],e[s]=a}return t},o.prototype.failurePosition=0,String.fromCharCodeUint8=function(t){for(var e=[],r=0;r<t.length;r++)e[r]=t[r];return String.fromCharCode.apply(null,e)},o.prototype.readString=function(t,e){return null==e||"ASCII"==e?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(null==t?this.byteLength-this.position:t)]):new TextDecoder(e).decode(this.mapUint8Array(t))},o.prototype.readCString=function(t){var e=this.byteLength-this.position,r=new Uint8Array(this._buffer,this._byteOffset+this.position),s=e;null!=t&&(s=Math.min(t,e));for(var n=0;n<s&&0!==r[n];n++);var a=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(n)]);return null!=t?this.position+=s-n:n!=e&&(this.position+=1),a},o.prototype.readInt64=function(){return 4294967296*this.readInt32()+this.readUint32()},o.prototype.readUint64=function(){return 4294967296*this.readUint32()+this.readUint32()},o.prototype.readInt64=function(){return 4294967296*this.readUint32()+this.readUint32()},o.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()},e.DataStream=o,o.prototype.save=function(t){var e=new Blob([this.buffer]);if(window.URL&&URL.createObjectURL){var r=window.URL.createObjectURL(e),s=document.createElement("a");document.body.appendChild(s),s.setAttribute("href",r),s.setAttribute("download",t),s.setAttribute("target","_self"),s.click(),window.URL.revokeObjectURL(r)}else throw"DataStream.save: Can't create object URL."},o.prototype._dynamicSize=!0,Object.defineProperty(o.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),o.prototype.shift=function(t){var e=new ArrayBuffer(this._byteLength-t),r=new Uint8Array(e),s=new Uint8Array(this._buffer,t,r.length);r.set(s),this.buffer=e,this.position-=t},o.prototype.writeInt32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeInt32(t[r],e)},o.prototype.writeInt16Array=function(t,e){if(this._realloc(2*t.length),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeInt16(t[r],e)},o.prototype.writeInt8Array=function(t){if(this._realloc(1*t.length),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},o.prototype.writeUint32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeUint32(t[r],e)},o.prototype.writeUint16Array=function(t,e){if(this._realloc(2*t.length),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeUint16(t[r],e)},o.prototype.writeUint8Array=function(t){if(this._realloc(1*t.length),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},o.prototype.writeFloat64Array=function(t,e){if(this._realloc(8*t.length),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeFloat64(t[r],e)},o.prototype.writeFloat32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeFloat32(t[r],e)},o.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,null==e?this.endianness:e),this.position+=4},o.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,null==e?this.endianness:e),this.position+=2},o.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},o.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,null==e?this.endianness:e),this.position+=4},o.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,null==e?this.endianness:e),this.position+=2},o.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},o.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,null==e?this.endianness:e),this.position+=4},o.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,null==e?this.endianness:e),this.position+=8},o.prototype.writeUCS2String=function(t,e,r){null==r&&(r=t.length);for(var s=0;s<t.length&&s<r;s++)this.writeUint16(t.charCodeAt(s),e);for(;s<r;s++)this.writeUint16(0)},o.prototype.writeString=function(t,e,r){var s=0;if(null==e||"ASCII"==e){if(null!=r){var n=Math.min(t.length,r);for(s=0;s<n;s++)this.writeUint8(t.charCodeAt(s));for(;s<r;s++)this.writeUint8(0)}else for(s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s))}else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,r)))},o.prototype.writeCString=function(t,e){var r=0;if(null!=e){var s=Math.min(t.length,e);for(r=0;r<s;r++)this.writeUint8(t.charCodeAt(r));for(;r<e;r++)this.writeUint8(0)}else{for(r=0;r<t.length;r++)this.writeUint8(t.charCodeAt(r));this.writeUint8(0)}},o.prototype.writeStruct=function(t,e){for(var r=0;r<t.length;r+=2){var s=t[r+1];this.writeType(s,e[t[r]],e)}},o.prototype.writeType=function(t,e,r){if("function"==typeof t)return t(this,e);if("object"==typeof t&&!(t instanceof Array))return t.set(this,e,r);var s,n=null,a="ASCII",h=this.position;switch("string"==typeof t&&/:/.test(t)&&(t=(s=t.split(":"))[0],n=parseInt(s[1])),"string"==typeof t&&/,/.test(t)&&(t=(s=t.split(","))[0],a=parseInt(s[1])),t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,o.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,o.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,o.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,o.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,o.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,o.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,o.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,o.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,o.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,o.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,o.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,o.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,n);break;case"string":this.writeString(e,a,n);break;case"u16string":this.writeUCS2String(e,this.endianness,n);break;case"u16stringle":this.writeUCS2String(e,o.LITTLE_ENDIAN,n);break;case"u16stringbe":this.writeUCS2String(e,o.BIG_ENDIAN,n);break;default:if(3==t.length){for(var d=t[1],p=0;p<e.length;p++)this.writeType(d,e[p]);break}this.writeStruct(t,e)}null!=n&&(this.position=h,this._realloc(n),this.position=h+n)},o.prototype.writeUint64=function(t){this.writeUint32(Math.floor(t/4294967296)),this.writeUint32(4294967295&t)},o.prototype.writeUint24=function(t){this.writeUint8((16711680&t)>>16),this.writeUint8((65280&t)>>8),this.writeUint8(255&t)},o.prototype.adjustUint32=function(t,e){var r=this.position;this.seek(t),this.writeUint32(e),this.seek(r)},o.prototype.mapInt32Array=function(t,e){this._realloc(4*t);var r=new Int32Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(r,null==e?this.endianness:e),this.position+=4*t,r},o.prototype.mapInt16Array=function(t,e){this._realloc(2*t);var r=new Int16Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(r,null==e?this.endianness:e),this.position+=2*t,r},o.prototype.mapInt8Array=function(t){this._realloc(1*t);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=1*t,e},o.prototype.mapUint32Array=function(t,e){this._realloc(4*t);var r=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(r,null==e?this.endianness:e),this.position+=4*t,r},o.prototype.mapUint16Array=function(t,e){this._realloc(2*t);var r=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(r,null==e?this.endianness:e),this.position+=2*t,r},o.prototype.mapFloat64Array=function(t,e){this._realloc(8*t);var r=new Float64Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(r,null==e?this.endianness:e),this.position+=8*t,r},o.prototype.mapFloat32Array=function(t,e){this._realloc(4*t);var r=new Float32Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(r,null==e?this.endianness:e),this.position+=4*t,r};var h=function(t){this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)};h.prototype=new o(new ArrayBuffer,0,o.BIG_ENDIAN),h.prototype.initialized=function(){var t;return this.bufferIndex>-1||(this.buffers.length>0?0===(t=this.buffers[0]).fileStart?(this.buffer=t,this.bufferIndex=0,n.debug("MultiBufferStream","Stream ready for parsing"),!0):(n.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1):(n.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1))},ArrayBuffer.concat=function(t,e){n.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));var r=new Uint8Array(t.byteLength+e.byteLength);return r.set(new Uint8Array(t),0),r.set(new Uint8Array(e),t.byteLength),r.buffer},h.prototype.reduceBuffer=function(t,e,r){var s;return(s=new Uint8Array(r)).set(new Uint8Array(t,e,r)),s.buffer.fileStart=t.fileStart+e,s.buffer.usedBytes=0,s.buffer},h.prototype.insertBuffer=function(t){for(var e=!0,r=0;r<this.buffers.length;r++){var s=this.buffers[r];if(t.fileStart<=s.fileStart){if(t.fileStart===s.fileStart){if(t.byteLength>s.byteLength){this.buffers.splice(r,1),r--;continue}n.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring")}else t.fileStart+t.byteLength<=s.fileStart||(t=this.reduceBuffer(t,0,s.fileStart-t.fileStart)),n.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(r,0,t),0===r&&(this.buffer=t);e=!1;break}if(t.fileStart<s.fileStart+s.byteLength){var a=s.fileStart+s.byteLength-t.fileStart,o=t.byteLength-a;if(o>0)t=this.reduceBuffer(t,a,o);else{e=!1;break}}}e&&(n.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),0===r&&(this.buffer=t))},h.prototype.logBufferLevel=function(t){var e,r,s,a,o,h=[],d="";for(e=0,s=0,a=0;e<this.buffers.length;e++)r=this.buffers[e],0===e?(h.push(o={}),o.start=r.fileStart,o.end=r.fileStart+r.byteLength,d+="["+o.start+"-"):o.end===r.fileStart?o.end=r.fileStart+r.byteLength:((o={}).start=r.fileStart,d+=h[h.length-1].end-1+"], ["+o.start+"-",o.end=r.fileStart+r.byteLength,h.push(o)),s+=r.usedBytes,a+=r.byteLength;h.length>0&&(d+=o.end-1+"]"),(t?n.info:n.debug)("MultiBufferStream",0===this.buffers.length?"No more buffer in memory":""+this.buffers.length+" stored buffer(s) ("+s+"/"+a+" bytes), continuous ranges: "+d)},h.prototype.cleanBuffers=function(){var t,e;for(t=0;t<this.buffers.length;t++)(e=this.buffers[t]).usedBytes===e.byteLength&&(n.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)},h.prototype.mergeNextBuffer=function(){if(!(this.bufferIndex+1<this.buffers.length)||(t=this.buffers[this.bufferIndex+1]).fileStart!==this.buffer.fileStart+this.buffer.byteLength)return!1;var t,e=this.buffer.byteLength,r=this.buffer.usedBytes,s=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=r,this.buffer.fileStart=s,n.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0},h.prototype.findPosition=function(t,e,r){var s,a=null,o=-1;for(s=!0===t?0:this.bufferIndex;s<this.buffers.length&&(a=this.buffers[s]).fileStart<=e;)o=s,r&&(a.fileStart+a.byteLength<=e?a.usedBytes=a.byteLength:a.usedBytes=e-a.fileStart,this.logBufferLevel()),s++;return -1===o?-1:(a=this.buffers[o]).fileStart+a.byteLength>=e?(n.debug("MultiBufferStream","Found position in existing buffer #"+o),o):-1},h.prototype.findEndContiguousBuf=function(t){var e,r,s,n=void 0!==t?t:this.bufferIndex;if(r=this.buffers[n],this.buffers.length>n+1)for(e=n+1;e<this.buffers.length;e++)if((s=this.buffers[e]).fileStart===r.fileStart+r.byteLength)r=s;else break;return r.fileStart+r.byteLength},h.prototype.getEndFilePositionAfter=function(t){var e=this.findPosition(!0,t,!1);return -1!==e?this.findEndContiguousBuf(e):t},h.prototype.addUsedBytes=function(t){this.buffer.usedBytes+=t,this.logBufferLevel()},h.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()},h.prototype.seek=function(t,e,r){var s;return -1!==(s=this.findPosition(e,t,r))?(this.buffer=this.buffers[s],this.bufferIndex=s,this.position=t-this.buffer.fileStart,n.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(n.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)},h.prototype.getPosition=function(){if(-1===this.bufferIndex||null===this.buffers[this.bufferIndex])throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position},h.prototype.getLength=function(){return this.byteLength},h.prototype.getEndPosition=function(){if(-1===this.bufferIndex||null===this.buffers[this.bufferIndex])throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength},e.MultiBufferStream=h;var d=function(){var t=[];t[3]="ES_Descriptor",t[4]="DecoderConfigDescriptor",t[5]="DecoderSpecificInfo",t[6]="SLConfigDescriptor",this.getDescriptorName=function(e){return t[e]};var e=this,r={};return this.parseOneDescriptor=function(e){var s,a,o,h=0,d=0;for(s=e.readUint8(),h++,o=e.readUint8(),h++;128&o;)d=(d<<7)+(127&o),o=e.readUint8(),h++;return d=(d<<7)+(127&o),n.debug("MPEG4DescriptorParser","Found "+(t[s]||"Descriptor "+s)+", size "+d+" at position "+e.getPosition()),(a=t[s]?new r[t[s]](d):new r.Descriptor(d)).parse(e),a},r.Descriptor=function(t,e){this.tag=t,this.size=e,this.descs=[]},r.Descriptor.prototype.parse=function(t){this.data=t.readUint8Array(this.size)},r.Descriptor.prototype.findDescriptor=function(t){for(var e=0;e<this.descs.length;e++)if(this.descs[e].tag==t)return this.descs[e];return null},r.Descriptor.prototype.parseRemainingDescriptors=function(t){for(var r=t.position;t.position<r+this.size;){var s=e.parseOneDescriptor(t);this.descs.push(s)}},r.ES_Descriptor=function(t){r.Descriptor.call(this,3,t)},r.ES_Descriptor.prototype=new r.Descriptor,r.ES_Descriptor.prototype.parse=function(t){if(this.ES_ID=t.readUint16(),this.flags=t.readUint8(),this.size-=3,128&this.flags?(this.dependsOn_ES_ID=t.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,64&this.flags){var e=t.readUint8();this.URL=t.readString(e),this.size-=e+1}else this.URL="";32&this.flags?(this.OCR_ES_ID=t.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(t)},r.ES_Descriptor.prototype.getOTI=function(t){var e=this.findDescriptor(4);return e?e.oti:0},r.ES_Descriptor.prototype.getAudioConfig=function(t){var e=this.findDescriptor(4);if(!e)return null;var r=e.findDescriptor(5);if(!r||!r.data)return null;var s=(248&r.data[0])>>3;return 31===s&&r.data.length>=2&&(s=32+((7&r.data[0])<<3)+((224&r.data[1])>>5)),s},r.DecoderConfigDescriptor=function(t){r.Descriptor.call(this,4,t)},r.DecoderConfigDescriptor.prototype=new r.Descriptor,r.DecoderConfigDescriptor.prototype.parse=function(t){this.oti=t.readUint8(),this.streamType=t.readUint8(),this.upStream=(this.streamType>>1&1)!=0,this.streamType=this.streamType>>>2,this.bufferSize=t.readUint24(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32(),this.size-=13,this.parseRemainingDescriptors(t)},r.DecoderSpecificInfo=function(t){r.Descriptor.call(this,5,t)},r.DecoderSpecificInfo.prototype=new r.Descriptor,r.SLConfigDescriptor=function(t){r.Descriptor.call(this,6,t)},r.SLConfigDescriptor.prototype=new r.Descriptor,this};e.MPEG4DescriptorParser=d;var p={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:[{type:"mdat",name:"MediaDataBox"},{type:"idat",name:"ItemDataBox"},{type:"free",name:"FreeSpaceBox"},{type:"skip",name:"FreeSpaceBox"},{type:"meco",name:"AdditionalMetadataContainerBox"},{type:"strk",name:"SubTrackBox"}],FULL_BOXES:[{type:"hmhd",name:"HintMediaHeaderBox"},{type:"nmhd",name:"NullMediaHeaderBox"},{type:"iods",name:"ObjectDescriptorBox"},{type:"xml ",name:"XMLBox"},{type:"bxml",name:"BinaryXMLBox"},{type:"ipro",name:"ItemProtectionBox"},{type:"mere",name:"MetaboxRelationBox"}],CONTAINER_BOXES:[[{type:"moov",name:"CompressedMovieBox"},["trak","pssh"]],[{type:"trak",name:"TrackBox"}],[{type:"edts",name:"EditBox"}],[{type:"mdia",name:"MediaBox"}],[{type:"minf",name:"MediaInformationBox"}],[{type:"dinf",name:"DataInformationBox"}],[{type:"stbl",name:"SampleTableBox"},["sgpd","sbgp"]],[{type:"mvex",name:"MovieExtendsBox"},["trex"]],[{type:"moof",name:"CompressedMovieFragmentBox"},["traf"]],[{type:"traf",name:"TrackFragmentBox"},["trun","sgpd","sbgp"]],[{type:"vttc",name:"VTTCueBox"}],[{type:"tref",name:"TrackReferenceBox"}],[{type:"iref",name:"ItemReferenceBox"}],[{type:"mfra",name:"MovieFragmentRandomAccessBox"},["tfra"]],[{type:"meco",name:"AdditionalMetadataContainerBox"}],[{type:"hnti",name:"trackhintinformation"}],[{type:"hinf",name:"hintstatisticsbox"}],[{type:"strk",name:"SubTrackBox"}],[{type:"strd",name:"SubTrackDefinitionBox"}],[{type:"sinf",name:"ProtectionSchemeInfoBox"}],[{type:"rinf",name:"RestrictedSchemeInfoBox"}],[{type:"schi",name:"SchemeInformationBox"}],[{type:"trgr",name:"TrackGroupBox"}],[{type:"udta",name:"UserDataBox"},["kind"]],[{type:"iprp",name:"ItemPropertiesBox"},["ipma"]],[{type:"ipco",name:"ItemPropertyContainerBox"}],[{type:"grpl",name:"GroupsListBox"}],[{type:"j2kH",name:"J2KHeaderInfoBox"}],[{type:"etyp",name:"ExtendedTypeBox"},["tyco"]]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){p.FullBox.prototype=new p.Box,p.ContainerBox.prototype=new p.Box,p.SampleEntry.prototype=new p.Box,p.TrackGroupTypeBox.prototype=new p.FullBox,p.BASIC_BOXES.forEach(function(t){p.createBoxCtor(t.type,t.name)}),p.FULL_BOXES.forEach(function(t){p.createFullBoxCtor(t.type,t.name)}),p.CONTAINER_BOXES.forEach(function(t){p.createContainerBoxCtor(t[0].type,t[0].name,null,t[1])})},Box:function(t,e,r,s){this.type=t,this.box_name=r,this.size=e,this.uuid=s},FullBox:function(t,e,r,s){p.Box.call(this,t,e,r,s),this.flags=0,this.version=0},ContainerBox:function(t,e,r,s){p.Box.call(this,t,e,r,s),this.boxes=[]},SampleEntry:function(t,e,r,s){p.ContainerBox.call(this,t,e),this.hdr_size=r,this.start=s},SampleGroupEntry:function(t){this.grouping_type=t},TrackGroupTypeBox:function(t,e){p.FullBox.call(this,t,e)},createBoxCtor:function(t,e,r){p.boxCodes.push(t),p[t+"Box"]=function(r){p.Box.call(this,t,r,e)},p[t+"Box"].prototype=new p.Box,r&&(p[t+"Box"].prototype.parse=r)},createFullBoxCtor:function(t,e,r){p[t+"Box"]=function(r){p.FullBox.call(this,t,r,e)},p[t+"Box"].prototype=new p.FullBox,p[t+"Box"].prototype.parse=function(t){this.parseFullHeader(t),r&&r.call(this,t)}},addSubBoxArrays:function(t){if(t){this.subBoxNames=t;for(var e=t.length,r=0;r<e;r++)this[t[r]+"s"]=[]}},createContainerBoxCtor:function(t,e,r,s){p[t+"Box"]=function(r){p.ContainerBox.call(this,t,r,e),p.addSubBoxArrays.call(this,s)},p[t+"Box"].prototype=new p.ContainerBox,r&&(p[t+"Box"].prototype.parse=r)},createMediaSampleEntryCtor:function(t,e,r){p.sampleEntryCodes[t]=[],p[t+"SampleEntry"]=function(t,e){p.SampleEntry.call(this,t,e),p.addSubBoxArrays.call(this,r)},p[t+"SampleEntry"].prototype=new p.SampleEntry,e&&(p[t+"SampleEntry"].prototype.parse=e)},createSampleEntryCtor:function(t,e,r,s){p.sampleEntryCodes[t].push(e),p[e+"SampleEntry"]=function(r){p[t+"SampleEntry"].call(this,e,r),p.addSubBoxArrays.call(this,s)},p[e+"SampleEntry"].prototype=new p[t+"SampleEntry"],r&&(p[e+"SampleEntry"].prototype.parse=r)},createEncryptedSampleEntryCtor:function(t,e,r){p.createSampleEntryCtor.call(this,t,e,r,["sinf"])},createSampleGroupCtor:function(t,e){p[t+"SampleGroupEntry"]=function(e){p.SampleGroupEntry.call(this,t,e)},p[t+"SampleGroupEntry"].prototype=new p.SampleGroupEntry,e&&(p[t+"SampleGroupEntry"].prototype.parse=e)},createTrackGroupCtor:function(t,e){p[t+"TrackGroupTypeBox"]=function(e){p.TrackGroupTypeBox.call(this,t,e)},p[t+"TrackGroupTypeBox"].prototype=new p.TrackGroupTypeBox,e&&(p[t+"TrackGroupTypeBox"].prototype.parse=e)},createUUIDBox:function(t,e,r,s,n){p.UUIDs.push(t),p.UUIDBoxes[t]=function(n){r?p.FullBox.call(this,"uuid",n,e,t):s?p.ContainerBox.call(this,"uuid",n,e,t):p.Box.call(this,"uuid",n,e,t)},p.UUIDBoxes[t].prototype=r?new p.FullBox:s?new p.ContainerBox:new p.Box,n&&(r?p.UUIDBoxes[t].prototype.parse=function(t){this.parseFullHeader(t),n&&n.call(this,t)}:p.UUIDBoxes[t].prototype.parse=n)}};function l(t){var e="<table class='inner-table'>";e+="<thead><tr><th>length</th><th>nalu_data</th></tr></thead><tbody>";for(var r=0;r<t.length;r++){var s=t[r];e+="<tr><td>"+s.length+"</td><td>"+s.nalu.reduce(function(t,e){return t+e.toString(16).padStart(2,"0")},"0x")+"</td></tr>"}return e+"</tbody></table>"}function f(t,e){this.x=t,this.y=e}function u(t,e){this.bad_pixel_row=t,this.bad_pixel_column=e}p.initialize(),p.TKHD_FLAG_ENABLED=1,p.TKHD_FLAG_IN_MOVIE=2,p.TKHD_FLAG_IN_PREVIEW=4,p.TFHD_FLAG_BASE_DATA_OFFSET=1,p.TFHD_FLAG_SAMPLE_DESC=2,p.TFHD_FLAG_SAMPLE_DUR=8,p.TFHD_FLAG_SAMPLE_SIZE=16,p.TFHD_FLAG_SAMPLE_FLAGS=32,p.TFHD_FLAG_DUR_EMPTY=65536,p.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072,p.TRUN_FLAGS_DATA_OFFSET=1,p.TRUN_FLAGS_FIRST_FLAG=4,p.TRUN_FLAGS_DURATION=256,p.TRUN_FLAGS_SIZE=512,p.TRUN_FLAGS_FLAGS=1024,p.TRUN_FLAGS_CTS_OFFSET=2048,p.Box.prototype.add=function(t){return this.addBox(new p[t+"Box"])},p.Box.prototype.addBox=function(t){return this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t},p.Box.prototype.set=function(t,e){return this[t]=e,this},p.Box.prototype.addEntry=function(t,e){var r=e||"entries";return this[r]||(this[r]=[]),this[r].push(t),this},e.BoxParser=p,p.parseUUID=function(t){return p.parseHex16(t)},p.parseHex16=function(t){for(var e="",r=0;r<16;r++){var s=t.readUint8().toString(16);e+=1===s.length?"0"+s:s}return e},p.parseOneBox=function(t,e,r){var s,a,o,h=t.getPosition(),d=0;if(t.getEndPosition()-h<8)return n.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:p.ERR_NOT_ENOUGH_DATA};if(r&&r<8)return n.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:p.ERR_NOT_ENOUGH_DATA};var l=t.readUint32(),f=t.readString(4),u=f;if(n.debug("BoxParser","Found box of type '"+f+"' and size "+l+" at position "+h),d=8,"uuid"==f){if(t.getEndPosition()-t.getPosition()<16||r-d<16)return t.seek(h),n.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:p.ERR_NOT_ENOUGH_DATA};o=p.parseUUID(t),d+=16,u=o}if(1==l){if(t.getEndPosition()-t.getPosition()<8||r&&r-d<8)return t.seek(h),n.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+f+'" box'),{code:p.ERR_NOT_ENOUGH_DATA};l=t.readUint64(),d+=8}else if(0===l){if(r)l=r;else if("mdat"!==f)return n.error("BoxParser","Unlimited box size not supported for type: '"+f+"'"),s=new p.Box(f,l),{code:p.OK,box:s,size:s.size}}return 0!==l&&l<d?(n.error("BoxParser","Box of type "+f+" has an invalid size "+l+" (too small to be a box)"),{code:p.ERR_NOT_ENOUGH_DATA,type:f,size:l,hdr_size:d,start:h}):0!==l&&r&&l>r?(n.error("BoxParser","Box of type '"+f+"' has a size "+l+" greater than its container size "+r),{code:p.ERR_NOT_ENOUGH_DATA,type:f,size:l,hdr_size:d,start:h}):0!==l&&h+l>t.getEndPosition()?(t.seek(h),n.info("BoxParser","Not enough data in stream to parse the entire '"+f+"' box"),{code:p.ERR_NOT_ENOUGH_DATA,type:f,size:l,hdr_size:d,start:h}):e?{code:p.OK,type:f,size:l,hdr_size:d,start:h}:(p[f+"Box"]?s=new p[f+"Box"](l):"uuid"!==f?(n.warn("BoxParser","Unknown box type: '"+f+"'"),(s=new p.Box(f,l)).has_unparsed_data=!0):p.UUIDBoxes[o]?s=new p.UUIDBoxes[o](l):(n.warn("BoxParser","Unknown uuid type: '"+o+"'"),(s=new p.Box(f,l)).uuid=o,s.has_unparsed_data=!0),s.hdr_size=d,s.start=h,s.write===p.Box.prototype.write&&"mdat"!==s.type&&(n.info("BoxParser","'"+u+"' box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(t)),s.parse(t),(a=t.getPosition()-(s.start+s.size))<0?(n.warn("BoxParser","Parsing of box '"+u+"' did not read the entire indicated box data size (missing "+-a+" bytes), seeking forward"),t.seek(s.start+s.size)):a>0&&(n.error("BoxParser","Parsing of box '"+u+"' read "+a+" more bytes than the indicated box data size, seeking backwards"),0!==s.size&&t.seek(s.start+s.size)),{code:p.OK,box:s,size:s.size})},p.Box.prototype.parse=function(t){"mdat"!=this.type?this.data=t.readUint8Array(this.size-this.hdr_size):0===this.size?t.seek(t.getEndPosition()):t.seek(this.start+this.size)},p.Box.prototype.parseDataAndRewind=function(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.position-=this.size-this.hdr_size},p.FullBox.prototype.parseDataAndRewind=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.position-=this.size-this.hdr_size},p.FullBox.prototype.parseFullHeader=function(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4},p.FullBox.prototype.parse=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},p.ContainerBox.prototype.parse=function(t){for(;t.getPosition()<this.start+this.size;){if((e=p.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==p.OK)return;if(r=e.box,this.boxes.push(r),this.subBoxNames&&-1!=this.subBoxNames.indexOf(r.type))this[this.subBoxNames[this.subBoxNames.indexOf(r.type)]+"s"].push(r);else{var e,r,s="uuid"!==r.type?r.type:r.uuid;this[s]?n.warn("Box of type "+s+" already stored in field of this type"):this[s]=r}}},p.Box.prototype.parseLanguage=function(t){this.language=t.readUint16();var e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=31&this.language,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)},p.SAMPLE_ENTRY_TYPE_VISUAL="Visual",p.SAMPLE_ENTRY_TYPE_AUDIO="Audio",p.SAMPLE_ENTRY_TYPE_HINT="Hint",p.SAMPLE_ENTRY_TYPE_METADATA="Metadata",p.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle",p.SAMPLE_ENTRY_TYPE_SYSTEM="System",p.SAMPLE_ENTRY_TYPE_TEXT="Text",p.SampleEntry.prototype.parseHeader=function(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8},p.SampleEntry.prototype.parse=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},p.SampleEntry.prototype.parseDataAndRewind=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.position-=this.size-this.hdr_size},p.SampleEntry.prototype.parseFooter=function(t){p.ContainerBox.prototype.parse.call(this,t)},p.createMediaSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_HINT),p.createMediaSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_METADATA),p.createMediaSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_SUBTITLE),p.createMediaSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_SYSTEM),p.createMediaSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_TEXT),p.createMediaSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,function(t){var e;this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16(),e=Math.min(31,t.readUint8()),this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)}),p.createMediaSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_AUDIO,function(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)}),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"avc1"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"avc2"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"avc3"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"avc4"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"av01"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"dav1"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"hev1"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"hvt1"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"lhe1"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"dvh1"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"dvhe"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"vvc1"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"vvi1"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"vvs1"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"vvcN"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"vp08"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"vp09"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"avs3"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"j2ki"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"mjp2"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"mjpg"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"uncv"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_AUDIO,"ac-4"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_AUDIO,"Opus"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_AUDIO,"mha1"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_AUDIO,"mha2"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_AUDIO,"mhm1"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_AUDIO,"mhm2"),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_AUDIO,"fLaC"),p.createEncryptedSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_VISUAL,"encv"),p.createEncryptedSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_AUDIO,"enca"),p.createEncryptedSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu"),p.createEncryptedSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_SYSTEM,"encs"),p.createEncryptedSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_TEXT,"enct"),p.createEncryptedSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_METADATA,"encm"),p.createBoxCtor("a1lx","AV1LayeredImageIndexingProperty",function(t){var e=((1&t.readUint8()&1)+1)*16;this.layer_size=[];for(var r=0;r<3;r++)16==e?this.layer_size[r]=t.readUint16():this.layer_size[r]=t.readUint32()}),p.createBoxCtor("a1op","OperatingPointSelectorProperty",function(t){this.op_index=t.readUint8()}),p.createFullBoxCtor("auxC","AuxiliaryTypeProperty",function(t){this.aux_type=t.readCString();var e=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=t.readUint8Array(e)}),p.createBoxCtor("av1C","AV1CodecConfigurationBox",function(t){var e=t.readUint8();if((e>>7&1)!=1){n.error("av1C marker problem");return}if(this.version=127&e,1!==this.version){n.error("av1C version "+this.version+" not supported");return}if(e=t.readUint8(),this.seq_profile=e>>5&7,this.seq_level_idx_0=31&e,e=t.readUint8(),this.seq_tier_0=e>>7&1,this.high_bitdepth=e>>6&1,this.twelve_bit=e>>5&1,this.monochrome=e>>4&1,this.chroma_subsampling_x=e>>3&1,this.chroma_subsampling_y=e>>2&1,this.chroma_sample_position=3&e,e=t.readUint8(),this.reserved_1=e>>5&7,0!==this.reserved_1){n.error("av1C reserved_1 parsing problem");return}if(this.initial_presentation_delay_present=e>>4&1,1===this.initial_presentation_delay_present)this.initial_presentation_delay_minus_one=15&e;else if(this.reserved_2=15&e,0!==this.reserved_2){n.error("av1C reserved_2 parsing problem");return}var r=this.size-this.hdr_size-4;this.configOBUs=t.readUint8Array(r)}),p.createBoxCtor("avcC","AVCConfigurationBox",function(t){var e,r;for(e=0,this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=3&t.readUint8(),this.nb_SPS_nalus=31&t.readUint8(),r=this.size-this.hdr_size-6,this.SPS=[],this.SPS.toString=function(){return l(this)};e<this.nb_SPS_nalus;e++)this.SPS[e]={},this.SPS[e].length=t.readUint16(),this.SPS[e].nalu=t.readUint8Array(this.SPS[e].length),r-=2+this.SPS[e].length;for(this.nb_PPS_nalus=t.readUint8(),r--,this.PPS=[],this.PPS.toString=function(){return l(this)},e=0;e<this.nb_PPS_nalus;e++)this.PPS[e]={},this.PPS[e].length=t.readUint16(),this.PPS[e].nalu=t.readUint8Array(this.PPS[e].length),r-=2+this.PPS[e].length;r>0&&(this.ext=t.readUint8Array(r))}),p.createBoxCtor("btrt","BitRateBox",function(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()}),p.createFullBoxCtor("ccst","CodingConstraintsBox",function(t){var e=t.readUint8();this.all_ref_pics_intra=(128&e)==128,this.intra_pred_used=(64&e)==64,this.max_ref_per_pic=(63&e)>>2,t.readUint24()}),p.createBoxCtor("cdef","ComponentDefinitionBox",function(t){var e;for(e=0,this.channel_count=t.readUint16(),this.channel_indexes=[],this.channel_types=[],this.channel_associations=[];e<this.channel_count;e++)this.channel_indexes.push(t.readUint16()),this.channel_types.push(t.readUint16()),this.channel_associations.push(t.readUint16())}),p.createBoxCtor("clap","CleanApertureBox",function(t){this.cleanApertureWidthN=t.readUint32(),this.cleanApertureWidthD=t.readUint32(),this.cleanApertureHeightN=t.readUint32(),this.cleanApertureHeightD=t.readUint32(),this.horizOffN=t.readUint32(),this.horizOffD=t.readUint32(),this.vertOffN=t.readUint32(),this.vertOffD=t.readUint32()}),p.createBoxCtor("clli","ContentLightLevelBox",function(t){this.max_content_light_level=t.readUint16(),this.max_pic_average_light_level=t.readUint16()}),p.createFullBoxCtor("cmex","CameraExtrinsicMatrixProperty",function(t){1&this.flags&&(this.pos_x=t.readInt32()),2&this.flags&&(this.pos_y=t.readInt32()),4&this.flags&&(this.pos_z=t.readInt32()),8&this.flags&&(0==this.version?16&this.flags?(this.quat_x=t.readInt32(),this.quat_y=t.readInt32(),this.quat_z=t.readInt32()):(this.quat_x=t.readInt16(),this.quat_y=t.readInt16(),this.quat_z=t.readInt16()):this.version),32&this.flags&&(this.id=t.readUint32())}),p.createFullBoxCtor("cmin","CameraIntrinsicMatrixProperty",function(t){this.focal_length_x=t.readInt32(),this.principal_point_x=t.readInt32(),this.principal_point_y=t.readInt32(),1&this.flags&&(this.focal_length_y=t.readInt32(),this.skew_factor=t.readInt32())}),p.createBoxCtor("cmpd","ComponentDefinitionBox",function(t){for(i=0,this.component_count=t.readUint32(),this.component_types=[],this.component_type_urls=[];i<this.component_count;i++){var e=t.readUint16();this.component_types.push(e),e>=32768&&this.component_type_urls.push(t.readCString())}}),p.createFullBoxCtor("co64","ChunkLargeOffsetBox",function(t){var e,r;if(e=t.readUint32(),this.chunk_offsets=[],0===this.version)for(r=0;r<e;r++)this.chunk_offsets.push(t.readUint64())}),p.createFullBoxCtor("CoLL","ContentLightLevelBox",function(t){this.maxCLL=t.readUint16(),this.maxFALL=t.readUint16()}),p.createBoxCtor("colr","ColourInformationBox",function(t){if(this.colour_type=t.readString(4),"nclx"===this.colour_type){this.colour_primaries=t.readUint16(),this.transfer_characteristics=t.readUint16(),this.matrix_coefficients=t.readUint16();var e=t.readUint8();this.full_range_flag=e>>7}else"rICC"===this.colour_type?this.ICC_profile=t.readUint8Array(this.size-4):"prof"===this.colour_type&&(this.ICC_profile=t.readUint8Array(this.size-4))}),p.createFullBoxCtor("cprt","CopyrightBox",function(t){this.parseLanguage(t),this.notice=t.readCString()}),p.createFullBoxCtor("cslg","CompositionToDecodeBox",function(t){0===this.version&&(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32())}),p.createFullBoxCtor("ctts","CompositionOffsetBox",function(t){if(e=t.readUint32(),this.sample_counts=[],this.sample_offsets=[],0===this.version)for(r=0;r<e;r++){this.sample_counts.push(t.readUint32());var e,r,s=t.readInt32();s<0&&n.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(s)}else if(1==this.version)for(r=0;r<e;r++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())}),p.createBoxCtor("dac3","AC3SpecificBox",function(t){var e=t.readUint8(),r=t.readUint8(),s=t.readUint8();this.fscod=e>>6,this.bsid=e>>1&31,this.bsmod=(1&e)<<2|r>>6&3,this.acmod=r>>3&7,this.lfeon=r>>2&1,this.bit_rate_code=3&r|s>>5&7}),p.createBoxCtor("dec3","EC3SpecificBox",function(t){var e=t.readUint16();this.data_rate=e>>3,this.num_ind_sub=7&e,this.ind_subs=[];for(var r=0;r<this.num_ind_sub+1;r++){var s={};this.ind_subs.push(s);var n=t.readUint8(),a=t.readUint8(),o=t.readUint8();s.fscod=n>>6,s.bsid=n>>1&31,s.bsmod=(1&n)<<4|a>>4&15,s.acmod=a>>1&7,s.lfeon=1&a,s.num_dep_sub=o>>1&15,s.num_dep_sub>0&&(s.chan_loc=(1&o)<<8|t.readUint8())}}),p.createFullBoxCtor("dfLa","FLACSpecificBox",function(t){for(var e=[],r=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];;){var s=t.readUint8(),n=Math.min(127&s,r.length-1);if(n?t.readUint8Array(t.readUint24()):(t.readUint8Array(13),this.samplerate=t.readUint32()>>12,t.readUint8Array(20)),e.push(r[n]),128&s)break}this.numMetadataBlocks=e.length+" ("+e.join(", ")+")"}),p.createBoxCtor("dimm","hintimmediateBytesSent",function(t){this.bytessent=t.readUint64()}),p.createBoxCtor("dmax","hintlongestpacket",function(t){this.time=t.readUint32()}),p.createBoxCtor("dmed","hintmediaBytesSent",function(t){this.bytessent=t.readUint64()}),p.createBoxCtor("dOps","OpusSpecificBox",function(t){if(this.Version=t.readUint8(),this.OutputChannelCount=t.readUint8(),this.PreSkip=t.readUint16(),this.InputSampleRate=t.readUint32(),this.OutputGain=t.readInt16(),this.ChannelMappingFamily=t.readUint8(),0!==this.ChannelMappingFamily){this.StreamCount=t.readUint8(),this.CoupledCount=t.readUint8(),this.ChannelMapping=[];for(var e=0;e<this.OutputChannelCount;e++)this.ChannelMapping[e]=t.readUint8()}}),p.createFullBoxCtor("dref","DataReferenceBox",function(t){this.entries=[];for(var e,r,s=t.readUint32(),n=0;n<s;n++){if((e=p.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==p.OK)return;r=e.box,this.entries.push(r)}}),p.createBoxCtor("drep","hintrepeatedBytesSent",function(t){this.bytessent=t.readUint64()}),p.createFullBoxCtor("elng","ExtendedLanguageBox",function(t){this.extended_language=t.readString(this.size-this.hdr_size)}),p.createFullBoxCtor("elst","EditListBox",function(t){this.entries=[];for(var e=t.readUint32(),r=0;r<e;r++){var s={};this.entries.push(s),1===this.version?(s.segment_duration=t.readUint64(),s.media_time=t.readInt64()):(s.segment_duration=t.readUint32(),s.media_time=t.readInt32()),s.media_rate_integer=t.readInt16(),s.media_rate_fraction=t.readInt16()}}),p.createFullBoxCtor("emsg","EventMessageBox",function(t){1==this.version?(this.timescale=t.readUint32(),this.presentation_time=t.readUint64(),this.event_duration=t.readUint32(),this.id=t.readUint32(),this.scheme_id_uri=t.readCString(),this.value=t.readCString()):(this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32());var e=this.size-this.hdr_size-(16+(this.scheme_id_uri.length+1)+(this.value.length+1));1==this.version&&(e-=4),this.message_data=t.readUint8Array(e)}),p.createEntityToGroupCtor=function(t,e){p[t+"Box"]=function(e){p.FullBox.call(this,t,e)},p[t+"Box"].prototype=new p.FullBox,p[t+"Box"].prototype.parse=function(t){if(this.parseFullHeader(t),e)e.call(this,t);else for(i=0,this.group_id=t.readUint32(),this.num_entities_in_group=t.readUint32(),this.entity_ids=[];i<this.num_entities_in_group;i++){var r=t.readUint32();this.entity_ids.push(r)}}},p.createEntityToGroupCtor("aebr"),p.createEntityToGroupCtor("afbr"),p.createEntityToGroupCtor("albc"),p.createEntityToGroupCtor("altr"),p.createEntityToGroupCtor("brst"),p.createEntityToGroupCtor("dobr"),p.createEntityToGroupCtor("eqiv"),p.createEntityToGroupCtor("favc"),p.createEntityToGroupCtor("fobr"),p.createEntityToGroupCtor("iaug"),p.createEntityToGroupCtor("pano"),p.createEntityToGroupCtor("slid"),p.createEntityToGroupCtor("ster"),p.createEntityToGroupCtor("tsyn"),p.createEntityToGroupCtor("wbbr"),p.createEntityToGroupCtor("prgr"),p.createEntityToGroupCtor("pymd",function(t){this.group_id=t.readUint32(),this.num_entities_in_group=t.readUint32(),this.entity_ids=[];for(var e=0;e<this.num_entities_in_group;e++){var r=t.readUint32();this.entity_ids.push(r)}for(e=0,this.tile_size_x=t.readUint16(),this.tile_size_y=t.readUint16(),this.layer_binning=[],this.tiles_in_layer_column_minus1=[],this.tiles_in_layer_row_minus1=[];e<this.num_entities_in_group;e++)this.layer_binning[e]=t.readUint16(),this.tiles_in_layer_row_minus1[e]=t.readUint16(),this.tiles_in_layer_column_minus1[e]=t.readUint16()}),p.createFullBoxCtor("esds","ElementaryStreamDescriptorBox",function(t){var e=t.readUint8Array(this.size-this.hdr_size);if(void 0!==d){var r=new d;this.esd=r.parseOneDescriptor(new o(e.buffer,0,o.BIG_ENDIAN))}}),p.createBoxCtor("fiel","FieldHandlingBox",function(t){this.fieldCount=t.readUint8(),this.fieldOrdering=t.readUint8()}),p.createBoxCtor("frma","OriginalFormatBox",function(t){this.data_format=t.readString(4)}),p.createBoxCtor("ftyp","FileTypeBox",function(t){var e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];for(var r=0;e>=4;)this.compatible_brands[r]=t.readString(4),e-=4,r++}),p.createFullBoxCtor("hdlr","HandlerBox",function(t){0===this.version&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),this.name=t.readString(this.size-this.hdr_size-20),"\0"===this.name[this.name.length-1]&&(this.name=this.name.slice(0,-1)))}),p.createBoxCtor("hvcC","HEVCConfigurationBox",function(t){this.configurationVersion=t.readUint8(),n=t.readUint8(),this.general_profile_space=n>>6,this.general_tier_flag=(32&n)>>5,this.general_profile_idc=31&n,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=4095&t.readUint16(),this.parallelismType=3&t.readUint8(),this.chroma_format_idc=3&t.readUint8(),this.bit_depth_luma_minus8=7&t.readUint8(),this.bit_depth_chroma_minus8=7&t.readUint8(),this.avgFrameRate=t.readUint16(),n=t.readUint8(),this.constantFrameRate=n>>6,this.numTemporalLayers=(13&n)>>3,this.temporalIdNested=(4&n)>>2,this.lengthSizeMinusOne=3&n,this.nalu_arrays=[],this.nalu_arrays.toString=function(){var t="<table class='inner-table'>";t+="<thead><tr><th>completeness</th><th>nalu_type</th><th>nalu_data</th></tr></thead><tbody>";for(var e=0;e<this.length;e++){var r=this[e];t+="<tr>"+("<td rowspan='"+r.length+"'>")+r.completeness+"</td>"+("<td rowspan='"+r.length+"'>")+r.nalu_type+"</td>";for(var s=0;s<r.length;s++){var n=r[s];0!==s&&(t+="<tr>"),t+="<td>"+n.data.reduce(function(t,e){return t+e.toString(16).padStart(2,"0")},"0x")+"</td></tr>"}}return t+"</tbody></table>"};var e,r,s,n,a=t.readUint8();for(e=0;e<a;e++){var o=[];this.nalu_arrays.push(o),n=t.readUint8(),o.completeness=(128&n)>>7,o.nalu_type=63&n;var h=t.readUint16();for(r=0;r<h;r++){var d={};o.push(d),s=t.readUint16(),d.data=t.readUint8Array(s)}}}),p.createFullBoxCtor("iinf","ItemInfoBox",function(t){var e;0===this.version?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(var r=0;r<this.entry_count;r++){if((e=p.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==p.OK)return;"infe"!==e.box.type&&n.error("BoxParser","Expected 'infe' box, got "+e.box.type),this.item_infos[r]=e.box}}),p.createFullBoxCtor("iloc","ItemLocationBox",function(t){e=t.readUint8(),this.offset_size=e>>4&15,this.length_size=15&e,e=t.readUint8(),this.base_offset_size=e>>4&15,1===this.version||2===this.version?this.index_size=15&e:this.index_size=0,this.items=[];var e,r=0;if(this.version<2)r=t.readUint16();else if(2===this.version)r=t.readUint32();else throw"version of iloc box not supported";for(var s=0;s<r;s++){var n={};if(this.items.push(n),this.version<2)n.item_ID=t.readUint16();else if(2===this.version)n.item_ID=t.readUint32();else throw"version of iloc box not supported";switch(1===this.version||2===this.version?n.construction_method=15&t.readUint16():n.construction_method=0,n.data_reference_index=t.readUint16(),this.base_offset_size){case 0:n.base_offset=0;break;case 4:n.base_offset=t.readUint32();break;case 8:n.base_offset=t.readUint64();break;default:throw"Error reading base offset size"}var a=t.readUint16();n.extents=[];for(var o=0;o<a;o++){var h={};if(n.extents.push(h),1===this.version||2===this.version)switch(this.index_size){case 0:h.extent_index=0;break;case 4:h.extent_index=t.readUint32();break;case 8:h.extent_index=t.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:h.extent_offset=0;break;case 4:h.extent_offset=t.readUint32();break;case 8:h.extent_offset=t.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:h.extent_length=0;break;case 4:h.extent_length=t.readUint32();break;case 8:h.extent_length=t.readUint64();break;default:throw"Error reading extent index"}}}}),p.createBoxCtor("imir","ImageMirror",function(t){var e=t.readUint8();this.reserved=e>>7,this.axis=1&e}),p.createFullBoxCtor("infe","ItemInfoEntry",function(t){if((0===this.version||1===this.version)&&(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.content_encoding=t.readCString()),1===this.version){this.extension_type=t.readString(4),n.warn("BoxParser","Cannot parse extension type"),t.seek(this.start+this.size);return}this.version>=2&&(2===this.version?this.item_ID=t.readUint16():3===this.version&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.item_name=t.readCString(),"mime"===this.item_type?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):"uri "===this.item_type&&(this.item_uri_type=t.readCString()))}),p.createFullBoxCtor("ipma","ItemPropertyAssociationBox",function(t){var e,r;for(e=0,entry_count=t.readUint32(),this.associations=[];e<entry_count;e++){var s={};this.associations.push(s),this.version<1?s.id=t.readUint16():s.id=t.readUint32();var n=t.readUint8();for(r=0,s.props=[];r<n;r++){var a=t.readUint8(),o={};s.props.push(o),o.essential=(128&a)>>7==1,1&this.flags?o.property_index=(127&a)<<8|t.readUint8():o.property_index=127&a}}}),p.createFullBoxCtor("iref","ItemReferenceBox",function(t){var e,r;for(this.references=[];t.getPosition()<this.start+this.size;){if((e=p.parseOneBox(t,!0,this.size-(t.getPosition()-this.start))).code!==p.OK)return;(r=0===this.version?new p.SingleItemTypeReferenceBox(e.type,e.size,e.hdr_size,e.start):new p.SingleItemTypeReferenceBoxLarge(e.type,e.size,e.hdr_size,e.start)).write===p.Box.prototype.write&&"mdat"!==r.type&&(n.warn("BoxParser",r.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),r.parseDataAndRewind(t)),r.parse(t),this.references.push(r)}}),p.createBoxCtor("irot","ImageRotation",function(t){this.angle=3&t.readUint8()}),p.createFullBoxCtor("ispe","ImageSpatialExtentsProperty",function(t){this.image_width=t.readUint32(),this.image_height=t.readUint32()}),p.createFullBoxCtor("kind","KindBox",function(t){this.schemeURI=t.readCString(),this.value=t.readCString()}),p.createFullBoxCtor("leva","LevelAssignmentBox",function(t){var e=t.readUint8();this.levels=[];for(var r=0;r<e;r++){var s={};this.levels[r]=s,s.track_ID=t.readUint32();var a=t.readUint8();switch(s.padding_flag=a>>7,s.assignment_type=127&a,s.assignment_type){case 0:s.grouping_type=t.readString(4);break;case 1:s.grouping_type=t.readString(4),s.grouping_type_parameter=t.readUint32();break;case 2:case 3:break;case 4:s.sub_track_id=t.readUint32();break;default:n.warn("BoxParser","Unknown leva assignement type")}}}),p.createBoxCtor("lhvC","LHEVCConfigurationBox",function(t){this.configurationVersion=t.readUint8(),this.min_spatial_segmentation_idc=4095&t.readUint16(),this.parallelismType=3&t.readUint8(),s=t.readUint8(),this.numTemporalLayers=(13&s)>>3,this.temporalIdNested=(4&s)>>2,this.lengthSizeMinusOne=3&s,this.nalu_arrays=[],this.nalu_arrays.toString=function(){var t="<table class='inner-table'>";t+="<thead><tr><th>completeness</th><th>nalu_type</th><th>nalu_data</th></tr></thead><tbody>";for(var e=0;e<this.length;e++){var r=this[e];t+="<tr>"+("<td rowspan='"+r.length+"'>")+r.completeness+"</td>"+("<td rowspan='"+r.length+"'>")+r.nalu_type+"</td>";for(var s=0;s<r.length;s++){var n=r[s];0!==s&&(t+="<tr>"),t+="<td>"+n.data.reduce(function(t,e){return t+e.toString(16).padStart(2,"0")},"0x")+"</td></tr>"}}return t+"</tbody></table>"};var e,r,s,n=t.readUint8();for(e=0;e<n;e++){var a=[];this.nalu_arrays.push(a),s=t.readUint8(),a.completeness=(128&s)>>7,a.nalu_type=63&s;var o=t.readUint16();for(r=0;r<o;r++){var h={};a.push(h);var d=t.readUint16();h.data=t.readUint8Array(d)}}}),p.createBoxCtor("lsel","LayerSelectorProperty",function(t){this.layer_id=t.readUint16()}),p.createBoxCtor("maxr","hintmaxrate",function(t){this.period=t.readUint32(),this.bytes=t.readUint32()}),f.prototype.toString=function(){return"("+this.x+","+this.y+")"},p.createBoxCtor("mdcv","MasteringDisplayColourVolumeBox",function(t){this.display_primaries=[],this.display_primaries[0]=new f(t.readUint16(),t.readUint16()),this.display_primaries[1]=new f(t.readUint16(),t.readUint16()),this.display_primaries[2]=new f(t.readUint16(),t.readUint16()),this.white_point=new f(t.readUint16(),t.readUint16()),this.max_display_mastering_luminance=t.readUint32(),this.min_display_mastering_luminance=t.readUint32()}),p.createFullBoxCtor("mdhd","MediaHeaderBox",function(t){1==this.version?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()}),p.createFullBoxCtor("mehd","MovieExtendsHeaderBox",function(t){1&this.flags&&(n.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),1==this.version?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()}),p.createFullBoxCtor("meta","MetaBox",function(t){this.boxes=[],p.ContainerBox.prototype.parse.call(this,t)}),p.createFullBoxCtor("mfhd","MovieFragmentHeaderBox",function(t){this.sequence_number=t.readUint32()}),p.createFullBoxCtor("mfro","MovieFragmentRandomAccessOffsetBox",function(t){this._size=t.readUint32()}),p.createFullBoxCtor("mskC","MaskConfigurationProperty",function(t){this.bits_per_pixel=t.readUint8()}),p.createFullBoxCtor("mvhd","MovieHeaderBox",function(t){1==this.version?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readUint32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()}),p.createBoxCtor("npck","hintPacketsSent",function(t){this.packetssent=t.readUint32()}),p.createBoxCtor("nump","hintPacketsSent",function(t){this.packetssent=t.readUint64()}),p.createFullBoxCtor("padb","PaddingBitsBox",function(t){var e=t.readUint32();this.padbits=[];for(var r=0;r<Math.floor((e+1)/2);r++)this.padbits=t.readUint8()}),p.createBoxCtor("pasp","PixelAspectRatioBox",function(t){this.hSpacing=t.readUint32(),this.vSpacing=t.readUint32()}),p.createBoxCtor("payl","CuePayloadBox",function(t){this.text=t.readString(this.size-this.hdr_size)}),p.createBoxCtor("payt","hintpayloadID",function(t){this.payloadID=t.readUint32();var e=t.readUint8();this.rtpmap_string=t.readString(e)}),p.createFullBoxCtor("pdin","ProgressiveDownloadInfoBox",function(t){var e=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var r=0;r<e;r++)this.rate[r]=t.readUint32(),this.initial_delay[r]=t.readUint32()}),p.createFullBoxCtor("pitm","PrimaryItemBox",function(t){0===this.version?this.item_id=t.readUint16():this.item_id=t.readUint32()}),p.createFullBoxCtor("pixi","PixelInformationProperty",function(t){var e;for(e=0,this.num_channels=t.readUint8(),this.bits_per_channels=[];e<this.num_channels;e++)this.bits_per_channels[e]=t.readUint8()}),p.createBoxCtor("pmax","hintlargestpacket",function(t){this.bytes=t.readUint32()}),p.createFullBoxCtor("prdi","ProgressiveDerivedImageItemInformationProperty",function(t){if(this.step_count=t.readUint16(),this.item_count=[],2&this.flags)for(var e=0;e<this.step_count;e++)this.item_count[e]=t.readUint16()}),p.createFullBoxCtor("prft","ProducerReferenceTimeBox",function(t){this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),0===this.version?this.media_time=t.readUint32():this.media_time=t.readUint64()}),p.createFullBoxCtor("pssh","ProtectionSystemSpecificHeaderBox",function(t){if(this.system_id=p.parseHex16(t),this.version>0){var e=t.readUint32();this.kid=[];for(var r=0;r<e;r++)this.kid[r]=p.parseHex16(t)}var s=t.readUint32();s>0&&(this.data=t.readUint8Array(s))}),p.createFullBoxCtor("clef","TrackCleanApertureDimensionsBox",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),p.createFullBoxCtor("enof","TrackEncodedPixelsDimensionsBox",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),p.createFullBoxCtor("prof","TrackProductionApertureDimensionsBox",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),p.createContainerBoxCtor("tapt","TrackApertureModeDimensionsBox",null,["clef","prof","enof"]),p.createBoxCtor("rtp ","rtpmoviehintinformation",function(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)}),p.createFullBoxCtor("saio","SampleAuxiliaryInformationOffsetsBox",function(t){1&this.flags&&(this.aux_info_type=t.readString(4),this.aux_info_type_parameter=t.readUint32());var e=t.readUint32();this.offset=[];for(var r=0;r<e;r++)0===this.version?this.offset[r]=t.readUint32():this.offset[r]=t.readUint64()}),p.createFullBoxCtor("saiz","SampleAuxiliaryInformationSizesBox",function(t){if(1&this.flags&&(this.aux_info_type=t.readString(4),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8(),this.sample_count=t.readUint32(),this.sample_info_size=[],0===this.default_sample_info_size)for(var e=0;e<this.sample_count;e++)this.sample_info_size[e]=t.readUint8()}),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_METADATA,"mett",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_METADATA,"metx",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)}),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",function(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)}),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",function(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)}),p.createSampleEntryCtor(p.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",function(t){this.parseHeader(t),this.parseFooter(t)}),p.createSampleGroupCtor("alst",function(t){var e,r=t.readUint16();for(e=0,this.first_output_sample=t.readUint16(),this.sample_offset=[];e<r;e++)this.sample_offset[e]=t.readUint32();var s=this.description_length-4-4*r;for(e=0,this.num_output_samples=[],this.num_total_samples=[];e<s/4;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()}),p.createSampleGroupCtor("avll",function(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()}),p.createSampleGroupCtor("avss",function(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();var e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];for(var r=t.readUint8(),s=0;s<r;s++){var n={};this.dependency.push(n),n.subSeqDirectionFlag=t.readUint8(),n.layerNumber=t.readUint8(),n.subSequenceIdentifier=t.readUint16()}}),p.createSampleGroupCtor("dtrt",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),p.createSampleGroupCtor("mvif",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),p.createSampleGroupCtor("prol",function(t){this.roll_distance=t.readInt16()}),p.createSampleGroupCtor("rap ",function(t){var e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=127&e}),p.createSampleGroupCtor("rash",function(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(1===this.operation_point_count?2:6*this.operation_point_count)+9)n.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(1===this.operation_point_count)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}}),p.createSampleGroupCtor("roll",function(t){this.roll_distance=t.readInt16()}),p.SampleGroupEntry.prototype.parse=function(t){n.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=t.readUint8Array(this.description_length)},p.createSampleGroupCtor("scif",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),p.createSampleGroupCtor("scnm",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),p.createSampleGroupCtor("seig",function(t){this.reserved=t.readUint8();var e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=15&e,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=p.parseHex16(t),this.constant_IV_size=0,this.constant_IV=0,1===this.isProtected&&0===this.Per_Sample_IV_Size&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))}),p.createSampleGroupCtor("stsa",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),p.createSampleGroupCtor("sync",function(t){var e=t.readUint8();this.NAL_unit_type=63&e}),p.createSampleGroupCtor("tele",function(t){var e=t.readUint8();this.level_independently_decodable=e>>7}),p.createSampleGroupCtor("tsas",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),p.createSampleGroupCtor("tscl",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),p.createSampleGroupCtor("vipr",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),p.createFullBoxCtor("sbgp","SampleToGroupBox",function(t){this.grouping_type=t.readString(4),1===this.version?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var e=t.readUint32(),r=0;r<e;r++){var s={};this.entries.push(s),s.sample_count=t.readInt32(),s.group_description_index=t.readInt32()}}),u.prototype.toString=function(){return"[row: "+this.bad_pixel_row+", column: "+this.bad_pixel_column+"]"},p.createFullBoxCtor("sbpm","SensorBadPixelsMapBox",function(t){for(e=0,this.component_count=t.readUint16(),this.component_index=[];e<this.component_count;e++)this.component_index.push(t.readUint16());var e,r=t.readUint8();for(e=0,this.correction_applied=128==(128&r),this.num_bad_rows=t.readUint32(),this.num_bad_cols=t.readUint32(),this.num_bad_pixels=t.readUint32(),this.bad_rows=[],this.bad_columns=[],this.bad_pixels=[];e<this.num_bad_rows;e++)this.bad_rows.push(t.readUint32());for(e=0;e<this.num_bad_cols;e++)this.bad_columns.push(t.readUint32());for(e=0;e<this.num_bad_pixels;e++){var s=t.readUint32(),n=t.readUint32();this.bad_pixels.push(new u(s,n))}}),p.createFullBoxCtor("schm","SchemeTypeBox",function(t){this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),1&this.flags&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))}),p.createBoxCtor("sdp ","rtptracksdphintinformation",function(t){this.sdptext=t.readString(this.size-this.hdr_size)}),p.createFullBoxCtor("sdtp","SampleDependencyTypeBox",function(t){var e,r=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var s=0;s<r;s++)e=t.readUint8(),this.is_leading[s]=e>>6,this.sample_depends_on[s]=e>>4&3,this.sample_is_depended_on[s]=e>>2&3,this.sample_has_redundancy[s]=3&e}),p.createFullBoxCtor("senc","SampleEncryptionBox"),p.createFullBoxCtor("sgpd","SampleGroupDescriptionBox",function(t){this.grouping_type=t.readString(4),n.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),1===this.version?this.default_length=t.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=t.readUint32()),this.entries=[];for(var e,r=t.readUint32(),s=0;s<r;s++)e=p[this.grouping_type+"SampleGroupEntry"]?new p[this.grouping_type+"SampleGroupEntry"](this.grouping_type):new p.SampleGroupEntry(this.grouping_type),this.entries.push(e),1===this.version&&0===this.default_length?e.description_length=t.readUint32():e.description_length=this.default_length,e.write===p.SampleGroupEntry.prototype.write&&(n.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),e.data=t.readUint8Array(e.description_length),t.position-=e.description_length),e.parse(t)}),p.createFullBoxCtor("sidx","CompressedSegmentIndexBox",function(t){this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),0===this.version?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];for(var e=t.readUint16(),r=0;r<e;r++){var s={};this.references.push(s);var n=t.readUint32();s.reference_type=n>>31&1,s.referenced_size=2147483647&n,s.subsegment_duration=t.readUint32(),n=t.readUint32(),s.starts_with_SAP=n>>31&1,s.SAP_type=n>>28&7,s.SAP_delta_time=268435455&n}}),p.SingleItemTypeReferenceBox=function(t,e,r,s){p.Box.call(this,t,e),this.hdr_size=r,this.start=s},p.SingleItemTypeReferenceBox.prototype=new p.Box,p.SingleItemTypeReferenceBox.prototype.parse=function(t){this.from_item_ID=t.readUint16();var e=t.readUint16();this.references=[];for(var r=0;r<e;r++)this.references[r]={},this.references[r].to_item_ID=t.readUint16()},p.SingleItemTypeReferenceBoxLarge=function(t,e,r,s){p.Box.call(this,t,e),this.hdr_size=r,this.start=s},p.SingleItemTypeReferenceBoxLarge.prototype=new p.Box,p.SingleItemTypeReferenceBoxLarge.prototype.parse=function(t){this.from_item_ID=t.readUint32();var e=t.readUint16();this.references=[];for(var r=0;r<e;r++)this.references[r]={},this.references[r].to_item_ID=t.readUint32()},p.createFullBoxCtor("SmDm","SMPTE2086MasteringDisplayMetadataBox",function(t){this.primaryRChromaticity_x=t.readUint16(),this.primaryRChromaticity_y=t.readUint16(),this.primaryGChromaticity_x=t.readUint16(),this.primaryGChromaticity_y=t.readUint16(),this.primaryBChromaticity_x=t.readUint16(),this.primaryBChromaticity_y=t.readUint16(),this.whitePointChromaticity_x=t.readUint16(),this.whitePointChromaticity_y=t.readUint16(),this.luminanceMax=t.readUint32(),this.luminanceMin=t.readUint32()}),p.createFullBoxCtor("smhd","SoundMediaHeaderBox",function(t){this.balance=t.readUint16(),t.readUint16()}),p.createFullBoxCtor("ssix","CompressedSubsegmentIndexBox",function(t){this.subsegments=[];for(var e=t.readUint32(),r=0;r<e;r++){var s={};this.subsegments.push(s),s.ranges=[];for(var n=t.readUint32(),a=0;a<n;a++){var o={};s.ranges.push(o),o.level=t.readUint8(),o.range_size=t.readUint24()}}}),p.createFullBoxCtor("stco","ChunkOffsetBox",function(t){var e;if(e=t.readUint32(),this.chunk_offsets=[],0===this.version)for(var r=0;r<e;r++)this.chunk_offsets.push(t.readUint32())}),p.createFullBoxCtor("stdp","DegradationPriorityBox",function(t){var e=(this.size-this.hdr_size)/2;this.priority=[];for(var r=0;r<e;r++)this.priority[r]=t.readUint16()}),p.createFullBoxCtor("sthd","SubtitleMediaHeaderBox"),p.createFullBoxCtor("stri","SubTrackInformationBox",function(t){this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();var e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var r=0;r<e;r++)this.attribute_list[r]=t.readUint32()}),p.createFullBoxCtor("stsc","SampleToChunkBox",function(t){var e,r;if(e=t.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],0===this.version)for(r=0;r<e;r++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())}),p.createFullBoxCtor("stsd","SampleDescriptionBox",function(t){var e,r,s,a;for(e=1,this.entries=[],s=t.readUint32();e<=s;e++){if((r=p.parseOneBox(t,!0,this.size-(t.getPosition()-this.start))).code!==p.OK)return;p[r.type+"SampleEntry"]?((a=new p[r.type+"SampleEntry"](r.size)).hdr_size=r.hdr_size,a.start=r.start):(n.warn("BoxParser","Unknown sample entry type: "+r.type),a=new p.SampleEntry(r.type,r.size,r.hdr_size,r.start)),a.write===p.SampleEntry.prototype.write&&(n.info("BoxParser","SampleEntry "+a.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),a.parseDataAndRewind(t)),a.parse(t),this.entries.push(a)}}),p.createFullBoxCtor("stsg","SubTrackSampleGroupBox",function(t){this.grouping_type=t.readUint32();var e=t.readUint16();this.group_description_index=[];for(var r=0;r<e;r++)this.group_description_index[r]=t.readUint32()}),p.createFullBoxCtor("stsh","ShadowSyncSampleBox",function(t){var e,r;if(e=t.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],0===this.version)for(r=0;r<e;r++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())}),p.createFullBoxCtor("stss","SyncSampleBox",function(t){var e,r;if(r=t.readUint32(),0===this.version)for(e=0,this.sample_numbers=[];e<r;e++)this.sample_numbers.push(t.readUint32())}),p.createFullBoxCtor("stsz","SampleSizeBox",function(t){var e;if(this.sample_sizes=[],0===this.version)for(e=0,this.sample_size=t.readUint32(),this.sample_count=t.readUint32();e<this.sample_count;e++)0===this.sample_size?this.sample_sizes.push(t.readUint32()):this.sample_sizes[e]=this.sample_size}),p.createFullBoxCtor("stts","TimeToSampleBox",function(t){var e,r,s;if(e=t.readUint32(),this.sample_counts=[],this.sample_deltas=[],0===this.version)for(r=0;r<e;r++)this.sample_counts.push(t.readUint32()),(s=t.readInt32())<0&&(n.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),s=1),this.sample_deltas.push(s)}),p.createFullBoxCtor("stvi","StereoVideoBox",function(t){var e,r,s=t.readUint32();this.single_view_allowed=3&s,this.stereo_scheme=t.readUint32();var n=t.readUint32();for(this.stereo_indication_type=t.readString(n),this.boxes=[];t.getPosition()<this.start+this.size;){if((e=p.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==p.OK)return;r=e.box,this.boxes.push(r),this[r.type]=r}}),p.createBoxCtor("styp","SegmentTypeBox",function(t){p.ftypBox.prototype.parse.call(this,t)}),p.createFullBoxCtor("stz2","CompactSampleSizeBox",function(t){if(this.sample_sizes=[],0===this.version){if(this.reserved=t.readUint24(),this.field_size=t.readUint8(),r=t.readUint32(),4===this.field_size)for(e=0;e<r;e+=2){var e,r,s=t.readUint8();this.sample_sizes[e]=s>>4&15,this.sample_sizes[e+1]=15&s}else if(8===this.field_size)for(e=0;e<r;e++)this.sample_sizes[e]=t.readUint8();else if(16===this.field_size)for(e=0;e<r;e++)this.sample_sizes[e]=t.readUint16();else n.error("BoxParser","Error in length field in stz2 box")}}),p.createFullBoxCtor("subs","SubSampleInformationBox",function(t){for(e=0,s=t.readUint32(),this.entries=[];e<s;e++){var e,r,s,n,a={};if(this.entries[e]=a,a.sample_delta=t.readUint32(),a.subsamples=[],(n=t.readUint16())>0)for(r=0;r<n;r++){var o={};a.subsamples.push(o),1==this.version?o.size=t.readUint32():o.size=t.readUint16(),o.priority=t.readUint8(),o.discardable=t.readUint8(),o.codec_specific_parameters=t.readUint32()}}}),p.createFullBoxCtor("tenc","TrackEncryptionBox",function(t){if(t.readUint8(),0===this.version)t.readUint8();else{var e=t.readUint8();this.default_crypt_byte_block=e>>4&15,this.default_skip_byte_block=15&e}this.default_isProtected=t.readUint8(),this.default_Per_Sample_IV_Size=t.readUint8(),this.default_KID=p.parseHex16(t),1===this.default_isProtected&&0===this.default_Per_Sample_IV_Size&&(this.default_constant_IV_size=t.readUint8(),this.default_constant_IV=t.readUint8Array(this.default_constant_IV_size))}),p.createFullBoxCtor("tfdt","TrackFragmentBaseMediaDecodeTimeBox",function(t){1==this.version?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()}),p.createFullBoxCtor("tfhd","TrackFragmentHeaderBox",function(t){var e=0;this.track_id=t.readUint32(),this.size-this.hdr_size>e&&this.flags&p.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&this.flags&p.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&this.flags&p.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&this.flags&p.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&this.flags&p.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0}),p.createFullBoxCtor("tfra","TrackFragmentRandomAccessBox",function(t){this.track_ID=t.readUint32(),t.readUint24();var e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=3&e,this.entries=[];for(var r=t.readUint32(),s=0;s<r;s++)1===this.version?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()}),p.createFullBoxCtor("tkhd","TrackHeaderBox",function(t){1==this.version?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()}),p.createBoxCtor("tmax","hintmaxrelativetime",function(t){this.time=t.readUint32()}),p.createBoxCtor("tmin","hintminrelativetime",function(t){this.time=t.readUint32()}),p.createBoxCtor("totl","hintBytesSent",function(t){this.bytessent=t.readUint32()}),p.createBoxCtor("tpay","hintBytesSent",function(t){this.bytessent=t.readUint32()}),p.createBoxCtor("tpyl","hintBytesSent",function(t){this.bytessent=t.readUint64()}),p.TrackGroupTypeBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()},p.createTrackGroupCtor("msrc"),p.TrackReferenceTypeBox=function(t,e,r,s){p.Box.call(this,t,e),this.hdr_size=r,this.start=s},p.TrackReferenceTypeBox.prototype=new p.Box,p.TrackReferenceTypeBox.prototype.parse=function(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)},p.trefBox.prototype.parse=function(t){for(var e,r;t.getPosition()<this.start+this.size;){if((e=p.parseOneBox(t,!0,this.size-(t.getPosition()-this.start))).code!==p.OK)return;(r=new p.TrackReferenceTypeBox(e.type,e.size,e.hdr_size,e.start)).write===p.Box.prototype.write&&"mdat"!==r.type&&(n.info("BoxParser","TrackReference "+r.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),r.parseDataAndRewind(t)),r.parse(t),this.boxes.push(r)}},p.createFullBoxCtor("trep","TrackExtensionPropertiesBox",function(t){for(this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;){if((ret=p.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==p.OK)return;box=ret.box,this.boxes.push(box)}}),p.createFullBoxCtor("trex","TrackExtendsBox",function(t){this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()}),p.createBoxCtor("trpy","hintBytesSent",function(t){this.bytessent=t.readUint64()}),p.createFullBoxCtor("trun","TrackRunBox",function(t){var e=0;if(this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&this.flags&p.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&this.flags&p.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(var r=0;r<this.sample_count;r++)this.flags&p.TRUN_FLAGS_DURATION&&(this.sample_duration[r]=t.readUint32()),this.flags&p.TRUN_FLAGS_SIZE&&(this.sample_size[r]=t.readUint32()),this.flags&p.TRUN_FLAGS_FLAGS&&(this.sample_flags[r]=t.readUint32()),this.flags&p.TRUN_FLAGS_CTS_OFFSET&&(0===this.version?this.sample_composition_time_offset[r]=t.readUint32():this.sample_composition_time_offset[r]=t.readInt32())}),p.createFullBoxCtor("tsel","TrackSelectionBox",function(t){this.switch_group=t.readUint32();var e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var r=0;r<e;r++)this.attribute_list[r]=t.readUint32()}),p.createFullBoxCtor("txtC","TextConfigBox",function(t){this.config=t.readCString()}),p.createBoxCtor("tyco","TypeCombinationBox",function(t){var e=(this.size-this.hdr_size)/4;this.compatible_brands=[];for(var r=0;r<e;r++)this.compatible_brands[r]=t.readString(4)}),p.createFullBoxCtor("udes","UserDescriptionProperty",function(t){this.lang=t.readCString(),this.name=t.readCString(),this.description=t.readCString(),this.tags=t.readCString()}),p.createFullBoxCtor("uncC","UncompressedFrameConfigBox",function(t){var e;if(this.profile=t.readString(4),1==this.version);else if(0==this.version){for(e=0,this.component_count=t.readUint32(),this.component_index=[],this.component_bit_depth_minus_one=[],this.component_format=[],this.component_align_size=[];e<this.component_count;e++)this.component_index.push(t.readUint16()),this.component_bit_depth_minus_one.push(t.readUint8()),this.component_format.push(t.readUint8()),this.component_align_size.push(t.readUint8());this.sampling_type=t.readUint8(),this.interleave_type=t.readUint8(),this.block_size=t.readUint8();var r=t.readUint8();this.component_little_endian=r>>7&1,this.block_pad_lsb=r>>6&1,this.block_little_endian=r>>5&1,this.block_reversed=r>>4&1,this.pad_unknown=r>>3&1,this.pixel_size=t.readUint32(),this.row_align_size=t.readUint32(),this.tile_align_size=t.readUint32(),this.num_tile_cols_minus_one=t.readUint32(),this.num_tile_rows_minus_one=t.readUint32()}}),p.createFullBoxCtor("url ","DataEntryUrlBox",function(t){1!==this.flags&&(this.location=t.readCString())}),p.createFullBoxCtor("urn ","DataEntryUrnBox",function(t){this.name=t.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=t.readCString())}),p.createUUIDBox("a5d40b30e81411ddba2f0800200c9a66","LiveServerManifestBox",!0,!1,function(t){this.LiveServerManifest=t.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}),p.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3","PiffProtectionSystemSpecificHeaderBox",!0,!1,function(t){this.system_id=p.parseHex16(t);var e=t.readUint32();e>0&&(this.data=t.readUint8Array(e))}),p.createUUIDBox("a2394f525a9b4f14a2446c427c648df4","PiffSampleEncryptionBox",!0,!1),p.createUUIDBox("8974dbce7be74c5184f97148f9882554","PiffTrackEncryptionBox",!0,!1,function(t){this.default_AlgorithmID=t.readUint24(),this.default_IV_size=t.readUint8(),this.default_KID=p.parseHex16(t)}),p.createUUIDBox("d4807ef2ca3946958e5426cb9e46a79f","TfrfBox",!0,!1,function(t){this.fragment_count=t.readUint8(),this.entries=[];for(var e=0;e<this.fragment_count;e++){var r={},s=0,n=0;1===this.version?(s=t.readUint64(),n=t.readUint64()):(s=t.readUint32(),n=t.readUint32()),r.absolute_time=s,r.absolute_duration=n,this.entries.push(r)}}),p.createUUIDBox("6d1d9b0542d544e680e2141daff757b2","TfxdBox",!0,!1,function(t){1===this.version?(this.absolute_time=t.readUint64(),this.duration=t.readUint64()):(this.absolute_time=t.readUint32(),this.duration=t.readUint32())}),p.createFullBoxCtor("vmhd","VideoMediaHeaderBox",function(t){this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)}),p.createFullBoxCtor("vpcC","VPCodecConfigurationRecord",function(t){var e;1===this.version?(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4,this.chromaSubsampling=e>>1&7,this.videoFullRangeFlag=1&e,this.colourPrimaries=t.readUint8(),this.transferCharacteristics=t.readUint8(),this.matrixCoefficients=t.readUint8()):(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4&15,this.colorSpace=15&e,e=t.readUint8(),this.chromaSubsampling=e>>4&15,this.transferFunction=e>>1&7,this.videoFullRangeFlag=1&e),this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)}),p.createBoxCtor("vttC","WebVTTConfigurationBox",function(t){this.text=t.readString(this.size-this.hdr_size)}),p.createFullBoxCtor("vvcC","VvcConfigurationBox",function(t){var e,r,s={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(t){this.held_bits=t.readUint8(),this.num_held_bits=8},stream_read_2_bytes:function(t){this.held_bits=t.readUint16(),this.num_held_bits=16},extract_bits:function(t){var e=this.held_bits>>this.num_held_bits-t&(1<<t)-1;return this.num_held_bits-=t,e}};if(s.stream_read_1_bytes(t),s.extract_bits(5),this.lengthSizeMinusOne=s.extract_bits(2),this.ptl_present_flag=s.extract_bits(1),this.ptl_present_flag){if(s.stream_read_2_bytes(t),this.ols_idx=s.extract_bits(9),this.num_sublayers=s.extract_bits(3),this.constant_frame_rate=s.extract_bits(2),this.chroma_format_idc=s.extract_bits(2),s.stream_read_1_bytes(t),this.bit_depth_minus8=s.extract_bits(3),s.extract_bits(5),s.stream_read_2_bytes(t),s.extract_bits(2),this.num_bytes_constraint_info=s.extract_bits(6),this.general_profile_idc=s.extract_bits(7),this.general_tier_flag=s.extract_bits(1),this.general_level_idc=t.readUint8(),s.stream_read_1_bytes(t),this.ptl_frame_only_constraint_flag=s.extract_bits(1),this.ptl_multilayer_enabled_flag=s.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(e=0;e<this.num_bytes_constraint_info-1;e++){var n=s.extract_bits(6);s.stream_read_1_bytes(t);var a=s.extract_bits(2);this.general_constraint_info[e]=n<<2|a}this.general_constraint_info[this.num_bytes_constraint_info-1]=s.extract_bits(6)}else s.extract_bits(6);if(this.num_sublayers>1){for(s.stream_read_1_bytes(t),this.ptl_sublayer_present_mask=0,r=this.num_sublayers-2;r>=0;--r){var o=s.extract_bits(1);this.ptl_sublayer_present_mask|=o<<r}for(r=this.num_sublayers;r<=8&&this.num_sublayers>1;++r)s.extract_bits(1);for(this.sublayer_level_idc=[],r=this.num_sublayers-2;r>=0;--r)this.ptl_sublayer_present_mask&1<<r&&(this.sublayer_level_idc[r]=t.readUint8())}if(this.ptl_num_sub_profiles=t.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(e=0;e<this.ptl_num_sub_profiles;e++)this.general_sub_profile_idc.push(t.readUint32());this.max_picture_width=t.readUint16(),this.max_picture_height=t.readUint16(),this.avg_frame_rate=t.readUint16()}this.nalu_arrays=[];var h=t.readUint8();for(e=0;e<h;e++){var d=[];this.nalu_arrays.push(d),s.stream_read_1_bytes(t),d.completeness=s.extract_bits(1),s.extract_bits(2),d.nalu_type=s.extract_bits(5);var p=1;for(13!=d.nalu_type&&12!=d.nalu_type&&(p=t.readUint16()),r=0;r<p;r++){var l=t.readUint16();d.push({data:t.readUint8Array(l),length:l})}}}),p.createFullBoxCtor("vvnC","VvcNALUConfigBox",function(t){var e=strm.readUint8();this.lengthSizeMinusOne=3&e}),p.SampleEntry.prototype.isVideo=function(){return!1},p.SampleEntry.prototype.isAudio=function(){return!1},p.SampleEntry.prototype.isSubtitle=function(){return!1},p.SampleEntry.prototype.isMetadata=function(){return!1},p.SampleEntry.prototype.isHint=function(){return!1},p.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")},p.SampleEntry.prototype.getWidth=function(){return""},p.SampleEntry.prototype.getHeight=function(){return""},p.SampleEntry.prototype.getChannelCount=function(){return""},p.SampleEntry.prototype.getSampleRate=function(){return""},p.SampleEntry.prototype.getSampleSize=function(){return""},p.VisualSampleEntry.prototype.isVideo=function(){return!0},p.VisualSampleEntry.prototype.getWidth=function(){return this.width},p.VisualSampleEntry.prototype.getHeight=function(){return this.height},p.AudioSampleEntry.prototype.isAudio=function(){return!0},p.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count},p.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate},p.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize},p.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0},p.MetadataSampleEntry.prototype.isMetadata=function(){return!0},p.decimalToHex=function(t,e){var r=Number(t).toString(16);for(e=null==e?e=2:e;r.length<e;)r="0"+r;return r},p.avc1SampleEntry.prototype.getCodec=p.avc2SampleEntry.prototype.getCodec=p.avc3SampleEntry.prototype.getCodec=p.avc4SampleEntry.prototype.getCodec=function(){var t=p.SampleEntry.prototype.getCodec.call(this);return this.avcC?t+"."+p.decimalToHex(this.avcC.AVCProfileIndication)+p.decimalToHex(this.avcC.profile_compatibility)+p.decimalToHex(this.avcC.AVCLevelIndication):t},p.hev1SampleEntry.prototype.getCodec=p.hvc1SampleEntry.prototype.getCodec=function(){var t,e=p.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(e+=".",this.hvcC.general_profile_space){case 0:e+="";break;case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C"}e+=this.hvcC.general_profile_idc+".";var r=this.hvcC.general_profile_compatibility,s=0;for(t=0;t<32&&(s|=1&r,31!=t);t++)s<<=1,r>>=1;e+=p.decimalToHex(s,0)+".",0===this.hvcC.general_tier_flag?e+="L":e+="H",e+=this.hvcC.general_level_idc;var n=!1,a="";for(t=5;t>=0;t--)(this.hvcC.general_constraint_indicator[t]||n)&&(a="."+p.decimalToHex(this.hvcC.general_constraint_indicator[t],0)+a,n=!0);e+=a}return e},p.vvc1SampleEntry.prototype.getCodec=p.vvi1SampleEntry.prototype.getCodec=function(){var t=p.SampleEntry.prototype.getCodec.call(this);if(this.vvcC){t+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?t+=".H":t+=".L",t+=this.vvcC.general_level_idc;var e="";if(this.vvcC.general_constraint_info){var r,s,n,a=[];for(s=0,r=0|this.vvcC.ptl_frame_only_constraint<<7|this.vvcC.ptl_multilayer_enabled<<6;s<this.vvcC.general_constraint_info.length;++s)r|=this.vvcC.general_constraint_info[s]>>2&63,a.push(r),r&&(n=s),r=this.vvcC.general_constraint_info[s]>>2&3;if(void 0===n)e=".CA";else{e=".C";var o="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",h=0,d=0;for(s=0;s<=n;++s)for(h=h<<8|a[s],d+=8;d>=5;)e+=o[h>>d-5&31],d-=5,h&=(1<<d)-1;d&&(h<<=5-d,e+=o[31&h])}}t+=e}return t},p.mp4aSampleEntry.prototype.getCodec=function(){var t=p.SampleEntry.prototype.getCodec.call(this);if(!this.esds||!this.esds.esd)return t;var e=this.esds.esd.getOTI(),r=this.esds.esd.getAudioConfig();return t+"."+p.decimalToHex(e)+(r?"."+r:"")},p.stxtSampleEntry.prototype.getCodec=function(){var t=p.SampleEntry.prototype.getCodec.call(this);return this.mime_format?t+"."+this.mime_format:t},p.vp08SampleEntry.prototype.getCodec=p.vp09SampleEntry.prototype.getCodec=function(){var t=p.SampleEntry.prototype.getCodec.call(this),e=this.vpcC.level;0==e&&(e="00");var r=this.vpcC.bitDepth;return 8==r&&(r="08"),t+".0"+this.vpcC.profile+"."+e+"."+r},p.av01SampleEntry.prototype.getCodec=function(){var t,e=p.SampleEntry.prototype.getCodec.call(this),r=this.av1C.seq_level_idx_0;return r<10&&(r="0"+r),2===this.av1C.seq_profile&&1===this.av1C.high_bitdepth?t=1===this.av1C.twelve_bit?"12":"10":this.av1C.seq_profile<=2&&(t=1===this.av1C.high_bitdepth?"10":"08"),e+"."+this.av1C.seq_profile+"."+r+(this.av1C.seq_tier_0?"H":"M")+"."+t},p.Box.prototype.writeHeader=function(t,e){this.size+=8,this.size>4294967296&&(this.size+=8),"uuid"===this.type&&(this.size+=16),n.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.size>4294967296?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),"uuid"===this.type&&t.writeUint8Array(this.uuid),this.size>4294967296&&t.writeUint64(this.size)},p.FullBox.prototype.writeHeader=function(t){this.size+=4,p.Box.prototype.writeHeader.call(this,t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)},p.Box.prototype.write=function(t){"mdat"===this.type?this.data&&(this.size=this.data.length,this.writeHeader(t),t.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data))},p.ContainerBox.prototype.write=function(t){this.size=0,this.writeHeader(t);for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);n.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},p.TrackReferenceTypeBox.prototype.write=function(t){this.size=4*this.track_ids.length,this.writeHeader(t),t.writeUint32Array(this.track_ids)},p.avcCBox.prototype.write=function(t){var e;for(e=0,this.size=7;e<this.SPS.length;e++)this.size+=2+this.SPS[e].length;for(e=0;e<this.PPS.length;e++)this.size+=2+this.PPS[e].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224),e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e].nalu);for(t.writeUint8(this.PPS.length),e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e].nalu);this.ext&&t.writeUint8Array(this.ext)},p.co64Box.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])},p.cslgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=20,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)},p.cttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),1===this.version?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])},p.drefBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;n.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},p.elngBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)},p.elstBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var r=this.entries[e];t.writeUint32(r.segment_duration),t.writeInt32(r.media_time),t.writeInt16(r.media_rate_integer),t.writeInt16(r.media_rate_fraction)}},p.emsgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=16+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)},p.ftypBox.prototype.write=function(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,null,4),t.writeUint32(this.minor_version);for(var e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],null,4)},p.hdlrBox.prototype.write=function(t){this.size=20+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,null,4),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeCString(this.name)},p.hvcCBox.prototype.write=function(t){var e,r;for(e=0,this.size=23;e<this.nalu_arrays.length;e++)for(this.size+=3,r=0;r<this.nalu_arrays[e].length;r++)this.size+=2+this.nalu_arrays[e][r].data.length;for(this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8((this.general_profile_space<<6)+(this.general_tier_flag<<5)+this.general_profile_idc),t.writeUint32(this.general_profile_compatibility),t.writeUint8Array(this.general_constraint_indicator),t.writeUint8(this.general_level_idc),t.writeUint16(this.min_spatial_segmentation_idc+251658240),t.writeUint8(this.parallelismType+252),t.writeUint8(this.chroma_format_idc+252),t.writeUint8(this.bit_depth_luma_minus8+248),t.writeUint8(this.bit_depth_chroma_minus8+248),t.writeUint16(this.avgFrameRate),t.writeUint8((this.constantFrameRate<<6)+(this.numTemporalLayers<<3)+(this.temporalIdNested<<2)+this.lengthSizeMinusOne),t.writeUint8(this.nalu_arrays.length),e=0;e<this.nalu_arrays.length;e++)for(t.writeUint8((this.nalu_arrays[e].completeness<<7)+this.nalu_arrays[e].nalu_type),t.writeUint16(this.nalu_arrays[e].length),r=0;r<this.nalu_arrays[e].length;r++)t.writeUint16(this.nalu_arrays[e][r].data.length),t.writeUint8Array(this.nalu_arrays[e][r].data)},p.kindBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(t),t.writeCString(this.schemeURI),t.writeCString(this.value)},p.mdhdBox.prototype.write=function(t){this.size=20,this.flags=0,this.version=0,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint16(this.language),t.writeUint16(0)},p.mehdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.fragment_duration)},p.mfhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)},p.mvhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=96,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)},p.SampleEntry.prototype.writeHeader=function(t){this.size=8,p.Box.prototype.writeHeader.call(this,t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)},p.SampleEntry.prototype.writeFooter=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;n.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},p.SampleEntry.prototype.write=function(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,n.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},p.VisualSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=70,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,null,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)},p.AudioSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=20,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)},p.stppSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)},p.SampleGroupEntry.prototype.write=function(t){t.writeUint8Array(this.data)},p.sbgpBox.prototype.write=function(t){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(t),t.writeString(this.grouping_type,null,4),t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var r=this.entries[e];t.writeInt32(r.sample_count),t.writeInt32(r.group_description_index)}},p.sgpdBox.prototype.write=function(t){var e,r;for(e=0,this.flags=0,this.size=12;e<this.entries.length;e++)r=this.entries[e],1===this.version&&(0===this.default_length&&(this.size+=4),this.size+=r.data.length);for(this.writeHeader(t),t.writeString(this.grouping_type,null,4),1===this.version&&t.writeUint32(this.default_length),this.version>=2&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length),e=0;e<this.entries.length;e++)r=this.entries[e],1===this.version&&0===this.default_length&&t.writeUint32(r.description_length),r.write(t)},p.sidxBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=20+12*this.references.length,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset),t.writeUint16(0),t.writeUint16(this.references.length);for(var e=0;e<this.references.length;e++){var r=this.references[e];t.writeUint32(r.reference_type<<31|r.referenced_size),t.writeUint32(r.subsegment_duration),t.writeUint32(r.starts_with_SAP<<31|r.SAP_type<<28|r.SAP_delta_time)}},p.smhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=4,this.writeHeader(t),t.writeUint16(this.balance),t.writeUint16(0)},p.stcoBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)},p.stscBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length),e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])},p.stsdBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4,e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;n.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},p.stshBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length),e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])},p.stssBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)},p.stszBox.prototype.write=function(t){var e,r=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(e=0;e+1<this.sample_sizes.length;){if(this.sample_sizes[e+1]!==this.sample_sizes[0]){r=!1;break}e++}else r=!1;this.size=8,r||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),r?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),r||t.writeUint32Array(this.sample_sizes)},p.sttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])},p.tfdtBox.prototype.write=function(t){this.version=this.baseMediaDecodeTime>4294967295?1:0,this.flags=0,this.size=4,1===this.version&&(this.size+=4),this.writeHeader(t),1===this.version?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)},p.tfhdBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&p.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&p.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&p.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&p.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&p.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),this.flags&p.TFHD_FLAG_BASE_DATA_OFFSET&&t.writeUint64(this.base_data_offset),this.flags&p.TFHD_FLAG_SAMPLE_DESC&&t.writeUint32(this.default_sample_description_index),this.flags&p.TFHD_FLAG_SAMPLE_DUR&&t.writeUint32(this.default_sample_duration),this.flags&p.TFHD_FLAG_SAMPLE_SIZE&&t.writeUint32(this.default_sample_size),this.flags&p.TFHD_FLAG_SAMPLE_FLAGS&&t.writeUint32(this.default_sample_flags)},p.tkhdBox.prototype.write=function(t){this.version=0,this.size=80,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration),t.writeUint32(0),t.writeUint32(0),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeUint16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)},p.trexBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=20,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)},p.trunBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&p.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&p.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&p.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&p.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&p.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&p.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),this.flags&p.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),this.flags&p.TRUN_FLAGS_FIRST_FLAG&&t.writeUint32(this.first_sample_flags);for(var e=0;e<this.sample_count;e++)this.flags&p.TRUN_FLAGS_DURATION&&t.writeUint32(this.sample_duration[e]),this.flags&p.TRUN_FLAGS_SIZE&&t.writeUint32(this.sample_size[e]),this.flags&p.TRUN_FLAGS_FLAGS&&t.writeUint32(this.sample_flags[e]),this.flags&p.TRUN_FLAGS_CTS_OFFSET&&(0===this.version?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))},p["url Box"].prototype.write=function(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)},p["urn Box"].prototype.write=function(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)},p.vmhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)},p.cttsBox.prototype.unpack=function(t){var e,r,s;for(e=0,s=0;e<this.sample_counts.length;e++)for(r=0;r<this.sample_counts[e];r++)t[s].pts=t[s].dts+this.sample_offsets[e],s++},p.sttsBox.prototype.unpack=function(t){var e,r,s;for(e=0,s=0;e<this.sample_counts.length;e++)for(r=0;r<this.sample_counts[e];r++)0===s?t[s].dts=0:t[s].dts=t[s-1].dts+this.sample_deltas[e],s++},p.stcoBox.prototype.unpack=function(t){var e;for(e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]},p.stscBox.prototype.unpack=function(t){var e,r,s,n,a;for(e=0,n=0,a=0;e<this.first_chunk.length;e++)for(r=0;r<(e+1<this.first_chunk.length?this.first_chunk[e+1]:1/0);r++)for(a++,s=0;s<this.samples_per_chunk[e];s++){if(!t[n])return;t[n].description_index=this.sample_description_index[e],t[n].chunk_index=a,n++}},p.stszBox.prototype.unpack=function(t){var e;for(e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]},p.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],p.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"],p.boxEqualFields=function(t,e){var r;if(t&&!e)return!1;for(r in t)if(!(p.DIFF_BOXES_PROP_NAMES.indexOf(r)>-1)){if(t[r]instanceof p.Box||e[r]instanceof p.Box)continue;if(void 0===t[r]||void 0===e[r]||"function"==typeof t[r]||"function"==typeof e[r]||t.subBoxNames&&t.subBoxNames.indexOf(r.slice(0,4))>-1||e.subBoxNames&&e.subBoxNames.indexOf(r.slice(0,4))>-1||"data"===r||"start"===r||"size"===r||"creation_time"===r||"modification_time"===r||p.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(r)>-1)continue;if(t[r]!==e[r])return!1}return!0},p.boxEqual=function(t,e){if(!p.boxEqualFields(t,e))return!1;for(var r=0;r<p.DIFF_BOXES_PROP_NAMES.length;r++){var s=p.DIFF_BOXES_PROP_NAMES[r];if(t[s]&&e[s]&&!p.boxEqual(t[s],e[s]))return!1}return!0};var _=function(){};_.prototype.parseSample=function(t){var e,r,s=new a(t.buffer);for(e=[];!s.isEos();)(r=p.parseOneBox(s,!1)).code===p.OK&&"vttc"===r.box.type&&e.push(r.box);return e},_.prototype.getText=function(t,e,r){function s(t,e,r){return r=r||"0",(t+="").length>=e?t:Array(e-t.length+1).join(r)+t}function n(t){var e=Math.floor(t/3600),r=Math.floor((t-3600*e)/60),n=Math.floor(t-3600*e-60*r);return""+s(e,2)+":"+s(r,2)+":"+s(n,2)+"."+s(Math.floor((t-3600*e-60*r-n)*1e3),3)}for(var a=this.parseSample(r),o="",h=0;h<a.length;h++){var d=a[h];o+=n(t)+" --> "+n(e)+"\r\n"+d.payl.text}return o};var c=function(){};c.prototype.parseSample=function(t){var e,r={};r.resources=[];var s=new a(t.data.buffer);if(t.subsamples&&0!==t.subsamples.length){if(r.documentString=s.readString(t.subsamples[0].size),t.subsamples.length>1)for(e=1;e<t.subsamples.length;e++)r.resources[e]=s.readUint8Array(t.subsamples[e].size)}else r.documentString=s.readString(t.data.length);return"undefined"!=typeof DOMParser&&(r.document=new DOMParser().parseFromString(r.documentString,"application/xml")),r};var m=function(){};m.prototype.parseSample=function(t){return new a(t.data.buffer).readString(t.data.length)},m.prototype.parseConfig=function(t){var e=new a(t.buffer);return e.readUint32(),e.readCString()},e.VTTin4Parser=_,e.XMLSubtitlein4Parser=c,e.Textin4Parser=m;var g=function(t){this.stream=t||new h,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.items=[],this.entity_groups=[],this.onSidx=null,this.sidxSent=!1};g.prototype.setSegmentOptions=function(t,e,r){var s=this.getTrackById(t);if(s){var n={};this.fragmentedTracks.push(n),n.id=t,n.user=e,n.trak=s,s.nextSample=0,n.segmentStream=null,n.nb_samples=1e3,n.rapAlignement=!0,r&&(r.nbSamples&&(n.nb_samples=r.nbSamples),r.rapAlignement&&(n.rapAlignement=r.rapAlignement))}},g.prototype.unsetSegmentOptions=function(t){for(var e=-1,r=0;r<this.fragmentedTracks.length;r++)this.fragmentedTracks[r].id==t&&(e=r);e>-1&&this.fragmentedTracks.splice(e,1)},g.prototype.setExtractionOptions=function(t,e,r){var s=this.getTrackById(t);if(s){var n={};this.extractedTracks.push(n),n.id=t,n.user=e,n.trak=s,s.nextSample=0,n.nb_samples=1e3,n.samples=[],r&&r.nbSamples&&(n.nb_samples=r.nbSamples)}},g.prototype.unsetExtractionOptions=function(t){for(var e=-1,r=0;r<this.extractedTracks.length;r++)this.extractedTracks[r].id==t&&(e=r);e>-1&&this.extractedTracks.splice(e,1)},g.prototype.parse=function(){var t,e,r;if(!this.restoreParsePosition||this.restoreParsePosition())for(;;){if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}if(this.saveParsePosition&&this.saveParsePosition(),(t=p.parseOneBox(this.stream,!1)).code===p.ERR_NOT_ENOUGH_DATA){if(!this.processIncompleteBox)return;if(this.processIncompleteBox(t))continue;return}switch(r="uuid"!==(e=t.box).type?e.type:e.uuid,this.boxes.push(e),r){case"mdat":this.mdats.push(e);break;case"moof":this.moofs.push(e);break;case"moov":this.moovStartFound=!0,0===this.mdats.length&&(this.isProgressive=!0);default:void 0!==this[r]&&n.warn("ISOFile","Duplicate Box of type: "+r+", overriding previous occurrence"),this[r]=e}this.updateUsedBytes&&this.updateUsedBytes(e,t)}},g.prototype.checkBuffer=function(t){if(null==t)throw"Buffer must be defined and non empty";if(void 0===t.fileStart)throw"Buffer must have a fileStart property";return 0===t.byteLength?(n.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(n.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),!!this.stream.initialized()||(n.warn("ISOFile","Not ready to start parsing"),!1))},g.prototype.appendBuffer=function(t,e){var r;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(r=this.nextSeekPosition,this.nextSeekPosition=void 0):r=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(r=this.stream.getEndFilePositionAfter(r))):r=this.nextParsePosition?this.nextParsePosition:0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(n.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+r),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),n.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),r},g.prototype.getInfo=function(){var t,e,r,s,n,a,o={},h=new Date("1904-01-01T00:00:00Z").getTime();if(this.moov)for(o.hasMoov=!0,o.duration=this.moov.mvhd.duration,o.timescale=this.moov.mvhd.timescale,o.isFragmented=null!=this.moov.mvex,o.isFragmented&&this.moov.mvex.mehd&&(o.fragment_duration=this.moov.mvex.mehd.fragment_duration),o.isProgressive=this.isProgressive,o.hasIOD=null!=this.moov.iods,o.brands=[],o.brands.push(this.ftyp.major_brand),o.brands=o.brands.concat(this.ftyp.compatible_brands),o.created=new Date(h+1e3*this.moov.mvhd.creation_time),o.modified=new Date(h+1e3*this.moov.mvhd.modification_time),o.tracks=[],o.audioTracks=[],o.videoTracks=[],o.subtitleTracks=[],o.metadataTracks=[],o.hintTracks=[],o.otherTracks=[],t=0;t<this.moov.traks.length;t++){if(a=(r=this.moov.traks[t]).mdia.minf.stbl.stsd.entries[0],s={},o.tracks.push(s),s.id=r.tkhd.track_id,s.name=r.mdia.hdlr.name,s.references=[],r.tref)for(e=0;e<r.tref.boxes.length;e++)n={},s.references.push(n),n.type=r.tref.boxes[e].type,n.track_ids=r.tref.boxes[e].track_ids;r.edts&&(s.edits=r.edts.elst.entries),s.created=new Date(h+1e3*r.tkhd.creation_time),s.modified=new Date(h+1e3*r.tkhd.modification_time),s.movie_duration=r.tkhd.duration,s.movie_timescale=o.timescale,s.layer=r.tkhd.layer,s.alternate_group=r.tkhd.alternate_group,s.volume=r.tkhd.volume,s.matrix=r.tkhd.matrix,s.track_width=r.tkhd.width/65536,s.track_height=r.tkhd.height/65536,s.timescale=r.mdia.mdhd.timescale,s.cts_shift=r.mdia.minf.stbl.cslg,s.duration=r.mdia.mdhd.duration,s.samples_duration=r.samples_duration,s.codec=a.getCodec(),s.kind=r.udta&&r.udta.kinds.length?r.udta.kinds[0]:{schemeURI:"",value:""},s.language=r.mdia.elng?r.mdia.elng.extended_language:r.mdia.mdhd.languageString,s.nb_samples=r.samples.length,s.size=r.samples_size,s.bitrate=8*s.size*s.timescale/s.samples_duration,a.isAudio()?(s.type="audio",o.audioTracks.push(s),s.audio={},s.audio.sample_rate=a.getSampleRate(),s.audio.channel_count=a.getChannelCount(),s.audio.sample_size=a.getSampleSize()):a.isVideo()?(s.type="video",o.videoTracks.push(s),s.video={},s.video.width=a.getWidth(),s.video.height=a.getHeight()):a.isSubtitle()?(s.type="subtitles",o.subtitleTracks.push(s)):a.isHint()?(s.type="metadata",o.hintTracks.push(s)):a.isMetadata()?(s.type="metadata",o.metadataTracks.push(s)):(s.type="metadata",o.otherTracks.push(s))}else o.hasMoov=!1;if(o.mime="",o.hasMoov&&o.tracks){for(o.videoTracks&&o.videoTracks.length>0?o.mime+='video/mp4; codecs="':o.audioTracks&&o.audioTracks.length>0?o.mime+='audio/mp4; codecs="':o.mime+='application/mp4; codecs="',t=0;t<o.tracks.length;t++)0!==t&&(o.mime+=","),o.mime+=o.tracks[t].codec;o.mime+='"; profiles="',o.mime+=this.ftyp.compatible_brands.join(),o.mime+='"'}return o},g.prototype.setNextSeekPositionFromSample=function(t){t&&(this.nextSeekPosition?this.nextSeekPosition=Math.min(t.offset+t.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=t.offset+t.alreadyRead)},g.prototype.processSamples=function(t){if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&null!==this.onSegment)for(e=0;e<this.fragmentedTracks.length;e++){var e,r,s=this.fragmentedTracks[e];for(r=s.trak;r.nextSample<r.samples.length&&this.sampleProcessingStarted;){n.debug("ISOFile","Creating media fragment on track #"+s.id+" for sample "+r.nextSample);var a=this.createFragment(s.id,r.nextSample,s.segmentStream);if(a)s.segmentStream=a,r.nextSample++;else break;if((r.nextSample%s.nb_samples==0||t||r.nextSample>=r.samples.length)&&(n.info("ISOFile","Sending fragmented data on track #"+s.id+" for samples ["+Math.max(0,r.nextSample-s.nb_samples)+","+(r.nextSample-1)+"]"),n.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(s.id,s.user,s.segmentStream.buffer,r.nextSample,t||r.nextSample>=r.samples.length),s.segmentStream=null,s!==this.fragmentedTracks[e]))break}}if(null!==this.onSamples)for(e=0;e<this.extractedTracks.length;e++){var o=this.extractedTracks[e];for(r=o.trak;r.nextSample<r.samples.length&&this.sampleProcessingStarted;){n.debug("ISOFile","Exporting on track #"+o.id+" sample #"+r.nextSample);var h=this.getSample(r,r.nextSample);if(h)r.nextSample++,o.samples.push(h);else{this.setNextSeekPositionFromSample(r.samples[r.nextSample]);break}if((r.nextSample%o.nb_samples==0||r.nextSample>=r.samples.length)&&(n.debug("ISOFile","Sending samples on track #"+o.id+" for sample "+r.nextSample),this.onSamples&&this.onSamples(o.id,o.user,o.samples),o.samples=[],o!==this.extractedTracks[e]))break}}}},g.prototype.getBox=function(t){var e=this.getBoxes(t,!0);return e.length?e[0]:null},g.prototype.getBoxes=function(t,e){var r=[];return g._sweep.call(this,t,r,e),r},g._sweep=function(t,e,r){for(var s in this.type&&this.type==t&&e.push(this),this.boxes){if(e.length&&r)return;g._sweep.call(this.boxes[s],t,e,r)}},g.prototype.getTrackSamplesInfo=function(t){var e=this.getTrackById(t);return e?e.samples:void 0},g.prototype.getTrackSample=function(t,e){var r=this.getTrackById(t);return this.getSample(r,e)},g.prototype.releaseUsedSamples=function(t,e){var r=0,s=this.getTrackById(t);s.lastValidSample||(s.lastValidSample=0);for(var a=s.lastValidSample;a<e;a++)r+=this.releaseSample(s,a);n.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+r+", remaining: "+this.samplesDataSize+")"),s.lastValidSample=e},g.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)},g.prototype.stop=function(){this.sampleProcessingStarted=!1},g.prototype.flush=function(){n.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)},g.prototype.seekTrack=function(t,e,r){var s,a,o,h=1/0,d=0,p=0;if(0===r.samples.length)return n.info("ISOFile","No sample in track, cannot seek! Using time "+n.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(s=0;s<r.samples.length;s++){if(a=r.samples[s],0===s)p=0,o=a.timescale;else if(a.cts>t*a.timescale){p=s-1;break}e&&a.is_sync&&(d=s)}for(e&&(p=d),t=r.samples[p].cts,r.nextSample=p;r.samples[p].alreadyRead===r.samples[p].size&&r.samples[p+1];)p++;return h=r.samples[p].offset+r.samples[p].alreadyRead,n.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+r.nextSample+" on track "+r.tkhd.track_id+", time "+n.getDurationString(t,o)+" and offset: "+h),{offset:h,time:t/o}},g.prototype.getTrackDuration=function(t){var e;return t.samples?((e=t.samples[t.samples.length-1]).cts+e.duration)/e.timescale:1/0},g.prototype.seek=function(t,e){var r,s,a,o=this.moov,h={offset:1/0,time:1/0};if(this.moov){for(a=0;a<o.traks.length;a++)r=o.traks[a],!(t>this.getTrackDuration(r))&&((s=this.seekTrack(t,e,r)).offset<h.offset&&(h.offset=s.offset),s.time<h.time&&(h.time=s.time));return n.info("ISOFile","Seeking at time "+n.getDurationString(h.time,1)+" needs a buffer with a fileStart position of "+h.offset),h.offset===1/0?h={offset:this.nextParsePosition,time:0}:h.offset=this.stream.getEndFilePositionAfter(h.offset),n.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+h.offset),h}throw"Cannot seek: moov not received!"},g.prototype.equal=function(t){for(var e=0;e<this.boxes.length&&e<t.boxes.length;){var r=this.boxes[e],s=t.boxes[e];if(!p.boxEqual(r,s))return!1;e++}return!0},e.ISOFile=g,g.prototype.lastBoxStartPosition=0,g.prototype.parsingMdat=null,g.prototype.nextParsePosition=0,g.prototype.discardMdatData=!1,g.prototype.processIncompleteBox=function(t){var e;return"mdat"===t.type?(e=new p[t.type+"Box"](t.size),this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,this.stream.seek(e.start+e.size,!1,this.discardMdatData))?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1):("moov"===t.type&&(this.moovStartFound=!0,0===this.mdats.length&&(this.isProgressive=!0)),this.stream.mergeNextBuffer&&this.stream.mergeNextBuffer())?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1)},g.prototype.hasIncompleteMdat=function(){return null!==this.parsingMdat},g.prototype.processIncompleteMdat=function(){var t;return(t=this.parsingMdat,this.stream.seek(t.start+t.size,!1,this.discardMdatData))?(n.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)},g.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)},g.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()},g.prototype.updateUsedBytes=function(t,e){this.stream.addUsedBytes&&("mdat"===t.type?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))},g.prototype.add=p.Box.prototype.add,g.prototype.addBox=p.Box.prototype.addBox,g.prototype.init=function(t){var e=t||{};this.add("ftyp").set("major_brand",e.brands&&e.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",e.brands||["iso4"]);var r=this.add("moov");return r.add("mvhd").set("timescale",e.timescale||600).set("rate",e.rate||65536).set("creation_time",0).set("modification_time",0).set("duration",e.duration||0).set("volume",e.width?0:256).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("next_track_id",1),r.add("mvex"),this},g.prototype.addTrack=function(t){this.moov||this.init(t);var e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";var r=this.moov.add("trak");this.moov.mvhd.next_track_id=e.id+1,r.add("tkhd").set("flags",p.TKHD_FLAG_ENABLED|p.TKHD_FLAG_IN_MOVIE|p.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",e.id).set("duration",e.duration||0).set("layer",e.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("width",e.width<<16).set("height",e.height<<16);var s=r.add("mdia");s.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",e.timescale||1).set("duration",e.media_duration||0).set("language",e.language||"und"),s.add("hdlr").set("handler",e.hdlr||"vide").set("name",e.name||"Track created with MP4Box.js"),s.add("elng").set("extended_language",e.language||"fr-FR");var n=s.add("minf");if(void 0!==p[e.type+"SampleEntry"]){var o=new p[e.type+"SampleEntry"];o.data_reference_index=1;var h="";for(var d in p.sampleEntryCodes)for(var l=p.sampleEntryCodes[d],f=0;f<l.length;f++)if(l.indexOf(e.type)>-1){h=d;break}switch(h){case"Visual":if(n.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),o.set("width",e.width).set("height",e.height).set("horizresolution",4718592).set("vertresolution",4718592).set("frame_count",1).set("compressorname",e.type+" Compressor").set("depth",24),e.avcDecoderConfigRecord){var u=new p.avcCBox;u.parse(new a(e.avcDecoderConfigRecord)),o.addBox(u)}else if(e.hevcDecoderConfigRecord){var _=new p.hvcCBox;_.parse(new a(e.hevcDecoderConfigRecord)),o.addBox(_)}break;case"Audio":n.add("smhd").set("balance",e.balance||0),o.set("channel_count",e.channel_count||2).set("samplesize",e.samplesize||16).set("samplerate",e.samplerate||65536);break;case"Hint":n.add("hmhd");break;case"Subtitle":n.add("sthd"),"stpp"===e.type&&o.set("namespace",e.namespace||"nonamespace").set("schema_location",e.schema_location||"").set("auxiliary_mime_types",e.auxiliary_mime_types||"");break;default:n.add("nmhd")}e.description&&o.addBox(e.description),e.description_boxes&&e.description_boxes.forEach(function(t){o.addBox(t)}),n.add("dinf").add("dref").addEntry(new p["url Box"]().set("flags",1));var c=n.add("stbl");return c.add("stsd").addEntry(o),c.add("stts").set("sample_counts",[]).set("sample_deltas",[]),c.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),c.add("stco").set("chunk_offsets",[]),c.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",e.id).set("default_sample_description_index",e.default_sample_description_index||1).set("default_sample_duration",e.default_sample_duration||0).set("default_sample_size",e.default_sample_size||0).set("default_sample_flags",e.default_sample_flags||0),this.buildTrakSampleLists(r),e.id}},p.Box.prototype.computeSize=function(t){var e=t||new o;e.endianness=o.BIG_ENDIAN,this.write(e)},g.prototype.addSample=function(t,e,r){var s=r||{},n={},a=this.getTrackById(t);if(null!==a){n.number=a.samples.length,n.track_id=a.tkhd.track_id,n.timescale=a.mdia.mdhd.timescale,n.description_index=s.sample_description_index?s.sample_description_index-1:0,n.description=a.mdia.minf.stbl.stsd.entries[n.description_index],n.data=e,n.size=e.byteLength,n.alreadyRead=n.size,n.duration=s.duration||1,n.cts=s.cts||0,n.dts=s.dts||0,n.is_sync=s.is_sync||!1,n.is_leading=s.is_leading||0,n.depends_on=s.depends_on||0,n.is_depended_on=s.is_depended_on||0,n.has_redundancy=s.has_redundancy||0,n.degradation_priority=s.degradation_priority||0,n.offset=0,n.subsamples=s.subsamples,a.samples.push(n),a.samples_size+=n.size,a.samples_duration+=n.duration,void 0===a.first_dts&&(a.first_dts=s.dts),this.processSamples();var o=this.createSingleSampleMoof(n);return this.addBox(o),o.computeSize(),o.trafs[0].truns[0].data_offset=o.size+8,this.add("mdat").data=new Uint8Array(e),n}},g.prototype.createSingleSampleMoof=function(t){var e=0;e=t.is_sync?33554432:65536;var r=new p.moofBox;r.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var s=r.add("traf"),n=this.getTrackById(t.track_id);return s.add("tfhd").set("track_id",t.track_id).set("flags",p.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),s.add("tfdt").set("baseMediaDecodeTime",t.dts-(n.first_dts||0)),s.add("trun").set("flags",p.TRUN_FLAGS_DATA_OFFSET|p.TRUN_FLAGS_DURATION|p.TRUN_FLAGS_SIZE|p.TRUN_FLAGS_FLAGS|p.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[t.duration]).set("sample_size",[t.size]).set("sample_flags",[e]).set("sample_composition_time_offset",[t.cts-t.dts]),r},g.prototype.lastMoofIndex=0,g.prototype.samplesDataSize=0,g.prototype.resetTables=function(){for(t=0,this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0;t<this.moov.traks.length;t++){(e=this.moov.traks[t]).tkhd.duration=0,e.mdia.mdhd.duration=0,(e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64).chunk_offsets=[],(r=e.mdia.minf.stbl.stsc).first_chunk=[],r.samples_per_chunk=[],r.sample_description_index=[],(e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2).sample_sizes=[],(s=e.mdia.minf.stbl.stts).sample_counts=[],s.sample_deltas=[],(n=e.mdia.minf.stbl.ctts)&&(n.sample_counts=[],n.sample_offsets=[]),a=e.mdia.minf.stbl.stss;var t,e,r,s,n,a,o=e.mdia.minf.stbl.boxes.indexOf(a);-1!=o&&(e.mdia.minf.stbl.boxes[o]=null)}},g.initSampleGroups=function(t,e,r,s,n){var a,o,h,d;function p(t,e,r){this.grouping_type=t,this.grouping_type_parameter=e,this.sbgp=r,this.last_sample_in_run=-1,this.entry_index=-1}for(e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]),o=0;o<r.length;o++){for(d=r[o].grouping_type+"/"+r[o].grouping_type_parameter,h=new p(r[o].grouping_type,r[o].grouping_type_parameter,r[o]),e&&(e.sample_groups_info[d]=h),t.sample_groups_info[d]||(t.sample_groups_info[d]=h),a=0;a<s.length;a++)s[a].grouping_type===r[o].grouping_type&&(h.description=s[a],h.description.used=!0);if(n)for(a=0;a<n.length;a++)n[a].grouping_type===r[o].grouping_type&&(h.fragment_description=n[a],h.fragment_description.used=!0,h.is_fragment=!0)}if(e){if(n)for(o=0;o<n.length;o++)n[o].used||!(n[o].version>=2)||(d=n[o].grouping_type+"/0",(h=new p(n[o].grouping_type,0)).is_fragment=!0,e.sample_groups_info[d]||(e.sample_groups_info[d]=h))}else for(o=0;o<s.length;o++)s[o].used||!(s[o].version>=2)||(d=s[o].grouping_type+"/0",h=new p(s[o].grouping_type,0),t.sample_groups_info[d]||(t.sample_groups_info[d]=h))},g.setSampleGroupProperties=function(t,e,r,s){var n,a,o;for(n in e.sample_groups=[],s)e.sample_groups[n]={},e.sample_groups[n].grouping_type=s[n].grouping_type,e.sample_groups[n].grouping_type_parameter=s[n].grouping_type_parameter,r>=s[n].last_sample_in_run&&(s[n].last_sample_in_run<0&&(s[n].last_sample_in_run=0),s[n].entry_index++,s[n].entry_index<=s[n].sbgp.entries.length-1&&(s[n].last_sample_in_run+=s[n].sbgp.entries[s[n].entry_index].sample_count)),s[n].entry_index<=s[n].sbgp.entries.length-1?e.sample_groups[n].group_description_index=s[n].sbgp.entries[s[n].entry_index].group_description_index:e.sample_groups[n].group_description_index=-1,0!==e.sample_groups[n].group_description_index&&(o=s[n].fragment_description?s[n].fragment_description:s[n].description,e.sample_groups[n].group_description_index>0?(a=e.sample_groups[n].group_description_index>65535?(e.sample_groups[n].group_description_index>>16)-1:e.sample_groups[n].group_description_index-1,o&&a>=0&&(e.sample_groups[n].description=o.entries[a])):o&&o.version>=2&&o.default_group_description_index>0&&(e.sample_groups[n].description=o.entries[o.default_group_description_index-1]))},g.process_sdtp=function(t,e,r){e&&(t?(e.is_leading=t.is_leading[r],e.depends_on=t.sample_depends_on[r],e.is_depended_on=t.sample_is_depended_on[r],e.has_redundancy=t.sample_has_redundancy[r]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))},g.prototype.buildSampleLists=function(){var t,e;for(t=0;t<this.moov.traks.length;t++)e=this.moov.traks[t],this.buildTrakSampleLists(e)},g.prototype.buildTrakSampleLists=function(t){if(t.samples=[],t.samples_duration=0,t.samples_size=0,r=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,s=t.mdia.minf.stbl.stsc,n=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,a=t.mdia.minf.stbl.stts,o=t.mdia.minf.stbl.ctts,h=t.mdia.minf.stbl.stss,d=t.mdia.minf.stbl.stsd,p=t.mdia.minf.stbl.subs,u=t.mdia.minf.stbl.stdp,l=t.mdia.minf.stbl.sbgps,f=t.mdia.minf.stbl.sgpds,S=-1,U=-1,b=-1,v=-1,w=0,B=0,E=0,g.initSampleGroups(t,null,l,f),void 0!==n){for(e=0;e<n.sample_sizes.length;e++){var e,r,s,n,a,o,h,d,p,l,f,u,_,c,m,y,x,S,U,b,v,w,B,E,A={};A.number=e,A.track_id=t.tkhd.track_id,A.timescale=t.mdia.mdhd.timescale,A.alreadyRead=0,t.samples[e]=A,A.size=n.sample_sizes[e],t.samples_size+=A.size,0===e?(c=1,_=0,A.chunk_index=c,A.chunk_run_index=_,x=s.samples_per_chunk[_],y=0,m=_+1<s.first_chunk.length?s.first_chunk[_+1]-1:1/0):e<x?(A.chunk_index=c,A.chunk_run_index=_):(c++,A.chunk_index=c,y=0,c<=m||(m=++_+1<s.first_chunk.length?s.first_chunk[_+1]-1:1/0),A.chunk_run_index=_,x+=s.samples_per_chunk[_]),A.description_index=s.sample_description_index[A.chunk_run_index]-1,A.description=d.entries[A.description_index],A.offset=r.chunk_offsets[A.chunk_index-1]+y,y+=A.size,e>S&&(U++,S<0&&(S=0),S+=a.sample_counts[U]),e>0?(t.samples[e-1].duration=a.sample_deltas[U],t.samples_duration+=t.samples[e-1].duration,A.dts=t.samples[e-1].dts+t.samples[e-1].duration):A.dts=0,o?(e>=b&&(v++,b<0&&(b=0),b+=o.sample_counts[v]),A.cts=t.samples[e].dts+o.sample_offsets[v]):A.cts=A.dts,h?(e==h.sample_numbers[w]-1?(A.is_sync=!0,w++):(A.is_sync=!1,A.degradation_priority=0),p&&p.entries[B].sample_delta+E==e+1&&(A.subsamples=p.entries[B].subsamples,E+=p.entries[B].sample_delta,B++)):A.is_sync=!0,g.process_sdtp(t.mdia.minf.stbl.sdtp,A,A.number),u?A.degradation_priority=u.priority[e]:A.degradation_priority=0,p&&p.entries[B].sample_delta+E==e&&(A.subsamples=p.entries[B].subsamples,E+=p.entries[B].sample_delta),(l.length>0||f.length>0)&&g.setSampleGroupProperties(t,A,e,t.sample_groups_info)}e>0&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}},g.prototype.updateSampleLists=function(){if(void 0!==this.moov){for(;this.lastMoofIndex<this.moofs.length;)if(d=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,"moof"==d.type)for(t=0;t<d.trafs.length;t++){for(l=d.trafs[t],f=this.getTrackById(l.tfhd.track_id),u=this.getTrexById(l.tfhd.track_id),s=l.tfhd.flags&p.TFHD_FLAG_SAMPLE_DESC?l.tfhd.default_sample_description_index:u?u.default_sample_description_index:1,n=l.tfhd.flags&p.TFHD_FLAG_SAMPLE_DUR?l.tfhd.default_sample_duration:u?u.default_sample_duration:0,a=l.tfhd.flags&p.TFHD_FLAG_SAMPLE_SIZE?l.tfhd.default_sample_size:u?u.default_sample_size:0,o=l.tfhd.flags&p.TFHD_FLAG_SAMPLE_FLAGS?l.tfhd.default_sample_flags:u?u.default_sample_flags:0,l.sample_number=0,l.sbgps.length>0&&g.initSampleGroups(f,l,l.sbgps,f.mdia.minf.stbl.sgpds,l.sgpds),e=0;e<l.truns.length;e++){var t,e,r,s,n,a,o,h,d,l,f,u,_,c,m=l.truns[e];for(r=0;r<m.sample_count;r++){(_={}).moof_number=this.lastMoofIndex,_.number_in_traf=l.sample_number,l.sample_number++,_.number=f.samples.length,l.first_sample_index=f.samples.length,f.samples.push(_),_.track_id=f.tkhd.track_id,_.timescale=f.mdia.mdhd.timescale,_.description_index=s-1,_.description=f.mdia.minf.stbl.stsd.entries[_.description_index],_.size=a,m.flags&p.TRUN_FLAGS_SIZE&&(_.size=m.sample_size[r]),f.samples_size+=_.size,_.duration=n,m.flags&p.TRUN_FLAGS_DURATION&&(_.duration=m.sample_duration[r]),f.samples_duration+=_.duration,f.first_traf_merged||r>0?_.dts=f.samples[f.samples.length-2].dts+f.samples[f.samples.length-2].duration:(l.tfdt?_.dts=l.tfdt.baseMediaDecodeTime:_.dts=0,f.first_traf_merged=!0),_.cts=_.dts,m.flags&p.TRUN_FLAGS_CTS_OFFSET&&(_.cts=_.dts+m.sample_composition_time_offset[r]),c=o,m.flags&p.TRUN_FLAGS_FLAGS?c=m.sample_flags[r]:0===r&&m.flags&p.TRUN_FLAGS_FIRST_FLAG&&(c=m.first_sample_flags),_.is_sync=!(c>>16&1),_.is_leading=c>>26&3,_.depends_on=c>>24&3,_.is_depended_on=c>>22&3,_.has_redundancy=c>>20&3,_.degradation_priority=65535&c;var y=!!(l.tfhd.flags&p.TFHD_FLAG_BASE_DATA_OFFSET),x=!!(l.tfhd.flags&p.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),S=!!(m.flags&p.TRUN_FLAGS_DATA_OFFSET),U=0;U=y?l.tfhd.base_data_offset:x?d.start:0===e?d.start:h,0===e&&0===r?S?_.offset=U+m.data_offset:_.offset=U:_.offset=h,h=_.offset+_.size,(l.sbgps.length>0||l.sgpds.length>0||f.mdia.minf.stbl.sbgps.length>0||f.mdia.minf.stbl.sgpds.length>0)&&g.setSampleGroupProperties(f,_,_.number_in_traf,l.sample_groups_info)}}if(l.subs){f.has_fragment_subsamples=!0;var b=l.first_sample_index;for(e=0;e<l.subs.entries.length;e++)b+=l.subs.entries[e].sample_delta,(_=f.samples[b-1]).subsamples=l.subs.entries[e].subsamples}}}},g.prototype.getSample=function(t,e){var r,s=t.samples[e];if(!this.moov)return null;if(s.data){if(s.alreadyRead==s.size)return s}else s.data=new Uint8Array(s.size),s.alreadyRead=0,this.samplesDataSize+=s.size,n.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+s.size+" (total: "+this.samplesDataSize+")");for(;;){var a=this.stream.findPosition(!0,s.offset+s.alreadyRead,!1);if(!(a>-1))return null;var h=(r=this.stream.buffers[a]).byteLength-(s.offset+s.alreadyRead-r.fileStart);if(s.size-s.alreadyRead<=h)return n.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+s.alreadyRead+" offset: "+(s.offset+s.alreadyRead-r.fileStart)+" read size: "+(s.size-s.alreadyRead)+" full size: "+s.size+")"),o.memcpy(s.data.buffer,s.alreadyRead,r,s.offset+s.alreadyRead-r.fileStart,s.size-s.alreadyRead),r.usedBytes+=s.size-s.alreadyRead,this.stream.logBufferLevel(),s.alreadyRead=s.size,s;if(0===h)return null;n.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+s.alreadyRead+" offset: "+(s.offset+s.alreadyRead-r.fileStart)+" read size: "+h+" full size: "+s.size+")"),o.memcpy(s.data.buffer,s.alreadyRead,r,s.offset+s.alreadyRead-r.fileStart,h),s.alreadyRead+=h,r.usedBytes+=h,this.stream.logBufferLevel()}},g.prototype.releaseSample=function(t,e){var r=t.samples[e];return r.data?(this.samplesDataSize-=r.size,r.data=null,r.alreadyRead=0,r.size):0},g.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize},g.prototype.getCodecs=function(){var t,e="";for(t=0;t<this.moov.traks.length;t++){var r=this.moov.traks[t];t>0&&(e+=","),e+=r.mdia.minf.stbl.stsd.entries[0].getCodec()}return e},g.prototype.getTrexById=function(t){var e;if(!this.moov||!this.moov.mvex)return null;for(e=0;e<this.moov.mvex.trexs.length;e++){var r=this.moov.mvex.trexs[e];if(r.track_id==t)return r}return null},g.prototype.getTrackById=function(t){if(void 0===this.moov)return null;for(var e=0;e<this.moov.traks.length;e++){var r=this.moov.traks[e];if(r.tkhd.track_id==t)return r}return null},g.prototype.itemsDataSize=0,g.prototype.flattenItemInfo=function(){var t,e,r,s=this.items,a=this.entity_groups,o=this.meta;if(null!=o&&void 0!==o.hdlr&&void 0!==o.iinf){for(t=0;t<o.iinf.item_infos.length;t++)(r={}).id=o.iinf.item_infos[t].item_ID,s[r.id]=r,r.ref_to=[],r.name=o.iinf.item_infos[t].item_name,o.iinf.item_infos[t].protection_index>0&&(r.protection=o.ipro.protections[o.iinf.item_infos[t].protection_index-1]),o.iinf.item_infos[t].item_type?r.type=o.iinf.item_infos[t].item_type:r.type="mime",r.content_type=o.iinf.item_infos[t].content_type,r.content_encoding=o.iinf.item_infos[t].content_encoding,r.item_uri_type=o.iinf.item_infos[t].item_uri_type;if(o.grpl)for(t=0;t<o.grpl.boxes.length;t++)(entity_group={}).id=o.grpl.boxes[t].group_id,entity_group.entity_ids=o.grpl.boxes[t].entity_ids,entity_group.type=o.grpl.boxes[t].type,a[entity_group.id]=entity_group;if(o.iloc)for(t=0;t<o.iloc.items.length;t++){var h=o.iloc.items[t];switch(r=s[h.item_ID],0!==h.data_reference_index&&(n.warn("Item storage with reference to other files: not supported"),r.source=o.dinf.boxes[h.data_reference_index-1]),h.construction_method){case 0:case 1:break;case 2:n.warn("Item storage with construction_method : not supported")}for(e=0,r.extents=[],r.size=0;e<h.extents.length;e++)r.extents[e]={},r.extents[e].offset=h.extents[e].extent_offset+h.base_offset,1==h.construction_method&&(r.extents[e].offset+=o.idat.start+o.idat.hdr_size),r.extents[e].length=h.extents[e].extent_length,r.extents[e].alreadyRead=0,r.size+=r.extents[e].length}if(o.pitm&&(s[o.pitm.item_id].primary=!0),o.iref)for(t=0;t<o.iref.references.length;t++){var d=o.iref.references[t];for(e=0;e<d.references.length;e++)s[d.from_item_ID].ref_to.push({type:d.type,id:d.references[e]})}if(o.iprp)for(var p=0;p<o.iprp.ipmas.length;p++){var l=o.iprp.ipmas[p];for(t=0;t<l.associations.length;t++){var f=l.associations[t];if((r=s[f.id])||(r=a[f.id]),r)for(void 0===r.properties&&(r.properties={},r.properties.boxes=[]),e=0;e<f.props.length;e++){var u=f.props[e];if(u.property_index>0&&u.property_index-1<o.iprp.ipco.boxes.length){var _=o.iprp.ipco.boxes[u.property_index-1];r.properties[_.type]=_,r.properties.boxes.push(_)}}}}}},g.prototype.getItem=function(t){if(!this.meta)return null;if(!(r=this.items[t]).data&&r.size)r.data=new Uint8Array(r.size),r.alreadyRead=0,this.itemsDataSize+=r.size,n.debug("ISOFile","Allocating item #"+t+" of size "+r.size+" (total: "+this.itemsDataSize+")");else if(r.alreadyRead===r.size)return r;for(var e,r,s=0;s<r.extents.length;s++){var a=r.extents[s];if(a.alreadyRead!==a.length){var h=this.stream.findPosition(!0,a.offset+a.alreadyRead,!1);if(!(h>-1))return null;var d=(e=this.stream.buffers[h]).byteLength-(a.offset+a.alreadyRead-e.fileStart);if(!(a.length-a.alreadyRead<=d))return n.debug("ISOFile","Getting item #"+t+" extent #"+s+" partial data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-e.fileStart)+" read size: "+d+" full extent size: "+a.length+" full item size: "+r.size+")"),o.memcpy(r.data.buffer,r.alreadyRead,e,a.offset+a.alreadyRead-e.fileStart,d),a.alreadyRead+=d,r.alreadyRead+=d,e.usedBytes+=d,this.stream.logBufferLevel(),null;n.debug("ISOFile","Getting item #"+t+" extent #"+s+" data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-e.fileStart)+" read size: "+(a.length-a.alreadyRead)+" full extent size: "+a.length+" full item size: "+r.size+")"),o.memcpy(r.data.buffer,r.alreadyRead,e,a.offset+a.alreadyRead-e.fileStart,a.length-a.alreadyRead),e.usedBytes+=a.length-a.alreadyRead,this.stream.logBufferLevel(),r.alreadyRead+=a.length-a.alreadyRead,a.alreadyRead=a.length}}return r.alreadyRead===r.size?r:null},g.prototype.releaseItem=function(t){var e=this.items[t];if(!e.data)return 0;this.itemsDataSize-=e.size,e.data=null,e.alreadyRead=0;for(var r=0;r<e.extents.length;r++)e.extents[r].alreadyRead=0;return e.size},g.prototype.processItems=function(t){for(var e in this.items){var r=this.items[e];this.getItem(r.id),t&&!r.sent&&(t(r),r.sent=!0,r.data=null)}},g.prototype.hasItem=function(t){for(var e in this.items){var r=this.items[e];if(r.name===t)return r.id}return -1},g.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null},g.prototype.getPrimaryItem=function(){return this.meta&&this.meta.pitm?this.getItem(this.meta.pitm.item_id):null},g.prototype.itemToFragmentedTrackFile=function(t){var e=t||{},r=null;if(null==(r=e.itemId?this.getItem(e.itemId):this.getPrimaryItem()))return null;var s=new g;s.discardMdatData=!1;var n={type:r.type,description_boxes:r.properties.boxes};r.properties.ispe&&(n.width=r.properties.ispe.image_width,n.height=r.properties.ispe.image_height);var a=s.addTrack(n);return a?(s.addSample(a,r.data),s):null},g.prototype.write=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t)},g.prototype.createFragment=function(t,e,r){var s=this.getTrackById(t),a=this.getSample(s,e);if(null==a)return this.setNextSeekPositionFromSample(s.samples[e]),null;var h=r||new o;h.endianness=o.BIG_ENDIAN;var d=this.createSingleSampleMoof(a);d.write(h),d.trafs[0].truns[0].data_offset=d.size+8,n.debug("MP4Box","Adjusting data_offset with new value "+d.trafs[0].truns[0].data_offset),h.adjustUint32(d.trafs[0].truns[0].data_offset_position,d.trafs[0].truns[0].data_offset);var l=new p.mdatBox;return l.data=a.data,l.write(h),h},g.writeInitializationSegment=function(t,e,r,s){n.debug("ISOFile","Generating initialization segment");var a,h=new o;h.endianness=o.BIG_ENDIAN,t.write(h);var d=e.add("mvex");for(r&&d.add("mehd").set("fragment_duration",r),a=0;a<e.traks.length;a++)d.add("trex").set("track_id",e.traks[a].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",s).set("default_sample_size",0).set("default_sample_flags",65536);return e.write(h),h.buffer},g.prototype.save=function(t){var e=new o;e.endianness=o.BIG_ENDIAN,this.write(e),e.save(t)},g.prototype.getBuffer=function(){var t=new o;return t.endianness=o.BIG_ENDIAN,this.write(t),t.buffer},g.prototype.initializeSegmentation=function(){for(null===this.onSegment&&n.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),e=[],t=0;t<this.fragmentedTracks.length;t++){var t,e,r,s,a=new p.moovBox;a.mvhd=this.moov.mvhd,a.boxes.push(a.mvhd),r=this.getTrackById(this.fragmentedTracks[t].id),a.boxes.push(r),a.traks.push(r),(s={}).id=r.tkhd.track_id,s.user=this.fragmentedTracks[t].user,s.buffer=g.writeInitializationSegment(this.ftyp,a,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[t].samples.length>0?this.moov.traks[t].samples[0].duration:0),e.push(s)}return e},p.Box.prototype.printHeader=function(t){this.size+=8,this.size>4294967296&&(this.size+=8),"uuid"===this.type&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)},p.FullBox.prototype.printHeader=function(t){this.size+=4,p.Box.prototype.printHeader.call(this,t),t.log(t.indent+"version:"+this.version),t.log(t.indent+"flags:"+this.flags)},p.Box.prototype.print=function(t){this.printHeader(t)},p.ContainerBox.prototype.print=function(t){this.printHeader(t);for(var e=0;e<this.boxes.length;e++)if(this.boxes[e]){var r=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=r}},g.prototype.print=function(t){t.indent="";for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)},p.mvhdBox.prototype.print=function(t){p.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"timescale: "+this.timescale),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"rate: "+this.rate),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"next_track_id: "+this.next_track_id)},p.tkhdBox.prototype.print=function(t){p.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"track_id: "+this.track_id),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"layer: "+this.layer),t.log(t.indent+"alternate_group: "+this.alternate_group),t.log(t.indent+"width: "+this.width),t.log(t.indent+"height: "+this.height)};var y={};y.createFile=function(t,e){var r=new g(e);return r.discardMdatData=!(void 0===t||t),r},e.createFile=y.createFile}}]);