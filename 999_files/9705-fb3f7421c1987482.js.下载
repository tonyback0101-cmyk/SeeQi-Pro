"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9705],{92876:function(e,t,r){var n=r(26538);t.ZP=void 0;var i=n(r(49884)),a=n(r(44221));let o=(0,i.default)();t.ZP=function(e=o){return(0,a.default)(e)}},79705:function(e,t,r){r.d(t,{x:function(){return x}});var n=r(52676),i=r(75271),a=r(36903),o=r(22988),l=r(14930),s=r(77379),h=r(92876),d=r(71481),u=r(62573);let c=e=>{let{value:t,mode:r,onModeChange:i,onChange:a,min:l=1,max:s=50,step:h=1}=e;return(0,n.jsxs)(o.Z,{sx:{display:"flex",alignItems:"center",gap:2,width:"100%",backgroundColor:"rgb(32, 33, 35)",padding:"8px",borderRadius:"4px"},children:[(0,n.jsx)(u.rY,{leftValue:"draw",rightValue:"erase",leftLabel:"Add",rightLabel:"Minus",leftIcon:"ph:plus-circle",rightIcon:"ph:minus-circle",value:r,onChange:e=>i(e)}),(0,n.jsxs)(o.Z,{sx:{display:"flex",alignItems:"center",flex:1,gap:1},children:[(0,n.jsx)(o.Z,{sx:{fontSize:"14px",color:"rgba(255, 255, 255, 0.7)"},children:"Size"}),(0,n.jsx)(u.Bn,{min:l,max:s,step:h,value:t,onChange:(e,t)=>{a(Array.isArray(t)?t[0]:t)},sx:{flex:1}})]})]})};var g=r(46973);let m={draw:{stroke:"rgb(0, 255, 0)",fill:"rgba(0, 255, 0, 0.5)",saveFill:"white"},erase:{stroke:"rgba(255, 0, 0, 0.5)",fill:"rgba(255, 0, 0, 0.5)"}},f=(0,i.forwardRef)((e,t)=>{let{uploadImageUrl:r,containerWidth:a,containerHeight:u,onSave:f,isLoading:x}=e,w=(0,h.ZP)(),p=(0,l.Z)(w.breakpoints.down("sm")),v=(0,i.useRef)(null),[b,k]=(0,i.useState)(null),[C,y]=(0,i.useState)(20),[S,j]=(0,i.useState)("draw"),[R,I]=(0,i.useState)(0),[M,Z]=(0,i.useState)(0),E=(0,i.useRef)(null),P=(0,i.useRef)(p?10:20),D=(e,t)=>{let r=`
      <svg xmlns="http://www.w3.org/2000/svg" width="${e}" height="${e}" viewBox="0 0 ${e} ${e}">
        <circle 
          cx="${e/2}" 
          cy="${e/2}" 
          r="${e/2-1}" 
          fill="none" 
          stroke="${m[t].stroke}" 
          stroke-width="1"
        />
      </svg>
    `;return`url(data:image/svg+xml;base64,${btoa(r)}) ${e/2} ${e/2}, crosshair`},$=(e,t,r,n)=>{let i,a;let o=e/t,l=n-60;return o>r/n?(a=(i=r-32)/o)>l&&(i=(a=l-32)*o):(i=(a=l-32)*o)>r&&(a=(i=r-32)/o),{width:Math.floor(i),height:Math.floor(a),scaleX:i/e,scaleY:a/t}},L=()=>{if(!v.current||!r||a<=0||u<=0)return;let e=new d.fabric.Canvas(v.current);k(e),d.fabric.Image.fromURL(r,t=>{if(!t||!e)return;I(t.width),Z(t.height);let r=$(t.width,t.height,a,u);e.setDimensions({width:r.width,height:r.height}),t.scaleToWidth(r.width),t.scaleToHeight(r.height),e.setBackgroundImage(t,e.renderAll.bind(e),{originX:"left",originY:"top",selectable:!1,evented:!1});let n=document.createElement("canvas");n.width=r.width,n.height=r.height,n.getContext("2d").clearRect(0,0,n.width,n.height),E.current=n;let i=Math.min(t.width/r.width,t.height/r.height);e.freeDrawingBrush.width=C*i,U(e)},{crossOrigin:"anonymous"})},U=e=>{let t=!1;e.on("mouse:down",e=>{t=!0,W(e)}),e.on("mouse:move",e=>{t&&W(e)}),e.on("mouse:up",()=>{t=!1})},W=e=>{if(!b||!E.current)return;let t=b.getPointer(e.e),r=E.current.getContext("2d");"draw"===S?(r.globalCompositeOperation="source-over",r.strokeStyle=m.draw.stroke,r.lineWidth=C,r.lineCap="round",r.lineJoin="round",r.beginPath(),r.arc(t.x,t.y,C/2,0,2*Math.PI),r.stroke()):(r.globalCompositeOperation="destination-out",r.beginPath(),r.arc(t.x,t.y,C/2,0,2*Math.PI),r.fill()),O()},O=(0,i.useCallback)(()=>{if(!b||!E.current)return;let e=b.getObjects().find(e=>"maskImage"===e.name);e&&b.remove(e);let t=document.createElement("canvas");t.width=E.current.width,t.height=E.current.height;let r=t.getContext("2d");r.drawImage(E.current,0,0),r.globalCompositeOperation="source-in",r.fillStyle=m.draw.fill,r.fillRect(0,0,t.width,t.height);let n=new d.fabric.Image(t,{left:0,top:0,selectable:!1,evented:!1,name:"maskImage"});b.add(n),b.renderAll()},[b]);(0,i.useImperativeHandle)(t,()=>({getMaskDataURL:async()=>{if(!E.current)return null;try{let e=document.createElement("canvas");e.width=E.current.width,e.height=E.current.height;let t=e.getContext("2d");t.drawImage(E.current,0,0),t.globalCompositeOperation="source-in",t.fillStyle=m.draw.saveFill,t.fillRect(0,0,e.width,e.height);let r=await new Promise((t,r)=>{e.toBlob(e=>{e?t(e):r(Error("Canvas to Blob conversion failed"))},"image/png")}),n=new FormData;n.append("file",r,`mask_${Date.now()}.png`);let i=await g.ZP.post("/media/upload_image",n,{headers:{"Content-Type":"multipart/form-data"}});if(i.data&&i.data.imageUrl)return i.data.imageUrl;throw Error("No image URL in response")}catch(e){throw console.error("Error in getMaskDataURL:",e),e}},clearMask:()=>{E.current&&(E.current.getContext("2d").clearRect(0,0,E.current.width,E.current.height),O())}}));let H=(0,i.useCallback)((e,t)=>{if(!E.current)return;let r=E.current.getContext("2d");"draw"===S?(r.globalCompositeOperation="source-over",r.strokeStyle=m.draw.stroke):r.globalCompositeOperation="destination-out",r.lineWidth=C,r.lineCap="round",r.lineJoin="round",r.beginPath(),r.moveTo(e.x,e.y),r.lineTo(t.x,t.y),r.stroke(),O()},[S,C,O]);return(0,i.useEffect)(()=>(L(),()=>{b&&(b.dispose(),k(null))}),[]),(0,i.useEffect)(()=>{if(!b)return;let e=!1,t=null,r=r=>{e=!0;let n=b.getPointer(r.e);H(t={x:n.x,y:n.y},t)},n=r=>{if(!e)return;let n=b.getPointer(r.e),i={x:n.x,y:n.y};H(t,i),t=i},i=()=>{e=!1,t=null};return b.isDrawingMode=!1,b.selection=!1,b.defaultCursor=D(C,S),b.on("mouse:down",r),b.on("mouse:move",n),b.on("mouse:up",i),()=>{b.off("mouse:down",r),b.off("mouse:move",n),b.off("mouse:up",i)}},[b,C,S,H]),(0,n.jsxs)(o.Z,{sx:{width:"100%",height:"100%",display:"flex",flexDirection:"column"},children:[(0,n.jsx)(o.Z,{sx:{flexGrow:1,display:"flex",justifyContent:"center",alignItems:"center",overflow:"hidden"},children:(0,n.jsx)("canvas",{ref:v,style:{maxWidth:"100%",maxHeight:"100%"}})}),(0,n.jsxs)(o.Z,{sx:{mt:2,display:"flex",flexDirection:{xs:"column",sm:"row"},alignItems:"center",gap:2},children:[(0,n.jsx)(o.Z,{sx:{flex:1,width:"100%"},children:(0,n.jsx)(c,{value:C,mode:S,onModeChange:j,onChange:e=>{e>=1&&e<=50?(P.current=e,y(e)):y(P.current)},canvas:b,min:1,max:p?35:50,step:1})}),(0,n.jsx)(s.Z,{onClick:f,variant:"contained",disabled:x,sx:{minWidth:{xs:"100%",sm:"100px"},height:36,backgroundColor:"rgb(32, 33, 35)","&:hover":{backgroundColor:"rgb(45, 46, 48)"},boxShadow:"none",border:"1px solid rgba(255, 255, 255, 0.1)",color:"white"},children:x?"Saving...":"Save"})]})]})});f.displayName="DrawMaskComponent";let x=e=>{let{isOpen:t,onClose:r,uploadImageUrl:l,onSave:s}=e,h=(0,i.useRef)(null),[d,u]=(0,i.useState)(!1),[c,g]=(0,i.useState)(null),[m,x]=(0,i.useState)({width:0,height:0}),w=(0,i.useRef)(null);(0,i.useEffect)(()=>{let e=()=>{if(!w.current)return;let e=window.innerWidth;x({width:Math.max(e<600?Math.min(.9*e,360):Math.min(.8*e,1200),300),height:Math.max(.8*window.innerHeight-110,400)})};if(t){let t=setTimeout(e,0);return window.addEventListener("resize",e),()=>{clearTimeout(t),window.removeEventListener("resize",e)}}},[t]);let p=async()=>{if(h.current){u(!0),g(null);try{let e=await h.current.getMaskDataURL();if(e)s(e),r();else throw Error("Failed to get mask image URL")}catch(e){console.error("Error saving mask:",e),g("Failed to save mask. Please try again.")}finally{u(!1)}}};return(0,n.jsx)(a.Z,{open:t,onClose:r,onClick:e=>e.stopPropagation(),children:(0,n.jsx)(o.Z,{ref:w,sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",bgcolor:"background.paper",boxShadow:24,p:2,borderRadius:2,display:"flex",flexDirection:"column",width:"auto",height:"auto",maxWidth:{xs:"96vw",sm:"85vw",md:"80vw"},maxHeight:{xs:"90vh",sm:"85vh",md:"80vh"},minWidth:{xs:"300px",sm:"450px"},minHeight:{xs:"auto",sm:"500px"}},children:(0,n.jsxs)(o.Z,{sx:{display:"flex",flexDirection:"column",height:"100%",width:"100%",gap:2},children:[m.width>0&&m.height>0&&(0,n.jsx)(f,{ref:h,uploadImageUrl:l,containerWidth:m.width,containerHeight:m.height,onSave:p,isLoading:d}),c?(0,n.jsx)(o.Z,{sx:{color:"error.main",textAlign:"center",fontSize:"0.875rem",mt:1},children:c}):null]})})})}}}]);