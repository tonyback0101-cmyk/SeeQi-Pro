"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3343],{57715:function(e,t,r){r.d(t,{Ai:function(){return m},BG:function(){return f},I0:function(){return d},K_:function(){return u},Ll:function(){return k},Pw:function(){return v},S6:function(){return s},Wr:function(){return w},X_:function(){return E},Xj:function(){return g},Zz:function(){return y},d$:function(){return h},dd:function(){return c},mp:function(){return l},r_:function(){return p},wg:function(){return F}});var n=r(18889),a=r(10672),i=r(24088),o=r(4629);let l=616,s=60,c=24,d=16,u=32,m=5,h=new Set([i._Z,i.nR,i.kN]),f=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"jpg";return e?e.replace("512.webp",`raw.${t}`).replace("1024.webp",`raw.${t}`):""},v=e=>{try{let t=p(e);return`${"url"===t?"Original":t} version will be downloaded`}catch{return"Original image will be downloaded"}},p=e=>{for(let t=o.ax.length-1;t>=0;t--){let r=o.ax[t];if(e[r])return r}};function w(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:p(e),{url:r,image_suffix:n,raw:a}=e,i=a||f(r,n),o=i;return e[t]&&(o="url"===t?i:e[t]),{rawImageUrl:i,displayImageUrl:o}}function g(e,t){let{generation_history_id:r,character_creation_id:n,ai_model:a,model_name:i,prompt:l,enhanced_prompt:s,translated_prompt:c,type:d,variation_source:u,inpaint_payload:m,controlnet:h,sd_version:f,sampler:v,configs:p,preset_id:g,created_at:y,user_id:F,width:E,height:x,seed:_,app_config:b={},workflow:k,workflow_config:P,image_suffix:$,app:L,canvas_edit_payload:M,thumbnail_url:T}=e;return{image_url:w(e,t).displayImageUrl,thumbnail_url:T,model_name:i,app:L||"",canvas_edit_payload:M||null,is_prompt_private:!1,is_nsfw:!1,link:"",title:"",prompt:l||"",enhanced_prompt:s||"",translated_prompt:c||"",character_creation_id:n||"",ai_model:a||"",description:"",image_width:E||0,image_height:x||0,image_seed:_||"",image_suffix:$||"",type:d||o.J6.generation,variation_source:u||null,inpaint_payload:m||null,controlnet:h||null,sd_version:f||null,sampler:v||null,configs:p||null,history_id:r||"",preset_id:g||"",created_at:y||null,user_id:F||0,app_config:b,...k?{workflow:k}:{},...P?{workflow_config:P}:{}}}class y{async extractAllFrames(e,t){if(this.allFrames)return null==e||e(100),this.allFrames;if(this.isExtracting&&this.extractionPromise)return this.extractionPromise;this.isExtracting=!0,this.extractionPromise=this.performExtraction(e,t);try{return this.allFrames=await this.extractionPromise,this.allFrames}finally{this.isExtracting=!1}}async performExtraction(e,t){let{skipFailedFrames:r=!0}=t||{};if(!window.VideoDecoder){let t=await (0,a.gq)(this.videoUrl);return b(this.videoUrl,t,e,{skipFailedFrames:r,frameTimeout:3e3})}try{return await _(this.videoUrl,e,t)}catch(n){console.warn("WebCodecs extraction failed, falling back to traditional method:",n);let t=await (0,a.gq)(this.videoUrl);return b(this.videoUrl,t,e,{skipFailedFrames:r,frameTimeout:3e3})}}async extractThumbnails(e,t){let r=await this.extractAllFrames(void 0,{maxFrames:Math.min(3*e,150),skipFailedFrames:!0});if(r.length<=e)return r;let n=[],a=r.length/e;for(let t=0;t<e;t++){let e=Math.floor(t*a);n.push(r[e])}return n}async extractLastFrame(){let e=await this.extractAllFrames(void 0,{skipFailedFrames:!0});if(0===e.length)throw Error("Failed to extract any frames");return e.at(-1)}async extractFrameAtTime(e){let t=await this.extractAllFrames();if(0===t.length)return null;let r=0,n=t.length-1,a=t[0];for(;r<=n;){let i=Math.floor((r+n)/2),o=t[i];Math.abs(o.time-e)<Math.abs(a.time-e)&&(a=o),o.time<e?r=i+1:n=i-1}return a}async extractFramesInRange(e,t){return(await this.extractAllFrames()).filter(r=>r.time>=e&&r.time<=t)}dispose(){this.allFrames&&(this.allFrames.forEach(e=>e.imageBitmap.close()),this.allFrames=null),this.extractionPromise=null}get frameCount(){var e;return(null===(e=this.allFrames)||void 0===e?void 0:e.length)??0}get isReady(){return null!==this.allFrames}get url(){return this.videoUrl}constructor(e){this.allFrames=null,this.isExtracting=!1,this.extractionPromise=null,this.videoUrl=e}}async function F(e,t,r){let n=new y(e);return await n.extractThumbnails(r,t)}async function E(e){let t=new y(e);return await t.extractLastFrame()}let x=(e,t)=>{try{var r,a,i,o,l,s,c;if(!(null===(a=e.moov)||void 0===a?void 0:null===(r=a.traks)||void 0===r?void 0:r.length))return console.warn("No tracks found in MP4 file"),null;let d=e.moov.traks.find(e=>{var r;return(null===(r=e.tkhd)||void 0===r?void 0:r.track_id)===t});if(!(null==d?void 0:null===(c=d.mdia)||void 0===c?void 0:null===(s=c.minf)||void 0===s?void 0:null===(l=s.stbl)||void 0===l?void 0:null===(o=l.stsd)||void 0===o?void 0:null===(i=o.entries)||void 0===i?void 0:i[0]))return console.warn("No valid video track found for codec description extraction"),null;let u=d.mdia.minf.stbl.stsd.entries[0],m=u.avcC??u.hvcC??u.vpcC??u.av01C;if(null!=m&&m.write&&"function"==typeof m.write)try{let e=new n.DataStream(void 0,0,n.DataStream.BIG_ENDIAN);return m.write(e),new Uint8Array(e.buffer.slice(8))}catch(e){console.warn("Failed to write codec box:",e)}}catch(e){console.warn("Failed to extract codec description:",e)}return null};async function _(e,t,r){let{maxFrames:a,skipFailedFrames:i=!0}=r||{};return new Promise(async(r,o)=>{let l=!1,s=null,c=[],d=[],u=new Set,m=()=>{s&&(clearTimeout(s),s=null)},h=0,f=30,v=()=>{if(l)return;d.sort((e,t)=>e.timestamp-t.timestamp);let e=1/f;d.forEach((t,r)=>{let n=Math.min(r*e,h-.01);c.push({time:n,imageBitmap:t.imageBitmap})}),p()},p=()=>{l||(l=!0,m(),r(c))},w=e=>{l||(l=!0,m(),o(e))};s=setTimeout(()=>{console.warn("Video frame extraction timed out, returning partial results"),d.length>0?v():w(Error("Video frame extraction timed out with no frames"))},6e4);try{let r=await fetch(e);if(!r.ok)throw Error(`Failed to fetch video: ${r.statusText}`);let o=await r.arrayBuffer(),s=n.createFile(),c=null,m=null,p=[],g=0;s.onReady=function(e){try{if(!(c=e.videoTracks.find(e=>"video"===e.type)))throw Error("No video track found in the file");g=a&&a>0?Math.min(a,c.nb_samples):c.nb_samples,h=c.duration/c.timescale,f=c.nb_samples/h,m=new VideoDecoder({output:e=>{let r=e.timestamp;if(u.has(r)){console.warn(`Duplicate frame timestamp ${r}, skipping`),e.close();return}u.add(r),createImageBitmap(e).then(async n=>{d.push({timestamp:r,imageBitmap:n});let a=Math.round(d.length/g*100);null==t||t(a),d.length>=g&&setTimeout(()=>{l||v()},100),e.close()}).catch(t=>{console.warn("Failed to create image bitmap:",t),e.close()})},error:e=>{console.error("VideoDecoder error:",e),i||w(Error(`Video decoder error: ${e.message}`))}});let r={codec:c.codec,codedWidth:c.track_width,codedHeight:c.track_height},n=x(s,c.id);n&&(r.description=n),m.configure(r),a&&a>0?s.setExtractionOptions(c.id,"video",{nbSamples:a}):s.setExtractionOptions(c.id,"video"),s.start()}catch(e){console.error("Error in onReady:",e),w(e)}},s.onSamples=function(e,t,r){try{if(c&&c.id===e&&m){for(let e of(p.push(...r),p.sort((e,t)=>e.cts-t.cts),r))try{let t=new EncodedVideoChunk({type:e.is_sync?"key":"delta",timestamp:e.cts,duration:e.duration||0,data:e.data});m.decode(t)}catch(e){if(console.warn("Failed to decode sample:",e),!i)throw e}p.length>=g?(s.stop(),m.flush().then(()=>{setTimeout(()=>{l||v()},1e3)}).catch(w)):s.start()}}catch(e){console.error("Error in onSamples:",e),w(e)}},s.onError=function(e){console.error("MP4Box error:",e),w(Error(`MP4Box error: ${e}`))},o.fileStart=0,s.appendBuffer(o),s.flush()}catch(e){console.error("General error:",e),w(e)}})}async function b(e,t,r,n){let{frameTimeout:a=3e3,skipFailedFrames:i=!0}=n||{},{duration:o,fps:l}=t;if(!o||o<=0)throw Error("Invalid video duration");if(!l||l<=0)throw Error("Invalid video frame rate");let s=await new Promise((t,r)=>{let n=document.createElement("video");n.crossOrigin="anonymous",n.src=e;let a=()=>{n.removeEventListener("loadedmetadata",a),n.removeEventListener("error",i),t(n)},i=e=>{n.removeEventListener("loadedmetadata",a),n.removeEventListener("error",i),r(e)};n.addEventListener("loadedmetadata",a),n.addEventListener("error",i)}),c=Math.ceil(o*l),d=1/l,u=[],m=[],h=Array.from({length:c},(e,t)=>t);return await h.reduce(async(e,t)=>{await e;let n=Math.min(t*d,o-.01);try{let e=await function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3e3;return new Promise((n,a)=>{let i;let o=!1,l=()=>{i&&clearTimeout(i),e.removeEventListener("seeked",s),e.removeEventListener("error",c)},s=async()=>{if(!o){o=!0,l();try{let t=await createImageBitmap(e);n(t)}catch(e){a(e)}}},c=()=>{o||(o=!0,l(),a(Error(`Video seek error at time ${t}`)))};e.addEventListener("seeked",s),e.addEventListener("error",c),i=setTimeout(()=>{o||(o=!0,l(),a(Error(`Frame extraction timeout at time ${t}`)))},r);try{e.currentTime=t}catch(e){o||(o=!0,l(),a(e))}})}(s,n,a);u.push({time:n,imageBitmap:e})}catch(e){if(console.warn(`Frame extraction failed for frame ${t} at time ${n}:`,e),m.push(t),!i)throw Error(`Failed to extract frame ${t}: ${e.message}`)}(t%30==0||t===c-1)&&(null==r||r(Math.round((t+1)/c*100)))},Promise.resolve()),m.length>0&&(m.length,console.warn(`Failed frames: ${m.length} (indices: ${m.slice(0,10).join(", ")}${m.length>10?"...":""})`)),u}function k(e,t){let r=atob(e.split(",")[1]),n=new Uint8Array(r.length);for(let e=0;e<r.length;e++)n[e]=r.codePointAt(e);let a=e.match(/data:([^;]+);/),i=a?a[1]:"application/octet-stream";return new File([new Blob([n],{type:i})],t,{type:i})}},10672:function(e,t,r){r.d(t,{aS:function(){return a},gq:function(){return l},sy:function(){return i},yh:function(){return o}});var n=r(52846);let a=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;return e&&e.length>t?`${e.slice(0,t)}...`:e};async function i(e){try{let t=[],r=new n.FFmpeg;r.on("log",e=>{let{message:r}=e;t.push(r)}),await r.load();let a="input.mp4",i="audio.wav",o=await fetch(e,{headers:{Range:"bytes=0-10485759"}}),l=await o.arrayBuffer();await r.writeFile(a,new Uint8Array(l)),await r.exec(["-i",a,"-vn","-acodec","pcm_s16le",i]);try{let e=(await r.readFile(i)).length>44;return await r.deleteFile(a),await r.deleteFile(i),e}catch{return await r.deleteFile(a),!1}}catch{return!1}}async function o(e){return new Promise(t=>{let r=document.createElement("video");r.preload="metadata",r.muted=!0,r.addEventListener("loadedmetadata",()=>{t(r.duration),r.remove()}),r.addEventListener("error",()=>{t(0),r.remove()}),r.src=e})}async function l(e){return new Promise(t=>{let r=document.createElement("video");r.preload="metadata",r.crossOrigin="anonymous",r.muted=!0,r.addEventListener("loadedmetadata",async()=>{let e=r.duration,n=r.videoWidth,a=r.videoHeight,i=30,o=Math.round(30*e);if("requestVideoFrameCallback"in r)try{i=await s(r),o=Math.round(e*i)}catch{}t({duration:e,width:n,height:a,fps:i,totalFrames:o}),r.remove()}),r.addEventListener("error",()=>{t({duration:0,width:0,height:0,fps:30,totalFrames:0}),r.remove()}),r.src=e})}async function s(e){return new Promise(t=>{let r=0,n=0,a=30,i=(o,l)=>{if(0!==n){let e=1e3/(o-n);a=r>0?(a*r+e)/(r+1):e}n=o,++r<10&&e.currentTime<e.duration?e.requestVideoFrameCallback(i):t(Math.round(100*a)/100)};e.playsInline=!0,e.play(),e.requestVideoFrameCallback(i)})}},76820:function(e,t,r){var n,a;r.d(t,{s:function(){return n}}),(a=n||(n={})).Private="private",a.Public="public",a.ImageOnly="imageOnly"}}]);