# 内测检查清单

## ✅ 已修复的问题

### 1. 支付流程表名不一致 ✅
- [x] 修复 `app/api/pay/checkout/route.ts` 中的表名（`reports` → `report_v2`）
- [x] 验证所有查询使用正确的表名

### 2. 前端支付错误处理 ✅
- [x] 替换 `alert()` 为 toast 通知组件
- [x] 添加 `PaymentFeedbackToast` 组件
- [x] 实现自动关闭和手动关闭功能

### 3. 订单插入错误处理 ✅
- [x] 添加重试机制（最多3次）
- [x] 实现指数退避策略
- [x] 改进错误日志记录

## 🔍 流程验证检查点

### 分析流程
1. **数据上传**
   - [ ] 掌纹图片上传成功
   - [ ] 舌象图片上传成功
   - [ ] 梦境文本输入验证
   - [ ] 图片格式和大小验证

2. **分析处理**
   - [ ] 图片分析成功（soft-fail 机制正常）
   - [ ] LLM 调用成功（超时处理正常）
   - [ ] 数据保存到 `report_v2` 表
   - [ ] 报告 ID 生成正确

3. **结果展示**
   - [ ] 预览模式显示正确
   - [ ] 付费模式显示正确
   - [ ] 访问控制逻辑正确

### 支付流程
1. **支付发起**
   - [ ] 未登录用户跳转登录
   - [ ] 已登录用户创建支付会话
   - [ ] 订单记录创建（重试机制正常）
   - [ ] Stripe 会话创建成功

2. **支付完成**
   - [ ] Webhook 接收支付事件
   - [ ] 订单状态更新为 `paid`
   - [ ] `report_access` 记录创建
   - [ ] 用户权限更新

3. **支付回调**
   - [ ] 支付成功回调处理
   - [ ] 支付取消回调处理
   - [ ] URL 参数清理
   - [ ] 页面刷新显示完整内容

### 访问控制
1. **权限判断**
   - [ ] 匿名用户显示预览
   - [ ] 单次购买用户显示完整内容
   - [ ] 订阅用户显示完整内容
   - [ ] 权限优先级正确（年订阅 > 月订阅 > 单次 > 免费）

2. **数据访问**
   - [ ] 预览模式只显示摘要
   - [ ] 完整模式显示所有内容
   - [ ] 锁定内容正确显示

## 📋 代码质量检查

### 函数命名一致性
- [x] `handleUnlockClick` - 统一使用
- [x] `onUnlock` - 统一使用
- [x] `getAccessLevel` - 统一使用
- [x] `getIsPro` - 统一使用
- [x] `computeV2Access` - 统一使用

### 变量命名一致性
- [x] `reportId` - camelCase（前端）
- [x] `report_id` - snake_case（数据库/API）
- [x] `effectiveLocale` - 统一使用
- [x] `resolvedAccessLevel` - 统一使用

### 数据结构一致性
- [x] `normalized` 对象结构统一
- [x] `V2AccessResult` 类型定义正确
- [x] `AnalysisV2Result` 类型定义正确

## 🧪 测试场景

### 场景1：匿名用户分析流程
1. 未登录状态下上传图片和分析
2. 查看预览报告
3. 点击解锁按钮
4. 跳转到登录页面
5. 登录后返回报告页面
6. 点击解锁按钮
7. 跳转到支付页面
8. 完成支付
9. 返回报告页面查看完整内容

### 场景2：已登录用户分析流程
1. 登录状态下上传图片和分析
2. 查看预览报告
3. 点击解锁按钮
4. 跳转到支付页面
5. 完成支付
6. 返回报告页面查看完整内容

### 场景3：订阅用户流程
1. 订阅用户上传图片和分析
2. 直接查看完整报告（无需支付）
3. 所有内容可见

### 场景4：错误处理
1. 图片上传失败（网络错误）
2. 分析失败（LLM 超时）
3. 支付失败（Stripe 错误）
4. 订单插入失败（数据库错误，重试机制）

## 🔧 性能检查

- [ ] 分析流程响应时间 < 60秒
- [ ] 支付流程响应时间 < 5秒
- [ ] 页面加载时间 < 3秒
- [ ] 数据库查询时间 < 1秒

## 🛡️ 安全性检查

- [ ] 用户输入验证
- [ ] SQL 注入防护（使用参数化查询）
- [ ] XSS 防护
- [ ] CSRF 防护
- [ ] 环境变量安全

## 📝 待验证项目

1. [ ] 所有 API 路由返回正确的状态码
2. [ ] 所有错误消息多语言支持
3. [ ] 所有日志记录完整
4. [ ] 所有数据库操作有错误处理
5. [ ] 所有异步操作有超时处理

