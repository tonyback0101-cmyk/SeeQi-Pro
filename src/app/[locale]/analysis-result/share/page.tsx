import { Metadata } from "next";
import { Buffer } from "buffer";
import Link from "next/link";

const STRINGS = {
  zh: {
    title: "SeeQi 分享报告",
    subtitle: "以下内容由您好友分享，仅供参考",
    missing: "未找到分享内容，请重新生成链接。",
    start: "立即体验",
    modules: "核心洞察",
    disclaimer: "该报告由 SeeQi AI 自动生成，仅供文化娱乐参考，不构成医疗建议。",
  },
  en: {
    title: "SeeQi Shared Insight",
    subtitle: "Your friend shared a holistic snapshot for you to explore",
    missing: "No shared content detected. Please regenerate the link.",
    start: "Start Your Assessment",
    modules: "Key Insights",
    disclaimer: "Generated by SeeQi AI for cultural and wellness reference only.",
  },
} as const;

type Locale = "zh" | "en";

type SharePayload = {
  title?: string;
  summary?: string;
  highlights?: string[];
  sections?: Array<{ heading?: string; description?: string }>;
};

type PageProps = {
  params: Promise<{ locale: Locale }>;
  searchParams: Promise<Record<string, string | string[] | undefined>>;
};

function decodePayload(encoded?: string | string[]): SharePayload | null {
  if (!encoded) return null;
  const value = Array.isArray(encoded) ? encoded[0] : encoded;
  try {
    const json = Buffer.from(value, "base64").toString("utf-8");
    return JSON.parse(json) as SharePayload;
  } catch (error) {
    console.error("share-decode", error);
    return null;
  }
}

export async function generateMetadata({ params, searchParams }: PageProps): Promise<Metadata> {
  const { locale: localeParam } = await params;
  const locale: Locale = localeParam === "zh" ? "zh" : "en";
  const resolvedSearchParams = await searchParams;
  const base = STRINGS[locale];
  const payload = decodePayload(resolvedSearchParams.payload);

  return {
    title: payload?.title ?? base.title,
    description: payload?.summary ?? base.subtitle,
    openGraph: {
      title: payload?.title ?? base.title,
      description: payload?.summary ?? base.subtitle,
      type: "article",
    },
  };
}

export default async function SharedReportPage({ params, searchParams }: PageProps) {
  const { locale: localeParam } = await params;
  const locale: Locale = localeParam === "zh" ? "zh" : "en";
  const resolvedSearchParams = await searchParams;
  const baseCopy = STRINGS[locale];
  const payload = decodePayload(resolvedSearchParams.payload);
  const ref = typeof resolvedSearchParams.ref === "string" ? resolvedSearchParams.ref : undefined;
  const reportId = typeof resolvedSearchParams.report === "string" ? resolvedSearchParams.report : undefined;

  const shareTitle = payload?.title ?? baseCopy.title;
  const shareSubtitle = payload?.summary ?? baseCopy.subtitle;

  const startHref = ref ? `/${locale}/analyze?ref=${encodeURIComponent(ref)}` : `/${locale}/analyze`;

  return (
    <main
      style={{
        maxWidth: "760px",
        margin: "0 auto",
        padding: "6rem 1.5rem 3rem",
        display: "flex",
        flexDirection: "column",
        gap: "1.6rem",
      }}
    >
      <header style={{ textAlign: "center", display: "flex", flexDirection: "column", gap: "0.6rem" }}>
        <h1 style={{ margin: 0, fontSize: "2.4rem", color: "#234035" }}>{shareTitle}</h1>
        <span style={{ color: "#8DAE92", fontWeight: 700 }}>{locale === "zh" ? "SeeQi · 东方智慧与健康能量" : "SeeQi · Eastern Wisdom & Vital Energy"}</span>
        <p style={{ margin: 0, color: "rgba(35,64,53,0.75)" }}>{shareSubtitle}</p>
        {ref && (
          <span
            style={{
              alignSelf: "center",
              padding: "0.35rem 0.9rem",
              borderRadius: 999,
              background: "rgba(198, 169, 105, 0.18)",
              color: "#8B5E00",
              fontWeight: 600,
              fontSize: "0.95rem",
            }}
          >
            REF · {ref}
          </span>
        )}
      </header>

      {!payload ? (
        <p style={{ color: "rgba(35,64,53,0.7)", textAlign: "center", marginTop: "2rem" }}>{baseCopy.missing}</p>
      ) : (
        <section
          style={{
            borderRadius: "24px",
            border: "1px solid rgba(141, 174, 146, 0.25)",
            background: "rgba(255,255,255,0.94)",
            boxShadow: "0 24px 46px rgba(35,64,53,0.12)",
            padding: "2rem",
            display: "flex",
            flexDirection: "column",
            gap: "1.2rem",
          }}
        >
          {payload.highlights && payload.highlights.length > 0 && (
            <ul style={{ margin: 0, paddingLeft: "1.2rem", color: "rgba(35,64,53,0.82)", lineHeight: 1.6 }}>
              {payload.highlights.map((item) => (
                <li key={item}>{item}</li>
              ))}
            </ul>
          )}
          {payload.sections && payload.sections.length > 0 && (
            <div style={{ display: "flex", flexDirection: "column", gap: "0.9rem" }}>
              <strong style={{ color: "#234035" }}>{STRINGS[locale].modules}</strong>
              {payload.sections.map((section, index) => (
                <div
                  key={`${section.heading ?? "section"}-${index}`}
                  style={{
                    borderRadius: "16px",
                    background: "rgba(141,174,146,0.12)",
                    padding: "0.9rem 1.1rem",
                    color: "rgba(35,64,53,0.82)",
                  }}
                >
                  {section.heading && <strong>{section.heading}</strong>}
                  {section.description && <p style={{ margin: "0.35rem 0 0", lineHeight: 1.6 }}>{section.description}</p>}
                </div>
              ))}
            </div>
          )}

          {reportId && (
            <Link
              href={`/${locale}/analysis-result/${reportId}`}
              style={{
                alignSelf: "flex-start",
                color: "#4C5FD7",
                fontWeight: 600,
                textDecoration: "none",
              }}
            >
              {locale === "zh" ? "查看完整报告" : "Open full report"}
            </Link>
          )}
        </section>
      )}

      <div style={{ display: "flex", flexWrap: "wrap", gap: "0.8rem", justifyContent: "center" }}>
        <Link
          href={startHref}
          style={{
            borderRadius: "16px",
            padding: "0.85rem 1.6rem",
            background: "linear-gradient(135deg,#2C3E30,#4A7157)",
            color: "#fff",
            fontWeight: 600,
            textDecoration: "none",
            boxShadow: "0 18px 36px rgba(35,64,53,0.22)",
          }}
        >
          {STRINGS[locale].start}
        </Link>
      </div>

      <p style={{ fontSize: "0.85rem", color: "rgba(35,64,53,0.55)", textAlign: "center" }}>{STRINGS[locale].disclaimer}</p>
    </main>
  );
}
