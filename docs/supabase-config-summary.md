# Supabase é…ç½®æ€»ç»“

## ğŸ“Š é…ç½®çŠ¶æ€æ€»è§ˆ

| ç±»åˆ« | å·²è®¾ç½® | æœªè®¾ç½® | éœ€è¦æ£€æŸ¥ |
|------|--------|--------|----------|
| æ•°æ®åº“è¡¨ | 18 | 0 | 1 (orders åˆå¹¶) |
| å­˜å‚¨æ¡¶ | 2 | 1 | 0 |
| å­˜å‚¨ç­–ç•¥ | 1 | 2 | 0 |
| æ•°æ®åº“å‡½æ•° | 7 | 0 | 0 |
| è§¦å‘å™¨ | 8 | 0 | 0 |
| ç´¢å¼• | å…¨éƒ¨ | 0 | 0 |
| å­—å…¸æ•°æ® | 0 | 3 | 0 |
| RLS ç­–ç•¥ | éƒ¨åˆ† | éƒ¨åˆ† | éœ€è¦è¯„ä¼° |

---

## âœ… ä¸€ã€å·²å®Œæˆçš„é…ç½®

### 1.1 æ•°æ®åº“è¡¨ï¼ˆ18 ä¸ªè¡¨ï¼‰
âœ… `sessions` - ä¼šè¯è¡¨  
âœ… `uploads` - ä¸Šä¼ è®°å½•è¡¨  
âœ… `reports` - æŠ¥å‘Šè¡¨  
âœ… `orders` - è®¢å•è¡¨ï¼ˆâš ï¸ éœ€è¦åˆå¹¶å­—æ®µï¼‰  
âœ… `dict_constitution` - ä½“è´¨å­—å…¸è¡¨ï¼ˆâŒ éœ€è¦å¯¼å…¥æ•°æ®ï¼‰  
âœ… `dict_solar_term` - èŠ‚æ°”å­—å…¸è¡¨ï¼ˆâŒ éœ€è¦å¯¼å…¥æ•°æ®ï¼‰  
âœ… `dream_keywords` - æ¢¦å¢ƒå…³é”®è¯è¡¨ï¼ˆâŒ éœ€è¦å¯¼å…¥æ•°æ®ï¼‰  
âœ… `user_profiles` - ç”¨æˆ·èµ„æ–™è¡¨  
âœ… `affiliate_links` - æ¨èé“¾æ¥è¡¨  
âœ… `wallet_transactions` - é’±åŒ…äº¤æ˜“è¡¨  
âœ… `commission_records` - ä½£é‡‘è®°å½•è¡¨  
âœ… `payout_requests` - æç°è¯·æ±‚è¡¨  
âœ… `assessment_records` - è¯„ä¼°è®°å½•è¡¨  
âœ… `exchange_rates` - æ±‡ç‡è¡¨  
âœ… `palm_prints` - æŒçº¹è®°å½•è¡¨  
âœ… `palm_features` - æŒçº¹ç‰¹å¾è¡¨  
âœ… `palm_upload_logs` - æŒçº¹ä¸Šä¼ æ—¥å¿—è¡¨  
âœ… `report_access` - æŠ¥å‘Šè®¿é—®è¡¨  
âœ… `privacy_consents` - éšç§åŒæ„è¡¨  
âœ… `cleanup_jobs` - æ¸…ç†ä»»åŠ¡è¡¨  
âœ… `app_settings` - åº”ç”¨è®¾ç½®è¡¨  
âœ… `report_email_queue` - æŠ¥å‘Šé‚®ä»¶é˜Ÿåˆ—è¡¨  

### 1.2 å­˜å‚¨æ¡¶ï¼ˆ2/3ï¼‰
âœ… `palmprints` - æŒçº¹å›¾ç‰‡å­˜å‚¨æ¡¶  
âœ… `analysis-temp` - åˆ†æä¸´æ—¶å­˜å‚¨æ¡¶  
âŒ `rules` - è§„åˆ™å¼•æ“å­˜å‚¨æ¡¶ï¼ˆæœªåˆ›å»ºï¼‰

### 1.3 æ•°æ®åº“å‡½æ•°ï¼ˆ7 ä¸ªï¼‰
âœ… `fn_touch_user_profiles()` - æ›´æ–°ç”¨æˆ·èµ„æ–™æ—¶é—´æˆ³  
âœ… `fn_touch_updated_at()` - é€šç”¨æ›´æ–°æ—¶é—´æˆ³  
âœ… `fn_create_user_profile()` - åˆ›å»ºç”¨æˆ·èµ„æ–™  
âœ… `fn_increment_wallet_balance()` - å¢åŠ é’±åŒ…ä½™é¢  
âœ… `fn_adjust_wallet_pending()` - è°ƒæ•´å¾…å¤„ç†é‡‘é¢  
âœ… `touch_orders_updated_at()` - æ›´æ–°è®¢å•æ—¶é—´æˆ³  
âœ… `touch_report_access_updated_at()` - æ›´æ–°æŠ¥å‘Šè®¿é—®æ—¶é—´æˆ³  

### 1.4 è§¦å‘å™¨ï¼ˆ8 ä¸ªï¼‰
âœ… `trg_user_profile_on_users` - ç”¨æˆ·æ³¨å†Œè§¦å‘å™¨  
âœ… `trg_touch_user_profiles` - ç”¨æˆ·èµ„æ–™æ›´æ–°æ—¶é—´æˆ³  
âœ… `trg_touch_orders` - è®¢å•æ›´æ–°æ—¶é—´æˆ³  
âœ… `trg_touch_palm_prints` - æŒçº¹æ›´æ–°æ—¶é—´æˆ³  
âœ… `trg_touch_commission_records` - ä½£é‡‘è®°å½•æ›´æ–°æ—¶é—´æˆ³  
âœ… `trg_touch_assessment_records` - è¯„ä¼°è®°å½•æ›´æ–°æ—¶é—´æˆ³  
âœ… `trg_touch_affiliate_links` - æ¨èé“¾æ¥æ›´æ–°æ—¶é—´æˆ³  
âœ… `trg_touch_report_access` - æŠ¥å‘Šè®¿é—®æ›´æ–°æ—¶é—´æˆ³  

### 1.5 ç´¢å¼•
âœ… æ‰€æœ‰è¡¨çš„ä¸»è¦ç´¢å¼•å·²åˆ›å»º

### 1.6 å­˜å‚¨ç­–ç•¥ï¼ˆ1/3ï¼‰
âœ… `palmprints` æ¡¶ç­–ç•¥å·²é…ç½®  
âŒ `analysis-temp` æ¡¶ç­–ç•¥æœªé…ç½®  
âŒ `rules` æ¡¶ç­–ç•¥æœªé…ç½®  

---

## âŒ äºŒã€æœªå®Œæˆçš„é…ç½®ï¼ˆå¿…é¡»é…ç½®ï¼‰

### ğŸ”´ é«˜ä¼˜å…ˆçº§

#### 1. åˆå¹¶ orders è¡¨å­—æ®µ
- **çŠ¶æ€**: âš ï¸ éœ€è¦åˆå¹¶
- **é—®é¢˜**: ä¸¤ä¸ªè¿ç§»æ–‡ä»¶å®šä¹‰äº†ä¸åŒçš„å­—æ®µ
- **é…ç½®ä½ç½®**: Supabase Dashboard â†’ SQL Editor
- **æ–¹æ³•**: æ‰§è¡Œ `supabase/migrations/20251114_merge_orders_table.sql`
- **ç›®çš„**: ç¡®ä¿è®¢å•è¡¨åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µï¼ˆaffiliateã€subscription ç­‰ï¼‰
- **éªŒæ”¶æ ‡å‡†**: 
  - `orders` è¡¨åŒ…å« `product_id`, `provider_session_id`, `amount` ç­‰å­—æ®µ
  - ç´¢å¼• `idx_orders_provider_session_id` å­˜åœ¨

#### 2. é…ç½® analysis-temp å­˜å‚¨æ¡¶ç­–ç•¥
- **çŠ¶æ€**: âŒ æœªé…ç½®
- **é…ç½®ä½ç½®**: Supabase Dashboard â†’ SQL Editor
- **æ–¹æ³•**: æ‰§è¡Œ `supabase/migrations/20251114_configure_analysis_temp_policies.sql`
- **ç›®çš„**: å…è®¸æœåŠ¡å™¨ç«¯ä¸Šä¼ åˆ†æä¸´æ—¶æ–‡ä»¶
- **éªŒæ”¶æ ‡å‡†**: 
  - ç­–ç•¥ "Service Role Full Access Analysis Temp" å­˜åœ¨
  - Service Role å¯ä»¥ä¸Šä¼ /ä¸‹è½½æ–‡ä»¶

#### 3. å¯¼å…¥å­—å…¸æ•°æ® - dict_constitution
- **çŠ¶æ€**: âŒ æœªå¯¼å…¥
- **é…ç½®ä½ç½®**: Supabase Dashboard â†’ Table Editor â†’ `dict_constitution`
- **æ–¹æ³•**: 
  1. å‡†å¤‡ CSV æ–‡ä»¶æˆ– SQL INSERT è¯­å¥
  2. åœ¨ Table Editor ä¸­ç‚¹å‡» "Insert" æˆ–ä½¿ç”¨ SQL Editor
- **å¿…éœ€å­—æ®µ**: `code`, `name_zh`, `name_en`, `desc_zh`, `desc_en`
- **å¯é€‰å­—æ®µ**: `feature`, `advice_diet`, `advice_activity`, `advice_acupoint`
- **ç¤ºä¾‹æ•°æ®**:
  ```sql
  INSERT INTO public.dict_constitution (code, name_zh, name_en, desc_zh, desc_en)
  VALUES 
    ('qi_deficiency', 'æ°”è™š', 'Qi Deficiency', 'æ°”è™šä½“è´¨æè¿°...', 'Qi deficiency description...'),
    ('yang_deficiency', 'é˜³è™š', 'Yang Deficiency', 'é˜³è™šä½“è´¨æè¿°...', 'Yang deficiency description...');
  ```
- **ç›®çš„**: ä¸ºä½“è´¨åˆ†ææä¾›åŸºç¡€æ•°æ®
- **éªŒæ”¶æ ‡å‡†**: 
  - è¡¨ä¸­è‡³å°‘æœ‰ 9 ç§åŸºæœ¬ä½“è´¨ç±»å‹çš„æ•°æ®
  - å¯ä»¥æŸ¥è¯¢åˆ°ä½“è´¨ä¿¡æ¯

#### 4. å¯¼å…¥å­—å…¸æ•°æ® - dict_solar_term
- **çŠ¶æ€**: âŒ æœªå¯¼å…¥
- **é…ç½®ä½ç½®**: Supabase Dashboard â†’ Table Editor â†’ `dict_solar_term`
- **æ–¹æ³•**: åŒä¸Š
- **å¿…éœ€å­—æ®µ**: `code`, `name_zh`, `name_en`, `do_zh`, `avoid_zh`, `do_en`, `avoid_en`
- **å¯é€‰å­—æ®µ**: `element`, `health_tip`
- **ç¤ºä¾‹æ•°æ®**:
  ```sql
  INSERT INTO public.dict_solar_term (code, name_zh, name_en, do_zh, avoid_zh, do_en, avoid_en)
  VALUES 
    ('spring_equinox', 'æ˜¥åˆ†', 'Spring Equinox', 
     ARRAY['æ—©ç¡æ—©èµ·', 'é€‚åº¦è¿åŠ¨'], 
     ARRAY['ç†¬å¤œ', 'è¿‡åº¦åŠ³ç´¯'], 
     ARRAY['Early sleep', 'Moderate exercise'], 
     ARRAY['Stay up late', 'Overwork']);
  ```
- **ç›®çš„**: ä¸ºèŠ‚æ°”åˆ†ææä¾›åŸºç¡€æ•°æ®
- **éªŒæ”¶æ ‡å‡†**: 
  - è¡¨ä¸­è‡³å°‘æœ‰ 24 ä¸ªèŠ‚æ°”æ•°æ®
  - å¯ä»¥æŸ¥è¯¢åˆ°èŠ‚æ°”ä¿¡æ¯

#### 5. å¯¼å…¥å­—å…¸æ•°æ® - dream_keywords
- **çŠ¶æ€**: âŒ æœªå¯¼å…¥
- **é…ç½®ä½ç½®**: Supabase Dashboard â†’ Table Editor â†’ `dream_keywords`
- **æ–¹æ³•**: åŒä¸Š
- **å¿…éœ€å­—æ®µ**: `keyword`, `locale`
- **å¯é€‰å­—æ®µ**: `category`, `five_element`, `emotion`, `meaning_zh`, `meaning_en`, `health_tip_zh`, `health_tip_en`
- **ç¤ºä¾‹æ•°æ®**:
  ```sql
  INSERT INTO public.dream_keywords (keyword, locale, category, five_element, emotion, meaning_zh, meaning_en)
  VALUES 
    ('æ°´', 'zh', 'nature', 'water', 'calm', 'æ°´çš„å«ä¹‰...', 'Water meaning...'),
    ('ç«', 'zh', 'nature', 'fire', 'passion', 'ç«çš„å«ä¹‰...', 'Fire meaning...');
  ```
- **ç›®çš„**: ä¸ºæ¢¦å¢ƒåˆ†ææä¾›å…³é”®è¯åŒ¹é…æ•°æ®
- **éªŒæ”¶æ ‡å‡†**: 
  - è¡¨ä¸­è‡³å°‘æœ‰å¸¸ç”¨æ¢¦å¢ƒå…³é”®è¯æ•°æ®
  - å¯ä»¥åŒ¹é…åˆ°æ¢¦å¢ƒå…³é”®è¯

---

## âš ï¸ ä¸‰ã€å¯é€‰é…ç½®ï¼ˆå»ºè®®é…ç½®ï¼‰

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

#### 6. åˆ›å»º rules å­˜å‚¨æ¡¶ï¼ˆå¦‚æœä½¿ç”¨è§„åˆ™å¼•æ“å­˜å‚¨ï¼‰
- **çŠ¶æ€**: âŒ æœªåˆ›å»º
- **é…ç½®ä½ç½®**: Supabase Dashboard â†’ Storage â†’ Buckets
- **æ–¹æ³•**: 
  1. è¿›å…¥ Storage â†’ Buckets
  2. ç‚¹å‡» "New bucket"
  3. Name: `rules`, Public: `false`
  4. ç‚¹å‡» "Create bucket"
  5. æ‰§è¡Œ `supabase/migrations/20251114_create_rules_bucket.sql` é…ç½®ç­–ç•¥
- **ç›®çš„**: ç”¨äºå­˜å‚¨å’Œç‰ˆæœ¬ç®¡ç†è§„åˆ™å¼•æ“çš„è§„åˆ™æ–‡ä»¶
- **éªŒæ”¶æ ‡å‡†**: 
  - `rules` å­˜å‚¨æ¡¶å­˜åœ¨
  - ç­–ç•¥å·²é…ç½®
  - å¯ä»¥ä¸Šä¼ è§„åˆ™æ–‡ä»¶

#### 7. é…ç½®è¡¨çº§ RLS ç­–ç•¥
- **çŠ¶æ€**: âš ï¸ éƒ¨åˆ†é…ç½®
- **é…ç½®ä½ç½®**: Supabase Dashboard â†’ Authentication â†’ Policies
- **æ–¹æ³•**: ä¸ºæ¯ä¸ªè¡¨é…ç½®é€‚å½“çš„ RLS ç­–ç•¥
- **éœ€è¦é…ç½®çš„è¡¨**:
  - `user_profiles` - ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„èµ„æ–™
  - `palm_prints` - ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æŒçº¹
  - `reports` - æ ¹æ®è®¿é—®æƒé™æ§åˆ¶
  - `orders` - ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„è®¢å•
  - `wallet_transactions` - ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„äº¤æ˜“
  - `commission_records` - ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„ä½£é‡‘
  - `payout_requests` - ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æç°è¯·æ±‚
- **ç›®çš„**: ç¡®ä¿æ•°æ®å®‰å…¨ï¼Œç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
- **éªŒæ”¶æ ‡å‡†**: 
  - æ¯ä¸ªè¡¨éƒ½æœ‰é€‚å½“çš„ RLS ç­–ç•¥
  - ç”¨æˆ·æ— æ³•è®¿é—®å…¶ä»–ç”¨æˆ·çš„æ•°æ®

---

## ğŸ“ å››ã€å¿«é€Ÿé…ç½®æ­¥éª¤

### æ­¥éª¤ 1: æ‰§è¡Œå¿«é€Ÿé…ç½® SQL
1. ç™»å½• Supabase Dashboard
2. è¿›å…¥ SQL Editor
3. å¤åˆ¶ `docs/supabase-quick-setup-sql.sql` çš„å†…å®¹
4. æ‰§è¡Œ SQL è„šæœ¬
5. æ£€æŸ¥æ‰§è¡Œç»“æœå’Œè­¦å‘Šä¿¡æ¯

### æ­¥éª¤ 2: åˆ›å»º rules å­˜å‚¨æ¡¶ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
1. è¿›å…¥ Storage â†’ Buckets
2. åˆ›å»º `rules` å­˜å‚¨æ¡¶ï¼ˆç§æœ‰ï¼‰
3. éªŒè¯ç­–ç•¥å·²é…ç½®

### æ­¥éª¤ 3: å¯¼å…¥å­—å…¸æ•°æ®
1. å‡†å¤‡å­—å…¸æ•°æ®ï¼ˆCSV æˆ– SQLï¼‰
2. åœ¨ Table Editor ä¸­å¯¼å…¥æˆ–ä½¿ç”¨ SQL Editor æ‰§è¡Œ INSERT
3. éªŒè¯æ•°æ®å·²å¯¼å…¥

### æ­¥éª¤ 4: é…ç½® RLS ç­–ç•¥ï¼ˆå¯é€‰ï¼‰
1. è¿›å…¥ Authentication â†’ Policies
2. ä¸ºæ¯ä¸ªè¡¨é…ç½®é€‚å½“çš„ç­–ç•¥
3. æµ‹è¯•ç­–ç•¥æ˜¯å¦ç”Ÿæ•ˆ

### æ­¥éª¤ 5: éªŒè¯é…ç½®
1. æµ‹è¯•ç”¨æˆ·æ³¨å†Œï¼ˆéªŒè¯ `user_profiles` è‡ªåŠ¨åˆ›å»ºï¼‰
2. æµ‹è¯•å›¾ç‰‡ä¸Šä¼ ï¼ˆéªŒè¯å­˜å‚¨æ¡¶ç­–ç•¥ï¼‰
3. æµ‹è¯•æŠ¥å‘Šç”Ÿæˆï¼ˆéªŒè¯å­—å…¸æ•°æ®ï¼‰
4. æµ‹è¯•æ”¯ä»˜æµç¨‹ï¼ˆéªŒè¯ `orders` è¡¨ï¼‰
5. æµ‹è¯•é’±åŒ…åŠŸèƒ½ï¼ˆéªŒè¯å‡½æ•°å’Œè§¦å‘å™¨ï¼‰

---

## ğŸ¯ äº”ã€éªŒæ”¶æ ‡å‡†

### 5.1 æ•°æ®åº“è¡¨
- [ ] æ‰€æœ‰è¡¨éƒ½å·²åˆ›å»º
- [ ] `orders` è¡¨å­—æ®µå·²åˆå¹¶
- [ ] æ‰€æœ‰ç´¢å¼•éƒ½å·²åˆ›å»º
- [ ] æ‰€æœ‰è§¦å‘å™¨éƒ½å·²åˆ›å»º
- [ ] æ‰€æœ‰å‡½æ•°éƒ½å·²åˆ›å»º

### 5.2 å­˜å‚¨æ¡¶
- [ ] `palmprints` æ¡¶å­˜åœ¨ä¸”ä¸ºç§æœ‰
- [ ] `analysis-temp` æ¡¶å­˜åœ¨ä¸”ä¸ºç§æœ‰
- [ ] `rules` æ¡¶å·²åˆ›å»ºï¼ˆå¦‚æœä½¿ç”¨ï¼‰

### 5.3 å­˜å‚¨ç­–ç•¥
- [ ] `palmprints` æ¡¶ç­–ç•¥å·²é…ç½®
- [ ] `analysis-temp` æ¡¶ç­–ç•¥å·²é…ç½®
- [ ] `rules` æ¡¶ç­–ç•¥å·²é…ç½®ï¼ˆå¦‚æœä½¿ç”¨ï¼‰

### 5.4 å­—å…¸æ•°æ®
- [ ] `dict_constitution` æ•°æ®å·²å¯¼å…¥
- [ ] `dict_solar_term` æ•°æ®å·²å¯¼å…¥
- [ ] `dream_keywords` æ•°æ®å·²å¯¼å…¥

### 5.5 åŠŸèƒ½éªŒè¯
- [ ] ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨åˆ›å»º `user_profiles`
- [ ] é’±åŒ…ä½™é¢æ›´æ–°å‡½æ•°æ­£å¸¸å·¥ä½œ
- [ ] è®¢å•æ—¶é—´æˆ³è‡ªåŠ¨æ›´æ–°
- [ ] æŠ¥å‘Šè®¿é—®æƒé™æ­£å¸¸
- [ ] å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½æ­£å¸¸
- [ ] æ”¯ä»˜æµç¨‹æ­£å¸¸
- [ ] æ¨èåŠŸèƒ½æ­£å¸¸

---

## ğŸ“š å…­ã€ç›¸å…³æ–‡æ¡£

- **å®Œæ•´é…ç½®æ¸…å•**: `docs/supabase-complete-setup-checklist.md`
- **å¿«é€Ÿé…ç½® SQL**: `docs/supabase-quick-setup-sql.sql`
- **åˆå¹¶ orders è¡¨**: `supabase/migrations/20251114_merge_orders_table.sql`
- **åˆ›å»º rules æ¡¶**: `supabase/migrations/20251114_create_rules_bucket.sql`
- **é…ç½®å­˜å‚¨ç­–ç•¥**: `supabase/migrations/20251114_configure_analysis_temp_policies.sql`
- **è§„åˆ™å¼•æ“å­˜å‚¨**: `docs/supabase-rules-storage-setup.sql`

---

## âš¡ ä¸ƒã€ä¸€é”®æ‰§è¡Œï¼ˆæ¨èï¼‰

**æœ€å¿«çš„æ–¹å¼**ï¼šç›´æ¥æ‰§è¡Œ `docs/supabase-quick-setup-sql.sql`ï¼Œç„¶åï¼š
1. åœ¨ Dashboard ä¸­æ‰‹åŠ¨åˆ›å»º `rules` å­˜å‚¨æ¡¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
2. å¯¼å…¥å­—å…¸æ•°æ®
3. é…ç½® RLS ç­–ç•¥ï¼ˆå¯é€‰ï¼‰

**é¢„è®¡æ—¶é—´**ï¼š
- SQL æ‰§è¡Œï¼š1-2 åˆ†é’Ÿ
- åˆ›å»ºå­˜å‚¨æ¡¶ï¼š1 åˆ†é’Ÿ
- å¯¼å…¥å­—å…¸æ•°æ®ï¼š5-10 åˆ†é’Ÿï¼ˆå–å†³äºæ•°æ®é‡ï¼‰
- é…ç½® RLSï¼š10-15 åˆ†é’Ÿï¼ˆå¯é€‰ï¼‰

---

**é…ç½®å®Œæˆåï¼Œä½ çš„ Supabase æ•°æ®åº“åº”è¯¥å¯ä»¥å®Œå…¨æ”¯æŒåº”ç”¨çš„æ‰€æœ‰åŠŸèƒ½ï¼** ğŸ‰

