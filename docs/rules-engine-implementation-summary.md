# è§„åˆ™å¼•æ“å®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. è§„åˆ™æ–‡ä»¶åˆ›å»º

æ‰€æœ‰è§„åˆ™æ–‡ä»¶å·²åˆ›å»ºåœ¨ `src/lib/rules/` ç›®å½•ä¸‹ï¼š

- âœ… `tongue.jsonl` - èˆŒç›¸è§„åˆ™ï¼ˆ16 æ¡è§„åˆ™ï¼‰
- âœ… `palm.jsonl` - æ‰‹ç›¸è§„åˆ™ï¼ˆ24 æ¡è§„åˆ™ï¼‰
- âœ… `dream.jsonl` - æ¢¦å¢ƒè§„åˆ™ï¼ˆ18 æ¡è§„åˆ™ï¼‰
- âœ… `solar.jsonl` - èŠ‚æ°”è§„åˆ™ï¼ˆ24 æ¡è§„åˆ™ï¼‰
- âœ… `global.jsonl` - å…¨å±€å…œåº•è§„åˆ™ï¼ˆ14 æ¡è§„åˆ™ï¼‰

### 2. è§„åˆ™å¼•æ“åŠŸèƒ½

#### âœ… Priority æ’åº
- è§„åˆ™æŒ‰ `priority` é™åºæ’åºï¼ˆæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
- åœ¨ `src/lib/rule-engine.ts` ç¬¬ 84 è¡Œå®ç°

#### âœ… Strategy æ”¯æŒ
- æ”¯æŒ `strategy` å­—æ®µï¼ˆä½œä¸º `merge` çš„åˆ«åï¼‰
- æ”¯æŒ `append`ã€`replace`ã€`skip` ä¸‰ç§ç­–ç•¥
- åœ¨ `src/lib/rule-engine.ts` ç¬¬ 14 è¡Œå’Œç¬¬ 213 è¡Œå®ç°

#### âœ… å­—æ®µåŒ¹é…
- æ”¯æŒé¡¶å±‚å­—æ®µåŒ¹é…ï¼š`tongue_color`ã€`coating`ã€`palm_color`ã€`line_depth`ã€`dream_keywords`ã€`solar_term`
- æ”¯æŒåµŒå¥—å­—æ®µåŒ¹é…ï¼š`palm.lines.life`ã€`tongue.color` ç­‰
- æ”¯æŒæ•°ç»„åŒ¹é…ï¼š`dream_keywords: ["æ‰ç‰™", "è¿½èµ¶"]`
- ä½¿ç”¨ `lodash.get` è¿›è¡Œè·¯å¾„è¡¨è¾¾å¼åŒ¹é…

### 3. è§„åˆ™æ‰§è¡Œé¡ºåº

åœ¨ `src/lib/rules.ts` ä¸­å®ç°äº† `executeRulesSequentially` å‡½æ•°ï¼š

1. **èˆŒç›¸è§„åˆ™** (`tongue.jsonl`) - ç¡®å®šä¸»ä½“è´¨
2. **æ‰‹ç›¸è§„åˆ™** (`palm.jsonl`) - ä¿®æ­£/åŠ æƒä½“è´¨
3. **æ¢¦å¢ƒè§„åˆ™** (`dream.jsonl`) - æä¾›å¿ƒç†å’Œå¥åº·å»ºè®®
4. **èŠ‚æ°”è§„åˆ™** (`solar.jsonl`) - æä¾›å­£èŠ‚æ€§å»ºè®®å’Œ qi_index_delta
5. **å…¨å±€è§„åˆ™** (`global.jsonl`) - å…œåº•è§„åˆ™å’Œ qi_index è®¡ç®—

### 4. å­—æ®µæ‰å¹³åŒ–

åœ¨ `src/lib/rules.ts` çš„ `executeRulesSequentially` å‡½æ•°ä¸­ï¼Œå°†åµŒå¥—å­—æ®µæ‰å¹³åŒ–ä¸ºé¡¶å±‚å­—æ®µï¼š

```typescript
tongue_color: facts.tongue?.color
coating: facts.tongue?.coating
palm_color: facts.palm?.color
line_depth: facts.palm?.line_depth
life_line: facts.palm?.lines?.life
head_line: facts.palm?.lines?.head
emotion_line: facts.palm?.lines?.heart
mount_tags: facts.palm?.mount_tags
dream_keywords: facts.dream?.keywords
solar_term: facts.solar?.code
```

### 5. qi_index è®¡ç®—

åœ¨ `src/lib/analysis/qiIndex.ts` ä¸­å®ç°äº† `computeQiIndexFromRules` å‡½æ•°ï¼š

- **åŸºç¡€åˆ†**ï¼šä» `ruleResult.qi_index_base` è·å–ï¼Œé»˜è®¤ 60
- **Delta æ±‚å’Œ**ï¼šé€’å½’æ”¶é›†æ‰€æœ‰ `qi_index_delta` å¹¶æ±‚å’Œ
- **æœ€ç»ˆè®¡ç®—**ï¼š`qi_index = qi_index_base + æ‰€æœ‰ qi_index_delta çš„å’Œ`
- **é™åˆ¶èŒƒå›´**ï¼šç»“æœé™åˆ¶åœ¨ 0-100 ä¹‹é—´

### 6. æŠ¥å‘Šè¾“å‡º

åœ¨ `src/app/api/analyze/route.ts` ä¸­ï¼ŒæŠ¥å‘ŠåŒ…å«ä»¥ä¸‹å­—æ®µï¼š

- âœ… `constitution` - ä½“è´¨ï¼ˆä»è§„åˆ™ç»“æœä¸­æå–ï¼‰
- âœ… `tags` - æ ‡ç­¾æ•°ç»„ï¼ˆä»è§„åˆ™ç»“æœä¸­æå–ï¼‰
- âœ… `advice` - å»ºè®®å¯¹è±¡ï¼ˆåˆå¹¶è§„åˆ™ç»“æœå’Œä½“è´¨è¯¦æƒ…ï¼‰
- âœ… `dream` - æ¢¦å¢ƒå¯¹è±¡ï¼ˆä¼˜å…ˆä½¿ç”¨è§„åˆ™ç»“æœï¼‰
- âœ… `solar` - èŠ‚æ°”å¯¹è±¡ï¼ˆä»è§„åˆ™ç»“æœä¸­æå–ï¼‰
- âœ… `qi_index` - æ°”è¿æŒ‡æ•°ï¼ˆåŸºäºè§„åˆ™ç»“æœè®¡ç®—ï¼‰
- âœ… `matched_rules` - åŒ¹é…çš„è§„åˆ™ ID åˆ—è¡¨

## ğŸ“‹ è§„åˆ™æ–‡ä»¶æ ¼å¼

æ¯ä¸ªè§„åˆ™æ–‡ä»¶ä½¿ç”¨ JSONL æ ¼å¼ï¼ˆæ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼‰ï¼š

```json
{"id":"rule_id","priority":100,"when":{"field":"value"},"then":{"output":"value"},"strategy":"append"}
```

### å­—æ®µè¯´æ˜

- `id`: è§„åˆ™å”¯ä¸€æ ‡è¯†ç¬¦
- `priority`: ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
- `when`: åŒ¹é…æ¡ä»¶ï¼ˆä½¿ç”¨å­—æ®µè·¯å¾„è¡¨è¾¾å¼ï¼‰
- `then`: è¾“å‡ºç»“æœ
- `strategy`: åˆå¹¶ç­–ç•¥ï¼ˆ`append` | `replace` | `skip`ï¼‰

## ğŸ”„ æ‰§è¡Œæµç¨‹

1. **æ„å»º Facts**ï¼šä»åˆ†æç»“æœæ„å»ºè§„åˆ™äº‹å®
2. **æ‰å¹³åŒ–å­—æ®µ**ï¼šå°†åµŒå¥—å­—æ®µæ‰å¹³åŒ–ä¸ºé¡¶å±‚å­—æ®µ
3. **æŒ‰é¡ºåºæ‰§è¡Œ**ï¼šä¾æ¬¡æ‰§è¡Œ 5 ä¸ªè§„åˆ™æ–‡ä»¶
4. **åˆå¹¶ç»“æœ**ï¼šä½¿ç”¨ `append` ç­–ç•¥åˆå¹¶æ¯ä¸ªæ–‡ä»¶çš„ç»“æœ
5. **è®¡ç®— qi_index**ï¼šä»åˆå¹¶ç»“æœä¸­æå–å¹¶è®¡ç®— qi_index
6. **æ„å»ºæŠ¥å‘Š**ï¼šå°†è§„åˆ™ç»“æœè½¬æ¢ä¸ºæŠ¥å‘Šæ ¼å¼

## âœ… éªŒè¯æ¸…å•

- [x] æ‰€æœ‰è§„åˆ™æ–‡ä»¶å·²åˆ›å»º
- [x] è§„åˆ™å¼•æ“æ”¯æŒ priority æ’åº
- [x] è§„åˆ™å¼•æ“æ”¯æŒ strategy (append/replace)
- [x] è§„åˆ™å¼•æ“æ”¯æŒé¡¶å±‚å­—æ®µåŒ¹é…
- [x] è§„åˆ™å¼•æ“æ”¯æŒæ•°ç»„åŒ¹é…
- [x] æŒ‰é¡ºåºæ‰§è¡Œè§„åˆ™æ–‡ä»¶
- [x] åˆå¹¶è§„åˆ™ç»“æœ
- [x] è®¡ç®— qi_index
- [x] è¾“å‡ºå®Œæ•´çš„ Report å¯¹è±¡

## ğŸ¯ ä¸‹ä¸€æ­¥

è§„åˆ™å¼•æ“å·²å®Œå…¨å®ç°ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•ï¼š

1. æµ‹è¯•èˆŒç›¸è§„åˆ™åŒ¹é…
2. æµ‹è¯•æ‰‹ç›¸è§„åˆ™åŒ¹é…
3. æµ‹è¯•æ¢¦å¢ƒè§„åˆ™åŒ¹é…
4. æµ‹è¯•èŠ‚æ°”è§„åˆ™åŒ¹é…
5. æµ‹è¯• qi_index è®¡ç®—
6. æµ‹è¯•æŠ¥å‘Šè¾“å‡ºæ ¼å¼

